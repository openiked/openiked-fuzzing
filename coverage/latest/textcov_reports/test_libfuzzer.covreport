freezero:
   25|      1|{
   26|       |	/* This is legal. */
   27|      1|	if (ptr == NULL)
  ------------------
  |  Branch (27:6): [True: 0, False: 1]
  ------------------
   28|      0|		return;
   29|       |
   30|      1|	explicit_bzero(ptr, sz);
   31|      1|	free(ptr);
   32|      1|}

ibuf_open:
   39|  2.80k|{
   40|  2.80k|	struct ibuf	*buf;
   41|       |
   42|  2.80k|	if ((buf = calloc(1, sizeof(struct ibuf))) == NULL)
  ------------------
  |  Branch (42:6): [True: 0, False: 2.80k]
  ------------------
   43|      0|		return (NULL);
   44|  2.80k|	if ((buf->buf = malloc(len)) == NULL) {
  ------------------
  |  Branch (44:6): [True: 0, False: 2.80k]
  ------------------
   45|      0|		free(buf);
   46|      0|		return (NULL);
   47|      0|	}
   48|  2.80k|	buf->size = buf->max = len;
   49|  2.80k|	buf->fd = -1;
   50|       |
   51|  2.80k|	return (buf);
   52|  2.80k|}
ibuf_dynamic:
   56|  2.80k|{
   57|  2.80k|	struct ibuf	*buf;
   58|       |
   59|  2.80k|	if (max < len)
  ------------------
  |  Branch (59:6): [True: 0, False: 2.80k]
  ------------------
   60|      0|		return (NULL);
   61|       |
   62|  2.80k|	if ((buf = ibuf_open(len)) == NULL)
  ------------------
  |  Branch (62:6): [True: 0, False: 2.80k]
  ------------------
   63|      0|		return (NULL);
   64|       |
   65|  2.80k|	if (max > 0)
  ------------------
  |  Branch (65:6): [True: 2.80k, False: 0]
  ------------------
   66|  2.80k|		buf->max = max;
   67|       |
   68|  2.80k|	return (buf);
   69|  2.80k|}
ibuf_add:
   93|  2.80k|{
   94|  2.80k|	if (buf->wpos + len > buf->size)
  ------------------
  |  Branch (94:6): [True: 0, False: 2.80k]
  ------------------
   95|      0|		if (ibuf_realloc(buf, len) == -1)
  ------------------
  |  Branch (95:7): [True: 0, False: 0]
  ------------------
   96|      0|			return (-1);
   97|       |
   98|  2.80k|	memcpy(buf->buf + buf->wpos, data, len);
   99|  2.80k|	buf->wpos += len;
  100|  2.80k|	return (0);
  101|  2.80k|}
ibuf_seek:
  119|   293k|{
  120|       |	/* only allowed to seek in already written parts */
  121|   293k|	if (pos + len > buf->wpos)
  ------------------
  |  Branch (121:6): [True: 2.54k, False: 291k]
  ------------------
  122|  2.54k|		return (NULL);
  123|       |
  124|   291k|	return (buf->buf + pos);
  125|   293k|}
ibuf_size:
  129|  1.62k|{
  130|  1.62k|	return (buf->wpos);
  131|  1.62k|}
ibuf_free:
  218|      1|{
  219|      1|	if (buf == NULL)
  ------------------
  |  Branch (219:6): [True: 0, False: 1]
  ------------------
  220|      0|		return;
  221|      1|	freezero(buf->buf, buf->size);
  222|      1|	free(buf);
  223|      1|}

strlcpy:
   29|   186k|{
   30|   186k|	const char *osrc = src;
   31|   186k|	size_t nleft = dsize;
   32|       |
   33|       |	/* Copy as many bytes as will fit. */
   34|   186k|	if (nleft != 0) {
  ------------------
  |  Branch (34:6): [True: 186k, False: 0]
  ------------------
   35|   992k|		while (--nleft != 0) {
  ------------------
  |  Branch (35:10): [True: 992k, False: 50]
  ------------------
   36|   992k|			if ((*dst++ = *src++) == '\0')
  ------------------
  |  Branch (36:8): [True: 186k, False: 806k]
  ------------------
   37|   186k|				break;
   38|   992k|		}
   39|   186k|	}
   40|       |
   41|       |	/* Not enough room in dst, add NUL and traverse rest of src. */
   42|   186k|	if (nleft == 0) {
  ------------------
  |  Branch (42:6): [True: 50, False: 186k]
  ------------------
   43|     50|		if (dsize != 0)
  ------------------
  |  Branch (43:7): [True: 50, False: 0]
  ------------------
   44|     50|			*dst = '\0';		/* NUL-terminate dst */
   45|     50|		while (*src++)
  ------------------
  |  Branch (45:10): [True: 0, False: 50]
  ------------------
   46|      0|			;
   47|     50|	}
   48|       |
   49|   186k|	return(src - osrc - 1);	/* count does not include NUL */
   50|   186k|}

ikev2_pld_parse:
  117|  1.62k|{
  118|  1.62k|	log_debug("%s: header ispi %s rspi %s"
  119|  1.62k|	    " nextpayload %s version 0x%02x exchange %s flags 0x%02x"
  120|  1.62k|	    " msgid %d length %u response %d", __func__,
  121|  1.62k|	    print_spi(betoh64(hdr->ike_ispi), 8),
  ------------------
  |  |   46|  1.62k|#define betoh64	be64toh
  ------------------
  122|  1.62k|	    print_spi(betoh64(hdr->ike_rspi), 8),
  ------------------
  |  |   46|  1.62k|#define betoh64	be64toh
  ------------------
  123|  1.62k|	    print_map(hdr->ike_nextpayload, ikev2_payload_map),
  124|  1.62k|	    hdr->ike_version,
  125|  1.62k|	    print_map(hdr->ike_exchange, ikev2_exchange_map),
  126|  1.62k|	    hdr->ike_flags,
  127|  1.62k|	    betoh32(hdr->ike_msgid),
  ------------------
  |  |   43|  1.62k|#define betoh32	be32toh
  ------------------
  128|  1.62k|	    betoh32(hdr->ike_length),
  ------------------
  |  |   43|  1.62k|#define betoh32	be32toh
  ------------------
  129|  1.62k|	    msg->msg_response);
  130|       |
  131|  1.62k|	if (ibuf_size(msg->msg_data) < betoh32(hdr->ike_length)) {
  ------------------
  |  |   43|  1.62k|#define betoh32	be32toh
  ------------------
  |  Branch (131:6): [True: 6, False: 1.61k]
  ------------------
  132|      6|		log_debug("%s: short message", __func__);
  133|      6|		return (-1);
  134|      6|	}
  135|       |
  136|  1.61k|	offset += sizeof(*hdr);
  137|       |
  138|  1.61k|	return (ikev2_pld_payloads(env, msg, offset,
  139|  1.61k|	    betoh32(hdr->ike_length), hdr->ike_nextpayload));
  ------------------
  |  |   43|  1.61k|#define betoh32	be32toh
  ------------------
  140|  1.62k|}
ikev2_validate_pld:
  145|  90.1k|{
  146|  90.1k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
  147|  90.1k|	size_t		 pld_length;
  148|       |
  149|       |	/* We need at least the generic header. */
  150|  90.1k|	if (left < sizeof(*pld)) {
  ------------------
  |  Branch (150:6): [True: 223, False: 89.8k]
  ------------------
  151|    223|		log_debug("%s: malformed payload: too short for generic "
  152|    223|		    "header (%zu < %zu)", __func__, left, sizeof(*pld));
  153|    223|		return (-1);
  154|    223|	}
  155|  89.8k|	memcpy(pld, msgbuf + offset, sizeof(*pld));
  156|       |
  157|       |	/*
  158|       |	 * We need at least the specified number of bytes.
  159|       |	 * pld_length is the full size of the payload including
  160|       |	 * the generic payload header.
  161|       |	 */
  162|  89.8k|	pld_length = betoh16(pld->pld_length);
  ------------------
  |  |   40|  89.8k|#define betoh16	be16toh
  ------------------
  163|  89.8k|	if (left < pld_length) {
  ------------------
  |  Branch (163:6): [True: 607, False: 89.2k]
  ------------------
  164|    607|		log_debug("%s: malformed payload: shorter than specified "
  165|    607|		    "(%zu < %zu)", __func__, left, pld_length);
  166|    607|		return (-1);
  167|    607|	}
  168|       |	/*
  169|       |	 * Sanity check the specified payload size, it must
  170|       |	 * be at least the size of the generic payload header.
  171|       |	 */
  172|  89.2k|	if (pld_length < sizeof(*pld)) {
  ------------------
  |  Branch (172:6): [True: 171, False: 89.1k]
  ------------------
  173|    171|		log_debug("%s: malformed payload: shorter than minimum "
  174|    171|		    "header size (%zu < %zu)", __func__, pld_length,
  175|    171|		    sizeof(*pld));
  176|    171|		return (-1);
  177|    171|	}
  178|       |
  179|  89.1k|	return (0);
  180|  89.2k|}
ikev2_pld_payloads:
  185|  1.61k|{
  186|  1.61k|	struct ikev2_payload	 pld;
  187|  1.61k|	unsigned int		 e;
  188|  1.61k|	int			 ret;
  189|  1.61k|	uint8_t			*msgbuf = ibuf_data(msg->msg_data);
  190|  1.61k|	size_t			 total, left;
  191|       |
  192|       |	/* Check if message was decrypted in an E payload */
  193|  1.61k|	e = msg->msg_e ? IKED_E : 0;
  ------------------
  |  |   74|  1.61k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (193:6): [True: 1.61k, False: 0]
  ------------------
  194|       |
  195|       |	/* Bytes left in datagram. */
  196|  1.61k|	total = length - offset;
  197|       |
  198|  90.7k|	while (payload != 0 && offset < length) {
  ------------------
  |  Branch (198:9): [True: 90.5k, False: 201]
  |  Branch (198:25): [True: 90.1k, False: 413]
  ------------------
  199|  90.1k|		if (ikev2_validate_pld(msg, offset, total, &pld))
  ------------------
  |  Branch (199:7): [True: 1.00k, False: 89.1k]
  ------------------
  200|  1.00k|			return (-1);
  201|       |
  202|  89.1k|		log_debug("%s: %spayload %s"
  203|  89.1k|		    " nextpayload %s critical 0x%02x length %d",
  204|  89.1k|		    __func__, e ? "decrypted " : "",
  ------------------
  |  Branch (204:17): [True: 89.1k, False: 0]
  ------------------
  205|  89.1k|		    print_map(payload, ikev2_payload_map),
  206|  89.1k|		    print_map(pld.pld_nextpayload, ikev2_payload_map),
  207|  89.1k|		    pld.pld_reserved & IKEV2_CRITICAL_PAYLOAD,
  ------------------
  |  |   89|  89.1k|#define IKEV2_CRITICAL_PAYLOAD	0x01	/* First bit in the reserved field */
  ------------------
  208|  89.1k|		    betoh16(pld.pld_length));
  ------------------
  |  |   40|  89.1k|#define betoh16	be16toh
  ------------------
  209|       |
  210|       |		/* Skip over generic payload header. */
  211|  89.1k|		offset += sizeof(pld);
  212|  89.1k|		total -= sizeof(pld);
  213|  89.1k|		left = betoh16(pld.pld_length) - sizeof(pld);
  ------------------
  |  |   40|  89.1k|#define betoh16	be16toh
  ------------------
  214|  89.1k|		ret = 0;
  215|       |
  216|  89.1k|		switch (payload | e) {
  217|      0|		case IKEV2_PAYLOAD_SA:
  ------------------
  |  |   93|      0|#define IKEV2_PAYLOAD_SA	33	/* Security Association */
  ------------------
  |  Branch (217:3): [True: 0, False: 89.1k]
  ------------------
  218|  16.1k|		case IKEV2_PAYLOAD_SA | IKED_E:
  ------------------
  |  |   93|  16.1k|#define IKEV2_PAYLOAD_SA	33	/* Security Association */
  ------------------
              		case IKEV2_PAYLOAD_SA | IKED_E:
  ------------------
  |  |   74|  16.1k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (218:3): [True: 16.1k, False: 72.9k]
  ------------------
  219|  16.1k|			ret = ikev2_pld_sa(env, &pld, msg, offset, left);
  220|  16.1k|			break;
  221|      0|		case IKEV2_PAYLOAD_KE:
  ------------------
  |  |   94|      0|#define IKEV2_PAYLOAD_KE	34	/* Key Exchange */
  ------------------
  |  Branch (221:3): [True: 0, False: 89.1k]
  ------------------
  222|  2.01k|		case IKEV2_PAYLOAD_KE | IKED_E:
  ------------------
  |  |   94|  2.01k|#define IKEV2_PAYLOAD_KE	34	/* Key Exchange */
  ------------------
              		case IKEV2_PAYLOAD_KE | IKED_E:
  ------------------
  |  |   74|  2.01k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (222:3): [True: 2.01k, False: 87.1k]
  ------------------
  223|  2.01k|			ret = ikev2_pld_ke(env, &pld, msg, offset, left);
  224|  2.01k|			break;
  225|  3.26k|		case IKEV2_PAYLOAD_IDi | IKED_E:
  ------------------
  |  |   95|  3.26k|#define IKEV2_PAYLOAD_IDi	35	/* Identification - Initiator */
  ------------------
              		case IKEV2_PAYLOAD_IDi | IKED_E:
  ------------------
  |  |   74|  3.26k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (225:3): [True: 3.26k, False: 85.8k]
  ------------------
  226|  3.57k|		case IKEV2_PAYLOAD_IDr | IKED_E:
  ------------------
  |  |   96|  3.57k|#define IKEV2_PAYLOAD_IDr	36	/* Identification - Responder */
  ------------------
              		case IKEV2_PAYLOAD_IDr | IKED_E:
  ------------------
  |  |   74|  3.57k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (226:3): [True: 306, False: 88.8k]
  ------------------
  227|  3.57k|			ret = ikev2_pld_id(env, &pld, msg, offset, left,
  228|  3.57k|			    payload);
  229|  3.57k|			break;
  230|    898|		case IKEV2_PAYLOAD_CERT | IKED_E:
  ------------------
  |  |   97|    898|#define IKEV2_PAYLOAD_CERT	37	/* Certificate */
  ------------------
              		case IKEV2_PAYLOAD_CERT | IKED_E:
  ------------------
  |  |   74|    898|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (230:3): [True: 898, False: 88.2k]
  ------------------
  231|    898|			ret = ikev2_pld_cert(env, &pld, msg, offset, left);
  232|    898|			break;
  233|      0|		case IKEV2_PAYLOAD_CERTREQ:
  ------------------
  |  |   98|      0|#define IKEV2_PAYLOAD_CERTREQ	38	/* Certificate Request */
  ------------------
  |  Branch (233:3): [True: 0, False: 89.1k]
  ------------------
  234|  10.2k|		case IKEV2_PAYLOAD_CERTREQ | IKED_E:
  ------------------
  |  |   98|  10.2k|#define IKEV2_PAYLOAD_CERTREQ	38	/* Certificate Request */
  ------------------
              		case IKEV2_PAYLOAD_CERTREQ | IKED_E:
  ------------------
  |  |   74|  10.2k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (234:3): [True: 10.2k, False: 78.8k]
  ------------------
  235|  10.2k|			ret = ikev2_pld_certreq(env, &pld, msg, offset, left);
  236|  10.2k|			break;
  237|  2.29k|		case IKEV2_PAYLOAD_AUTH | IKED_E:
  ------------------
  |  |   99|  2.29k|#define IKEV2_PAYLOAD_AUTH	39	/* Authentication */
  ------------------
              		case IKEV2_PAYLOAD_AUTH | IKED_E:
  ------------------
  |  |   74|  2.29k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (237:3): [True: 2.29k, False: 86.8k]
  ------------------
  238|  2.29k|			ret = ikev2_pld_auth(env, &pld, msg, offset, left);
  239|  2.29k|			break;
  240|      0|		case IKEV2_PAYLOAD_NONCE:
  ------------------
  |  |  100|      0|#define IKEV2_PAYLOAD_NONCE	40	/* Nonce */
  ------------------
  |  Branch (240:3): [True: 0, False: 89.1k]
  ------------------
  241|    203|		case IKEV2_PAYLOAD_NONCE | IKED_E:
  ------------------
  |  |  100|    203|#define IKEV2_PAYLOAD_NONCE	40	/* Nonce */
  ------------------
              		case IKEV2_PAYLOAD_NONCE | IKED_E:
  ------------------
  |  |   74|    203|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (241:3): [True: 203, False: 88.9k]
  ------------------
  242|    203|			ret = ikev2_pld_nonce(env, &pld, msg, offset, left);
  243|    203|			break;
  244|      0|		case IKEV2_PAYLOAD_NOTIFY:
  ------------------
  |  |  101|      0|#define IKEV2_PAYLOAD_NOTIFY	41	/* Notify */
  ------------------
  |  Branch (244:3): [True: 0, False: 89.1k]
  ------------------
  245|  4.44k|		case IKEV2_PAYLOAD_NOTIFY | IKED_E:
  ------------------
  |  |  101|  4.44k|#define IKEV2_PAYLOAD_NOTIFY	41	/* Notify */
  ------------------
              		case IKEV2_PAYLOAD_NOTIFY | IKED_E:
  ------------------
  |  |   74|  4.44k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (245:3): [True: 4.44k, False: 84.6k]
  ------------------
  246|  4.44k|			ret = ikev2_pld_notify(env, &pld, msg, offset, left);
  247|  4.44k|			break;
  248|  2.24k|		case IKEV2_PAYLOAD_DELETE | IKED_E:
  ------------------
  |  |  102|  2.24k|#define IKEV2_PAYLOAD_DELETE	42	/* Delete */
  ------------------
              		case IKEV2_PAYLOAD_DELETE | IKED_E:
  ------------------
  |  |   74|  2.24k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (248:3): [True: 2.24k, False: 86.8k]
  ------------------
  249|  2.24k|			ret = ikev2_pld_delete(env, &pld, msg, offset, left);
  250|  2.24k|			break;
  251|  2.16k|		case IKEV2_PAYLOAD_TSi | IKED_E:
  ------------------
  |  |  104|  2.16k|#define IKEV2_PAYLOAD_TSi	44	/* Traffic Selector - Initiator */
  ------------------
              		case IKEV2_PAYLOAD_TSi | IKED_E:
  ------------------
  |  |   74|  2.16k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (251:3): [True: 2.16k, False: 86.9k]
  ------------------
  252|  6.58k|		case IKEV2_PAYLOAD_TSr | IKED_E:
  ------------------
  |  |  105|  6.58k|#define IKEV2_PAYLOAD_TSr	45	/* Traffic Selector - Responder */
  ------------------
              		case IKEV2_PAYLOAD_TSr | IKED_E:
  ------------------
  |  |   74|  6.58k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (252:3): [True: 4.41k, False: 84.7k]
  ------------------
  253|  6.58k|			ret = ikev2_pld_tss(env, &pld, msg, offset, left);
  254|  6.58k|			break;
  255|      0|		case IKEV2_PAYLOAD_SK:
  ------------------
  |  |  106|      0|#define IKEV2_PAYLOAD_SK	46	/* Encrypted */
  ------------------
  |  Branch (255:3): [True: 0, False: 89.1k]
  ------------------
  256|      0|			ret = ikev2_pld_e(env, &pld, msg, offset, left);
  257|      0|			break;
  258|      0|		case IKEV2_PAYLOAD_SKF:
  ------------------
  |  |  110|      0|#define IKEV2_PAYLOAD_SKF	53	/* RFC7383 Encrypted Fragment Payload */
  ------------------
  |  Branch (258:3): [True: 0, False: 89.1k]
  ------------------
  259|      0|			ret = ikev2_pld_ef(env, &pld, msg, offset, left);
  260|      0|			break;
  261|  7.04k|		case IKEV2_PAYLOAD_CP | IKED_E:
  ------------------
  |  |  107|  7.04k|#define IKEV2_PAYLOAD_CP	47	/* Configuration Payload */
  ------------------
              		case IKEV2_PAYLOAD_CP | IKED_E:
  ------------------
  |  |   74|  7.04k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (261:3): [True: 7.04k, False: 82.0k]
  ------------------
  262|  7.04k|			ret = ikev2_pld_cp(env, &pld, msg, offset, left);
  263|  7.04k|			break;
  264|  16.7k|		case IKEV2_PAYLOAD_EAP | IKED_E:
  ------------------
  |  |  108|  16.7k|#define IKEV2_PAYLOAD_EAP	48	/* Extensible Authentication */
  ------------------
              		case IKEV2_PAYLOAD_EAP | IKED_E:
  ------------------
  |  |   74|  16.7k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (264:3): [True: 16.7k, False: 72.3k]
  ------------------
  265|  16.7k|			ret = ikev2_pld_eap(env, &pld, msg, offset, left);
  266|  16.7k|			break;
  267|  16.6k|		default:
  ------------------
  |  Branch (267:3): [True: 16.6k, False: 72.4k]
  ------------------
  268|  16.6k|			print_hex(msgbuf, offset,
  269|  16.6k|			    betoh16(pld.pld_length) - sizeof(pld));
  ------------------
  |  |   40|  16.6k|#define betoh16	be16toh
  ------------------
  270|  16.6k|			break;
  271|  89.1k|		}
  272|       |
  273|  89.1k|		if (ret != 0 && ikev2_msg_frompeer(msg)) {
  ------------------
  |  Branch (273:7): [True: 44.2k, False: 44.8k]
  |  Branch (273:19): [True: 0, False: 44.2k]
  ------------------
  274|      0|			(void)ikev2_send_informational(env, msg);
  275|      0|			return (-1);
  276|      0|		}
  277|       |
  278|       |		/* Encrypted payloads must appear last */
  279|  89.1k|		if ((payload == IKEV2_PAYLOAD_SK) ||
  ------------------
  |  |  106|  89.1k|#define IKEV2_PAYLOAD_SK	46	/* Encrypted */
  ------------------
  |  Branch (279:7): [True: 1, False: 89.1k]
  ------------------
  280|  89.1k|		    (payload == IKEV2_PAYLOAD_SKF))
  ------------------
  |  |  110|  89.1k|#define IKEV2_PAYLOAD_SKF	53	/* RFC7383 Encrypted Fragment Payload */
  ------------------
  |  Branch (280:7): [True: 1, False: 89.1k]
  ------------------
  281|      2|			return (0);
  282|       |
  283|  89.1k|		payload = pld.pld_nextpayload;
  284|  89.1k|		offset += left;
  285|  89.1k|		total -= left;
  286|  89.1k|	}
  287|       |
  288|    614|	return (0);
  289|  1.61k|}
ikev2_validate_sa:
  294|  18.8k|{
  295|  18.8k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
  296|  18.8k|	size_t		 sap_length;
  297|       |
  298|  18.8k|	if (left < sizeof(*sap)) {
  ------------------
  |  Branch (298:6): [True: 7.56k, False: 11.3k]
  ------------------
  299|  7.56k|		log_debug("%s: malformed payload: too short for header "
  300|  7.56k|		    "(%zu < %zu)", __func__, left, sizeof(*sap));
  301|  7.56k|		return (-1);
  302|  7.56k|	}
  303|  11.3k|	memcpy(sap, msgbuf + offset, sizeof(*sap));
  304|       |
  305|  11.3k|	sap_length = betoh16(sap->sap_length);
  ------------------
  |  |   40|  11.3k|#define betoh16	be16toh
  ------------------
  306|  11.3k|	if (sap_length < sizeof(*sap)) {
  ------------------
  |  Branch (306:6): [True: 2.01k, False: 9.29k]
  ------------------
  307|  2.01k|		log_debug("%s: malformed payload: shorter than minimum header "
  308|  2.01k|		    "size (%zu < %zu)", __func__, sap_length, sizeof(*sap));
  309|  2.01k|		return (-1);
  310|  2.01k|	}
  311|  9.29k|	if (left < sap_length) {
  ------------------
  |  Branch (311:6): [True: 1.33k, False: 7.95k]
  ------------------
  312|  1.33k|		log_debug("%s: malformed payload: too long for actual payload "
  313|  1.33k|		    "size (%zu < %zu)", __func__, left, sap_length);
  314|  1.33k|		return (-1);
  315|  1.33k|	}
  316|       |	/*
  317|       |	 * If there is only one proposal, sap_length must be the
  318|       |	 * total payload size.
  319|       |	 */
  320|  7.95k|	if (!sap->sap_more && left != sap_length) {
  ------------------
  |  Branch (320:6): [True: 684, False: 7.27k]
  |  Branch (320:24): [True: 16, False: 668]
  ------------------
  321|     16|		log_debug("%s: malformed payload: SA payload length mismatches "
  322|     16|		    "single proposal substructure length (%lu != %zu)",
  323|     16|		    __func__, left, sap_length);
  324|     16|		return (-1);
  325|     16|	}
  326|       |	/*
  327|       |	 * If there are more than one proposal, there must be bytes
  328|       |	 * left in the payload.
  329|       |	 */
  330|  7.93k|	if (sap->sap_more && left <= sap_length) {
  ------------------
  |  Branch (330:6): [True: 7.27k, False: 668]
  |  Branch (330:23): [True: 92, False: 7.17k]
  ------------------
  331|     92|		log_debug("%s: malformed payload: SA payload too small for "
  332|     92|		    "further proposals (%zu <= %zu)", __func__,
  333|     92|		    left, sap_length);
  334|     92|		return (-1);
  335|     92|	}
  336|  7.84k|	return (0);
  337|  7.93k|}
ikev2_pld_sa:
  342|  16.1k|{
  343|  16.1k|	struct ikev2_sa_proposal	 sap;
  344|  16.1k|	struct iked_proposal		*prop = NULL;
  345|  16.1k|	uint32_t			 spi32;
  346|  16.1k|	uint64_t			 spi = 0, spi64;
  347|  16.1k|	uint8_t				*msgbuf = ibuf_data(msg->msg_data);
  348|  16.1k|	int				 r;
  349|  16.1k|	struct iked_proposals		*props;
  350|  16.1k|	size_t				 total;
  351|       |
  352|  18.8k|	do {
  353|  18.8k|		if (ikev2_validate_sa(msg, offset, left, &sap))
  ------------------
  |  Branch (353:7): [True: 11.0k, False: 7.84k]
  ------------------
  354|  11.0k|			return (-1);
  355|       |
  356|       |		/* Assumed size of the first proposals, including SPI if present. */
  357|  7.84k|		total = (betoh16(sap.sap_length) - sizeof(sap));
  ------------------
  |  |   40|  7.84k|#define betoh16	be16toh
  ------------------
  358|       |
  359|  7.84k|		props = &msg->msg_parent->msg_proposals;
  360|       |
  361|  7.84k|		offset += sizeof(sap);
  362|  7.84k|		left -= sizeof(sap);
  363|       |
  364|  7.84k|		if (sap.sap_spisize) {
  ------------------
  |  Branch (364:7): [True: 525, False: 7.32k]
  ------------------
  365|    525|			if (left < sap.sap_spisize) {
  ------------------
  |  Branch (365:8): [True: 72, False: 453]
  ------------------
  366|     72|				log_debug("%s: malformed payload: SPI larger than "
  367|     72|				    "actual payload (%zu < %d)", __func__, left,
  368|     72|				    sap.sap_spisize);
  369|     72|				return (-1);
  370|     72|			}
  371|    453|			if (total < sap.sap_spisize) {
  ------------------
  |  Branch (371:8): [True: 117, False: 336]
  ------------------
  372|    117|				log_debug("%s: malformed payload: SPI larger than "
  373|    117|				    "proposal (%zu < %d)", __func__, total,
  374|    117|				    sap.sap_spisize);
  375|    117|				return (-1);
  376|    117|			}
  377|    336|			switch (sap.sap_spisize) {
  378|    113|			case 4:
  ------------------
  |  Branch (378:4): [True: 113, False: 223]
  ------------------
  379|    113|				memcpy(&spi32, msgbuf + offset, 4);
  380|    113|				spi = betoh32(spi32);
  ------------------
  |  |   43|    113|#define betoh32	be32toh
  ------------------
  381|    113|				break;
  382|    124|			case 8:
  ------------------
  |  Branch (382:4): [True: 124, False: 212]
  ------------------
  383|    124|				memcpy(&spi64, msgbuf + offset, 8);
  384|    124|				spi = betoh64(spi64);
  ------------------
  |  |   46|    124|#define betoh64	be64toh
  ------------------
  385|    124|				break;
  386|     99|			default:
  ------------------
  |  Branch (386:4): [True: 99, False: 237]
  ------------------
  387|     99|				log_debug("%s: unsupported SPI size %d",
  388|     99|				    __func__, sap.sap_spisize);
  389|     99|				return (-1);
  390|    336|			}
  391|       |
  392|    237|			offset += sap.sap_spisize;
  393|    237|			left -= sap.sap_spisize;
  394|       |
  395|       |			/* Assumed size of the proposal, now without SPI. */
  396|    237|			total -= sap.sap_spisize;
  397|    237|		}
  398|       |
  399|       |		/*
  400|       |		 * As we verified sanity of packet headers, this check will
  401|       |		 * be always false, but just to be sure we keep it.
  402|       |		 */
  403|  7.55k|		if (left < total) {
  ------------------
  |  Branch (403:7): [True: 0, False: 7.55k]
  ------------------
  404|      0|			log_debug("%s: malformed payload: too long for payload "
  405|      0|			    "(%zu < %zu)", __func__, left, total);
  406|      0|			return (-1);
  407|      0|		}
  408|       |
  409|  7.55k|		log_debug("%s: more %d reserved %d length %d"
  410|  7.55k|		    " proposal #%d protoid %s spisize %d xforms %d spi %s",
  411|  7.55k|		    __func__, sap.sap_more, sap.sap_reserved,
  412|  7.55k|		    betoh16(sap.sap_length), sap.sap_proposalnr,
  ------------------
  |  |   40|  7.55k|#define betoh16	be16toh
  ------------------
  413|  7.55k|		    print_map(sap.sap_protoid, ikev2_saproto_map), sap.sap_spisize,
  414|  7.55k|		    sap.sap_transforms, print_spi(spi, sap.sap_spisize));
  415|       |
  416|  7.55k|		if (ikev2_msg_frompeer(msg)) {
  ------------------
  |  Branch (416:7): [True: 0, False: 7.55k]
  ------------------
  417|      0|			if ((msg->msg_parent->msg_prop = config_add_proposal(props,
  ------------------
  |  Branch (417:8): [True: 0, False: 0]
  ------------------
  418|      0|			    sap.sap_proposalnr, sap.sap_protoid)) == NULL) {
  419|      0|				log_debug("%s: invalid proposal", __func__);
  420|      0|				return (-1);
  421|      0|			}
  422|      0|			prop = msg->msg_parent->msg_prop;
  423|      0|			prop->prop_peerspi.spi = spi;
  424|      0|			prop->prop_peerspi.spi_protoid = sap.sap_protoid;
  425|      0|			prop->prop_peerspi.spi_size = sap.sap_spisize;
  426|       |
  427|      0|			prop->prop_localspi.spi_protoid = sap.sap_protoid;
  428|      0|			prop->prop_localspi.spi_size = sap.sap_spisize;
  429|      0|		}
  430|       |
  431|       |		/*
  432|       |		 * Parse the attached transforms
  433|       |		 */
  434|  7.55k|		if (sap.sap_transforms) {
  ------------------
  |  Branch (434:7): [True: 5.18k, False: 2.37k]
  ------------------
  435|  5.18k|			r = ikev2_pld_xform(env, msg, offset, total);
  436|  5.18k|			if ((r == -2) && ikev2_msg_frompeer(msg)) {
  ------------------
  |  Branch (436:8): [True: 0, False: 5.18k]
  |  Branch (436:21): [True: 0, False: 0]
  ------------------
  437|      0|				log_debug("%s: invalid proposal transform",
  438|      0|				    __func__);
  439|       |
  440|       |				/* cleanup and ignore proposal */
  441|      0|				config_free_proposal(props, prop);
  442|      0|				prop = msg->msg_parent->msg_prop = NULL;
  443|  5.18k|			} else if (r != 0) {
  ------------------
  |  Branch (443:15): [True: 4.37k, False: 803]
  ------------------
  444|  4.37k|				log_debug("%s: invalid proposal transforms",
  445|  4.37k|				    __func__);
  446|  4.37k|				return (-1);
  447|  4.37k|			}
  448|  5.18k|		}
  449|       |
  450|  3.18k|		offset += total;
  451|  3.18k|		left -= total;
  452|  3.18k|	} while (sap.sap_more);
  ------------------
  |  Branch (452:11): [True: 2.70k, False: 477]
  ------------------
  453|       |
  454|    477|	return (0);
  455|  16.1k|}
ikev2_validate_xform:
  460|  7.13k|{
  461|  7.13k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
  462|  7.13k|	size_t		 xfrm_length;
  463|       |
  464|  7.13k|	if (total < sizeof(*xfrm)) {
  ------------------
  |  Branch (464:6): [True: 411, False: 6.72k]
  ------------------
  465|    411|		log_debug("%s: malformed payload: too short for header "
  466|    411|		    "(%zu < %zu)", __func__, total, sizeof(*xfrm));
  467|    411|		return (-1);
  468|    411|	}
  469|  6.72k|	memcpy(xfrm, msgbuf + offset, sizeof(*xfrm));
  470|       |
  471|  6.72k|	xfrm_length = betoh16(xfrm->xfrm_length);
  ------------------
  |  |   40|  6.72k|#define betoh16	be16toh
  ------------------
  472|  6.72k|	if (xfrm_length < sizeof(*xfrm)) {
  ------------------
  |  Branch (472:6): [True: 452, False: 6.27k]
  ------------------
  473|    452|		log_debug("%s: malformed payload: shorter than minimum header "
  474|    452|		    "size (%zu < %zu)", __func__, xfrm_length, sizeof(*xfrm));
  475|    452|		return (-1);
  476|    452|	}
  477|  6.27k|	if (total < xfrm_length) {
  ------------------
  |  Branch (477:6): [True: 427, False: 5.84k]
  ------------------
  478|    427|		log_debug("%s: malformed payload: too long for payload size "
  479|    427|		    "(%zu < %zu)", __func__, total, xfrm_length);
  480|    427|		return (-1);
  481|    427|	}
  482|       |
  483|  5.84k|	return (0);
  484|  6.27k|}
ikev2_pld_xform:
  489|  7.13k|{
  490|  7.13k|	struct ikev2_transform		 xfrm;
  491|  7.13k|	char				 id[BUFSIZ];
  492|  7.13k|	int				 ret = 0;
  493|  7.13k|	int				 r;
  494|  7.13k|	size_t				 xfrm_length;
  495|       |
  496|  7.13k|	if (ikev2_validate_xform(msg, offset, total, &xfrm))
  ------------------
  |  Branch (496:6): [True: 1.29k, False: 5.84k]
  ------------------
  497|  1.29k|		return (-1);
  498|       |
  499|  5.84k|	xfrm_length = betoh16(xfrm.xfrm_length);
  ------------------
  |  |   40|  5.84k|#define betoh16	be16toh
  ------------------
  500|       |
  501|  5.84k|	switch (xfrm.xfrm_type) {
  502|    734|	case IKEV2_XFORMTYPE_ENCR:
  ------------------
  |  |  156|    734|#define IKEV2_XFORMTYPE_ENCR		1	/* Encryption */
  ------------------
  |  Branch (502:2): [True: 734, False: 5.11k]
  ------------------
  503|    734|		strlcpy(id, print_map(betoh16(xfrm.xfrm_id),
  ------------------
  |  |   40|    734|#define betoh16	be16toh
  ------------------
  504|    734|		    ikev2_xformencr_map), sizeof(id));
  505|    734|		break;
  506|  2.37k|	case IKEV2_XFORMTYPE_PRF:
  ------------------
  |  |  157|  2.37k|#define IKEV2_XFORMTYPE_PRF		2	/* Pseudo-Random Function */
  ------------------
  |  Branch (506:2): [True: 2.37k, False: 3.46k]
  ------------------
  507|  2.37k|		strlcpy(id, print_map(betoh16(xfrm.xfrm_id),
  ------------------
  |  |   40|  2.37k|#define betoh16	be16toh
  ------------------
  508|  2.37k|		    ikev2_xformprf_map), sizeof(id));
  509|  2.37k|		break;
  510|    362|	case IKEV2_XFORMTYPE_INTEGR:
  ------------------
  |  |  158|    362|#define IKEV2_XFORMTYPE_INTEGR		3	/* Integrity Algorithm */
  ------------------
  |  Branch (510:2): [True: 362, False: 5.48k]
  ------------------
  511|    362|		strlcpy(id, print_map(betoh16(xfrm.xfrm_id),
  ------------------
  |  |   40|    362|#define betoh16	be16toh
  ------------------
  512|    362|		    ikev2_xformauth_map), sizeof(id));
  513|    362|		break;
  514|    103|	case IKEV2_XFORMTYPE_DH:
  ------------------
  |  |  159|    103|#define IKEV2_XFORMTYPE_DH		4	/* Diffie-Hellman Group */
  ------------------
  |  Branch (514:2): [True: 103, False: 5.74k]
  ------------------
  515|    103|		strlcpy(id, print_map(betoh16(xfrm.xfrm_id),
  ------------------
  |  |   40|    103|#define betoh16	be16toh
  ------------------
  516|    103|		    ikev2_xformdh_map), sizeof(id));
  517|    103|		break;
  518|    526|	case IKEV2_XFORMTYPE_ESN:
  ------------------
  |  |  160|    526|#define IKEV2_XFORMTYPE_ESN		5	/* Extended Sequence Numbers */
  ------------------
  |  Branch (518:2): [True: 526, False: 5.31k]
  ------------------
  519|    526|		strlcpy(id, print_map(betoh16(xfrm.xfrm_id),
  ------------------
  |  |   40|    526|#define betoh16	be16toh
  ------------------
  520|    526|		    ikev2_xformesn_map), sizeof(id));
  521|    526|		break;
  522|  1.74k|	default:
  ------------------
  |  Branch (522:2): [True: 1.74k, False: 4.10k]
  ------------------
  523|  1.74k|		snprintf(id, sizeof(id), "<%d>", betoh16(xfrm.xfrm_id));
  524|  1.74k|		break;
  525|  5.84k|	}
  526|       |
  527|  5.84k|	log_debug("%s: more %d reserved %d length %zu"
  528|  5.84k|	    " type %s id %s",
  529|  5.84k|	    __func__, xfrm.xfrm_more, xfrm.xfrm_reserved, xfrm_length,
  530|  5.84k|	    print_map(xfrm.xfrm_type, ikev2_xformtype_map), id);
  531|       |
  532|       |	/*
  533|       |	 * Parse transform attributes, if available
  534|       |	 */
  535|  5.84k|	msg->msg_attrlength = 0;
  536|  5.84k|	if (xfrm_length > sizeof(xfrm)) {
  ------------------
  |  Branch (536:6): [True: 4.17k, False: 1.67k]
  ------------------
  537|  4.17k|		if (ikev2_pld_attr(env, &xfrm, msg, offset + sizeof(xfrm),
  ------------------
  |  Branch (537:7): [True: 3.02k, False: 1.15k]
  ------------------
  538|  4.17k|		    xfrm_length - sizeof(xfrm)) != 0) {
  539|  3.02k|			return (-1);
  540|  3.02k|		}
  541|  4.17k|	}
  542|       |
  543|  2.82k|	if (ikev2_msg_frompeer(msg)) {
  ------------------
  |  Branch (543:6): [True: 0, False: 2.82k]
  ------------------
  544|      0|		r = config_add_transform(msg->msg_parent->msg_prop,
  545|      0|		    xfrm.xfrm_type, betoh16(xfrm.xfrm_id),
  ------------------
  |  |   40|      0|#define betoh16	be16toh
  ------------------
  546|      0|		    msg->msg_attrlength, msg->msg_attrlength);
  547|      0|		if (r == -1) {
  ------------------
  |  Branch (547:7): [True: 0, False: 0]
  ------------------
  548|      0|			log_debug("%s: failed to add transform: alloc error",
  549|      0|			    __func__);
  550|      0|			return (r);
  551|      0|		} else if (r == -2) {
  ------------------
  |  Branch (551:14): [True: 0, False: 0]
  ------------------
  552|      0|			log_debug("%s: failed to add transform: unknown type",
  553|      0|			    __func__);
  554|      0|			return (r);
  555|      0|		}
  556|      0|	}
  557|       |
  558|       |	/* Next transform */
  559|  2.82k|	offset += xfrm_length;
  560|  2.82k|	total -= xfrm_length;
  561|  2.82k|	if (xfrm.xfrm_more == IKEV2_XFORM_MORE)
  ------------------
  |  |  154|  2.82k|#define IKEV2_XFORM_MORE		3
  ------------------
  |  Branch (561:6): [True: 1.95k, False: 871]
  ------------------
  562|  1.95k|		ret = ikev2_pld_xform(env, msg, offset, total);
  563|    871|	else if (total != 0) {
  ------------------
  |  Branch (563:11): [True: 68, False: 803]
  ------------------
  564|       |		/* No more transforms but still some data left. */
  565|     68|		log_debug("%s: less data than specified, %zu bytes left",
  566|     68|		    __func__, total);
  567|     68|		ret = -1;
  568|     68|	}
  569|       |
  570|  2.82k|	return (ret);
  571|  2.82k|}
ikev2_validate_attr:
  576|  23.1k|{
  577|  23.1k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
  578|       |
  579|  23.1k|	if (total < sizeof(*attr)) {
  ------------------
  |  Branch (579:6): [True: 593, False: 22.5k]
  ------------------
  580|    593|		log_debug("%s: malformed payload: too short for header "
  581|    593|		    "(%zu < %zu)", __func__, total, sizeof(*attr));
  582|    593|		return (-1);
  583|    593|	}
  584|  22.5k|	memcpy(attr, msgbuf + offset, sizeof(*attr));
  585|       |
  586|  22.5k|	return (0);
  587|  23.1k|}
ikev2_pld_attr:
  592|  23.1k|{
  593|  23.1k|	struct ikev2_attribute		 attr;
  594|  23.1k|	unsigned int			 type;
  595|  23.1k|	uint8_t				*msgbuf = ibuf_data(msg->msg_data);
  596|  23.1k|	int				 ret = 0;
  597|  23.1k|	size_t				 attr_length;
  598|       |
  599|  23.1k|	if (ikev2_validate_attr(msg, offset, total, &attr))
  ------------------
  |  Branch (599:6): [True: 593, False: 22.5k]
  ------------------
  600|    593|		return (-1);
  601|       |
  602|  22.5k|	type = betoh16(attr.attr_type) & ~IKEV2_ATTRAF_TV;
  ------------------
  |  |   40|  22.5k|#define betoh16	be16toh
  ------------------
              	type = betoh16(attr.attr_type) & ~IKEV2_ATTRAF_TV;
  ------------------
  |  |  279|  22.5k|#define IKEV2_ATTRAF_TV			0x8000	/* Type-Value format */
  ------------------
  603|       |
  604|  22.5k|	log_debug("%s: attribute type %s length %d total %zu",
  605|  22.5k|	    __func__, print_map(type, ikev2_attrtype_map),
  606|  22.5k|	    betoh16(attr.attr_length), total);
  ------------------
  |  |   40|  22.5k|#define betoh16	be16toh
  ------------------
  607|       |
  608|  22.5k|	if (betoh16(attr.attr_type) & IKEV2_ATTRAF_TV) {
  ------------------
  |  |   40|  22.5k|#define betoh16	be16toh
  ------------------
              	if (betoh16(attr.attr_type) & IKEV2_ATTRAF_TV) {
  ------------------
  |  |  279|  22.5k|#define IKEV2_ATTRAF_TV			0x8000	/* Type-Value format */
  ------------------
  |  Branch (608:6): [True: 7.25k, False: 15.3k]
  ------------------
  609|       |		/* Type-Value attribute */
  610|  7.25k|		offset += sizeof(attr);
  611|  7.25k|		total -= sizeof(attr);
  612|       |
  613|  7.25k|		if (type == IKEV2_ATTRTYPE_KEY_LENGTH)
  ------------------
  |  |  281|  7.25k|#define IKEV2_ATTRTYPE_KEY_LENGTH	14	/* Key length */
  ------------------
  |  Branch (613:7): [True: 50, False: 7.20k]
  ------------------
  614|     50|			msg->msg_attrlength = betoh16(attr.attr_length);
  ------------------
  |  |   40|     50|#define betoh16	be16toh
  ------------------
  615|  15.3k|	} else {
  616|       |		/* Type-Length-Value attribute */
  617|  15.3k|		attr_length = betoh16(attr.attr_length);
  ------------------
  |  |   40|  15.3k|#define betoh16	be16toh
  ------------------
  618|  15.3k|		if (attr_length < sizeof(attr)) {
  ------------------
  |  Branch (618:7): [True: 1.24k, False: 14.0k]
  ------------------
  619|  1.24k|			log_debug("%s: malformed payload: shorter than "
  620|  1.24k|			    "minimum header size (%zu < %zu)", __func__,
  621|  1.24k|			    attr_length, sizeof(attr));
  622|  1.24k|			return (-1);
  623|  1.24k|		}
  624|  14.0k|		if (total < attr_length) {
  ------------------
  |  Branch (624:7): [True: 1.18k, False: 12.8k]
  ------------------
  625|  1.18k|			log_debug("%s: malformed payload: attribute larger "
  626|  1.18k|			    "than actual payload (%zu < %zu)", __func__,
  627|  1.18k|			    total, attr_length);
  628|  1.18k|			return (-1);
  629|  1.18k|		}
  630|  12.8k|		print_hex(msgbuf, offset + sizeof(attr),
  631|  12.8k|		    attr_length - sizeof(attr));
  632|  12.8k|		offset += attr_length;
  633|  12.8k|		total -= attr_length;
  634|  12.8k|	}
  635|       |
  636|  20.1k|	if (total > 0) {
  ------------------
  |  Branch (636:6): [True: 18.9k, False: 1.15k]
  ------------------
  637|       |		/* Next attribute */
  638|  18.9k|		ret = ikev2_pld_attr(env, xfrm, msg, offset, total);
  639|  18.9k|	}
  640|       |
  641|  20.1k|	return (ret);
  642|  22.5k|}
ikev2_validate_ke:
  647|  2.01k|{
  648|  2.01k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
  649|       |
  650|  2.01k|	if (left < sizeof(*kex)) {
  ------------------
  |  Branch (650:6): [True: 1.44k, False: 569]
  ------------------
  651|  1.44k|		log_debug("%s: malformed payload: too short for header "
  652|  1.44k|		    "(%zu < %zu)", __func__, left, sizeof(*kex));
  653|  1.44k|		return (-1);
  654|  1.44k|	}
  655|    569|	memcpy(kex, msgbuf + offset, sizeof(*kex));
  656|       |
  657|    569|	return (0);
  658|  2.01k|}
ikev2_pld_ke:
  663|  2.01k|{
  664|  2.01k|	struct ikev2_keyexchange	 kex;
  665|  2.01k|	uint8_t				*buf;
  666|  2.01k|	size_t				 len;
  667|  2.01k|	uint8_t				*msgbuf = ibuf_data(msg->msg_data);
  668|       |
  669|  2.01k|	if (ikev2_validate_ke(msg, offset, left, &kex))
  ------------------
  |  Branch (669:6): [True: 1.44k, False: 569]
  ------------------
  670|  1.44k|		return (-1);
  671|       |
  672|    569|	log_debug("%s: dh group %s reserved %d", __func__,
  673|    569|	    print_map(betoh16(kex.kex_dhgroup), ikev2_xformdh_map),
  ------------------
  |  |   40|    569|#define betoh16	be16toh
  ------------------
  674|    569|	    betoh16(kex.kex_reserved));
  ------------------
  |  |   40|    569|#define betoh16	be16toh
  ------------------
  675|       |
  676|    569|	buf = msgbuf + offset + sizeof(kex);
  677|    569|	len = left - sizeof(kex);
  678|       |
  679|    569|	if (len == 0) {
  ------------------
  |  Branch (679:6): [True: 50, False: 519]
  ------------------
  680|     50|		log_debug("%s: malformed payload: no KE data given", __func__);
  681|     50|		return (-1);
  682|     50|	}
  683|       |
  684|    519|	print_hex(buf, 0, len);
  685|       |
  686|    519|	if (ikev2_msg_frompeer(msg)) {
  ------------------
  |  Branch (686:6): [True: 0, False: 519]
  ------------------
  687|      0|		if (ibuf_length(msg->msg_parent->msg_ke)) {
  ------------------
  |  Branch (687:7): [True: 0, False: 0]
  ------------------
  688|      0|			log_info("%s: duplicate KE payload", __func__);
  689|      0|			return (-1);
  690|      0|		}
  691|      0|		if ((msg->msg_parent->msg_ke = ibuf_new(buf, len)) == NULL) {
  ------------------
  |  Branch (691:7): [True: 0, False: 0]
  ------------------
  692|      0|			log_debug("%s: failed to get exchange", __func__);
  693|      0|			return (-1);
  694|      0|		}
  695|      0|		msg->msg_parent->msg_dhgroup = betoh16(kex.kex_dhgroup);
  ------------------
  |  |   40|      0|#define betoh16	be16toh
  ------------------
  696|      0|	}
  697|       |
  698|    519|	return (0);
  699|    519|}
ikev2_validate_id:
  704|  3.57k|{
  705|  3.57k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
  706|       |
  707|  3.57k|	if (left < sizeof(*id)) {
  ------------------
  |  Branch (707:6): [True: 2.16k, False: 1.40k]
  ------------------
  708|  2.16k|		log_debug("%s: malformed payload: too short for header "
  709|  2.16k|		    "(%zu < %zu)", __func__, left, sizeof(*id));
  710|  2.16k|		return (-1);
  711|  2.16k|	}
  712|  1.40k|	memcpy(id, msgbuf + offset, sizeof(*id));
  713|       |
  714|  1.40k|	if (id->id_type == IKEV2_ID_NONE) {
  ------------------
  |  |  397|  1.40k|#define IKEV2_ID_NONE		0	/* No ID */
  ------------------
  |  Branch (714:6): [True: 229, False: 1.18k]
  ------------------
  715|    229|		log_debug("%s: malformed payload: invalid ID type.",
  716|    229|		    __func__);
  717|    229|		return (-1);
  718|    229|	}
  719|       |
  720|  1.18k|	return (0);
  721|  1.40k|}
ikev2_pld_id:
  726|  3.57k|{
  727|  3.57k|	uint8_t				*ptr;
  728|  3.57k|	struct ikev2_id			 id;
  729|  3.57k|	size_t				 len;
  730|  3.57k|	struct iked_id			*idp, idb;
  731|  3.57k|	const struct iked_sa		*sa = msg->msg_sa;
  732|  3.57k|	uint8_t				*msgbuf = ibuf_data(msg->msg_data);
  733|  3.57k|	char				 idstr[IKED_ID_SIZE];
  734|       |
  735|  3.57k|	if (ikev2_validate_id(msg, offset, left, &id))
  ------------------
  |  Branch (735:6): [True: 2.39k, False: 1.18k]
  ------------------
  736|  2.39k|		return (-1);
  737|       |
  738|  1.18k|	bzero(&idb, sizeof(idb));
  739|       |
  740|       |	/* Don't strip the Id payload header */
  741|  1.18k|	ptr = msgbuf + offset;
  742|  1.18k|	len = left;
  743|       |
  744|  1.18k|	idb.id_type = id.id_type;
  745|  1.18k|	idb.id_offset = sizeof(id);
  746|  1.18k|	if ((idb.id_buf = ibuf_new(ptr, len)) == NULL)
  ------------------
  |  Branch (746:6): [True: 0, False: 1.18k]
  ------------------
  747|      0|		return (-1);
  748|       |
  749|  1.18k|	if (ikev2_print_id(&idb, idstr, sizeof(idstr)) == -1) {
  ------------------
  |  Branch (749:6): [True: 0, False: 1.18k]
  ------------------
  750|      0|		ibuf_release(idb.id_buf);
  751|      0|		log_debug("%s: malformed id", __func__);
  752|      0|		return (-1);
  753|      0|	}
  754|       |
  755|  1.18k|	log_debug("%s: id %s length %zu", __func__, idstr, len);
  756|       |
  757|  1.18k|	if (!ikev2_msg_frompeer(msg)) {
  ------------------
  |  Branch (757:6): [True: 1.18k, False: 0]
  ------------------
  758|  1.18k|		ibuf_release(idb.id_buf);
  759|  1.18k|		return (0);
  760|  1.18k|	}
  761|       |
  762|      0|	if (((sa->sa_hdr.sh_initiator && payload == IKEV2_PAYLOAD_IDr) ||
  ------------------
  |  |   96|      0|#define IKEV2_PAYLOAD_IDr	36	/* Identification - Responder */
  ------------------
  |  Branch (762:8): [True: 0, False: 0]
  |  Branch (762:35): [True: 0, False: 0]
  ------------------
  763|      0|	    (!sa->sa_hdr.sh_initiator && payload == IKEV2_PAYLOAD_IDi)))
  ------------------
  |  |   95|      0|#define IKEV2_PAYLOAD_IDi	35	/* Identification - Initiator */
  ------------------
  |  Branch (763:7): [True: 0, False: 0]
  |  Branch (763:35): [True: 0, False: 0]
  ------------------
  764|      0|		idp = &msg->msg_parent->msg_peerid;
  765|      0|	else if (!sa->sa_hdr.sh_initiator && payload == IKEV2_PAYLOAD_IDr)
  ------------------
  |  |   96|      0|#define IKEV2_PAYLOAD_IDr	36	/* Identification - Responder */
  ------------------
  |  Branch (765:11): [True: 0, False: 0]
  |  Branch (765:39): [True: 0, False: 0]
  ------------------
  766|      0|		idp = &msg->msg_parent->msg_localid;
  767|      0|	else {
  768|      0|		ibuf_release(idb.id_buf);
  769|      0|		log_debug("%s: unexpected id payload", __func__);
  770|      0|		return (0);
  771|      0|	}
  772|       |
  773|      0|	if (idp->id_type) {
  ------------------
  |  Branch (773:6): [True: 0, False: 0]
  ------------------
  774|      0|		ibuf_release(idb.id_buf);
  775|      0|		log_debug("%s: duplicate id payload", __func__);
  776|      0|		return (-1);
  777|      0|	}
  778|       |
  779|      0|	idp->id_buf = idb.id_buf;
  780|      0|	idp->id_offset = idb.id_offset;
  781|      0|	idp->id_type = idb.id_type;
  782|       |
  783|      0|	return (0);
  784|      0|}
ikev2_validate_cert:
  789|    898|{
  790|    898|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
  791|       |
  792|    898|	if (left < sizeof(*cert)) {
  ------------------
  |  Branch (792:6): [True: 119, False: 779]
  ------------------
  793|    119|		log_debug("%s: malformed payload: too short for header "
  794|    119|		    "(%zu < %zu)", __func__, left, sizeof(*cert));
  795|    119|		return (-1);
  796|    119|	}
  797|    779|	memcpy(cert, msgbuf + offset, sizeof(*cert));
  798|       |
  799|    779|	return (0);
  800|    898|}
ikev2_pld_cert:
  805|    898|{
  806|    898|	struct ikev2_cert		 cert;
  807|    898|	uint8_t				*buf;
  808|    898|	size_t				 len;
  809|    898|	struct iked_id			*certid;
  810|    898|	uint8_t				*msgbuf = ibuf_data(msg->msg_data);
  811|    898|	const struct iked_sa		*sa = msg->msg_sa;
  812|       |
  813|    898|	if (ikev2_validate_cert(msg, offset, left, &cert))
  ------------------
  |  Branch (813:6): [True: 119, False: 779]
  ------------------
  814|    119|		return (-1);
  815|    779|	offset += sizeof(cert);
  816|       |
  817|    779|	buf = msgbuf + offset;
  818|    779|	len = left - sizeof(cert);
  819|       |
  820|    779|	log_debug("%s: type %s length %zu",
  821|    779|	    __func__, print_map(cert.cert_type, ikev2_cert_map), len);
  822|       |
  823|    779|	print_hex(buf, 0, len);
  824|       |
  825|    779|	if (!ikev2_msg_frompeer(msg))
  ------------------
  |  Branch (825:6): [True: 779, False: 0]
  ------------------
  826|    779|		return (0);
  827|       |
  828|      0|	certid = &msg->msg_parent->msg_cert;
  829|      0|	if (certid->id_type) {
  ------------------
  |  Branch (829:6): [True: 0, False: 0]
  ------------------
  830|      0|		log_info("%s: multiple cert payloads not supported",
  831|      0|		   SPI_SA(sa, __func__));
  ------------------
  |  | 1050|      0|#define SPI_SA(sa, f)    SPI_SH(&(sa)->sa_hdr, (f))
  |  |  ------------------
  |  |  |  | 1049|      0|#define SPI_SH(sh, f)    ikev2_ikesa_info((sh)->sh_ispi, (f))
  |  |  ------------------
  ------------------
  832|      0|		return (-1);
  833|      0|	}
  834|       |
  835|      0|	if ((certid->id_buf = ibuf_new(buf, len)) == NULL) {
  ------------------
  |  Branch (835:6): [True: 0, False: 0]
  ------------------
  836|      0|		log_debug("%s: failed to save cert", __func__);
  837|      0|		return (-1);
  838|      0|	}
  839|      0|	certid->id_type = cert.cert_type;
  840|      0|	certid->id_offset = 0;
  841|       |
  842|      0|	return (0);
  843|      0|}
ikev2_validate_certreq:
  848|  10.2k|{
  849|  10.2k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
  850|       |
  851|  10.2k|	if (left < sizeof(*cert)) {
  ------------------
  |  Branch (851:6): [True: 2.68k, False: 7.56k]
  ------------------
  852|  2.68k|		log_debug("%s: malformed payload: too short for header "
  853|  2.68k|		    "(%zu < %zu)", __func__, left, sizeof(*cert));
  854|  2.68k|		return (-1);
  855|  2.68k|	}
  856|  7.56k|	memcpy(cert, msgbuf + offset, sizeof(*cert));
  857|       |
  858|  7.56k|	return (0);
  859|  10.2k|}
ikev2_pld_certreq:
  864|  10.2k|{
  865|  10.2k|	struct ikev2_cert		 cert;
  866|  10.2k|	struct iked_certreq		*cr;
  867|  10.2k|	uint8_t				*buf;
  868|  10.2k|	ssize_t				 len;
  869|  10.2k|	uint8_t				*msgbuf = ibuf_data(msg->msg_data);
  870|       |
  871|  10.2k|	if (ikev2_validate_certreq(msg, offset, left, &cert))
  ------------------
  |  Branch (871:6): [True: 2.68k, False: 7.56k]
  ------------------
  872|  2.68k|		return (-1);
  873|  7.56k|	offset += sizeof(cert);
  874|       |
  875|  7.56k|	buf = msgbuf + offset;
  876|  7.56k|	len = left - sizeof(cert);
  877|       |
  878|  7.56k|	log_debug("%s: type %s length %zd",
  879|  7.56k|	    __func__, print_map(cert.cert_type, ikev2_cert_map), len);
  880|       |
  881|  7.56k|	print_hex(buf, 0, len);
  882|       |
  883|  7.56k|	if (!ikev2_msg_frompeer(msg))
  ------------------
  |  Branch (883:6): [True: 7.56k, False: 0]
  ------------------
  884|  7.56k|		return (0);
  885|       |
  886|      0|	if (cert.cert_type == IKEV2_CERT_X509_CERT) {
  ------------------
  |  |  422|      0|#define IKEV2_CERT_X509_CERT		4	/* RFC7296 */
  ------------------
  |  Branch (886:6): [True: 0, False: 0]
  ------------------
  887|      0|		if (len == 0) {
  ------------------
  |  Branch (887:7): [True: 0, False: 0]
  ------------------
  888|      0|			log_info("%s: invalid length 0", __func__);
  889|      0|			return (0);
  890|      0|		}
  891|      0|		if ((len % SHA_DIGEST_LENGTH) != 0) {
  ------------------
  |  Branch (891:7): [True: 0, False: 0]
  ------------------
  892|      0|			log_info("%s: invalid certificate request",
  893|      0|			    __func__);
  894|      0|			return (-1);
  895|      0|		}
  896|      0|	}
  897|       |
  898|      0|	if ((cr = calloc(1, sizeof(struct iked_certreq))) == NULL) {
  ------------------
  |  Branch (898:6): [True: 0, False: 0]
  ------------------
  899|      0|		log_info("%s: failed to allocate certreq.", __func__);
  900|      0|		return (-1);
  901|      0|	}
  902|      0|	if ((cr->cr_data = ibuf_new(buf, len)) == NULL) {
  ------------------
  |  Branch (902:6): [True: 0, False: 0]
  ------------------
  903|      0|		log_info("%s: failed to allocate buffer.", __func__);
  904|      0|		free(cr);
  905|      0|		return (-1);
  906|      0|	}
  907|      0|	cr->cr_type = cert.cert_type;
  908|      0|	SIMPLEQ_INSERT_TAIL(&msg->msg_parent->msg_certreqs, cr, cr_entry);
  ------------------
  |  |  296|      0|#define SIMPLEQ_INSERT_TAIL(head, elm, field) do {			\
  |  |  297|      0|	(elm)->field.sqe_next = NULL;					\
  |  |  298|      0|	*(head)->sqh_last = (elm);					\
  |  |  299|      0|	(head)->sqh_last = &(elm)->field.sqe_next;			\
  |  |  300|      0|} while (0)
  |  |  ------------------
  |  |  |  Branch (300:10): [Folded - Ignored]
  |  |  ------------------
  ------------------
  909|       |
  910|      0|	return (0);
  911|      0|}
ikev2_validate_auth:
  916|  2.29k|{
  917|  2.29k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
  918|       |
  919|  2.29k|	if (left < sizeof(*auth)) {
  ------------------
  |  Branch (919:6): [True: 866, False: 1.42k]
  ------------------
  920|    866|		log_debug("%s: malformed payload: too short for header "
  921|    866|		    "(%zu < %zu)", __func__, left, sizeof(*auth));
  922|    866|		return (-1);
  923|    866|	}
  924|  1.42k|	memcpy(auth, msgbuf + offset, sizeof(*auth));
  925|       |
  926|  1.42k|	if (auth->auth_method == 0) {
  ------------------
  |  Branch (926:6): [True: 374, False: 1.05k]
  ------------------
  927|    374|		log_info("%s: malformed payload: invalid auth method",
  928|    374|		    __func__);
  929|    374|		return (-1);
  930|    374|	}
  931|       |
  932|  1.05k|	return (0);
  933|  1.42k|}
ikev2_pld_auth:
  938|  2.29k|{
  939|  2.29k|	struct ikev2_auth		 auth;
  940|  2.29k|	struct iked_id			*idp;
  941|  2.29k|	uint8_t				*buf;
  942|  2.29k|	size_t				 len;
  943|  2.29k|	uint8_t				*msgbuf = ibuf_data(msg->msg_data);
  944|       |
  945|  2.29k|	if (ikev2_validate_auth(msg, offset, left, &auth))
  ------------------
  |  Branch (945:6): [True: 1.24k, False: 1.05k]
  ------------------
  946|  1.24k|		return (-1);
  947|  1.05k|	offset += sizeof(auth);
  948|       |
  949|  1.05k|	buf = msgbuf + offset;
  950|  1.05k|	len = left - sizeof(auth);
  951|       |
  952|  1.05k|	log_debug("%s: method %s length %zu",
  953|  1.05k|	    __func__, print_map(auth.auth_method, ikev2_auth_map), len);
  954|       |
  955|  1.05k|	print_hex(buf, 0, len);
  956|       |
  957|  1.05k|	if (!ikev2_msg_frompeer(msg))
  ------------------
  |  Branch (957:6): [True: 1.05k, False: 0]
  ------------------
  958|  1.05k|		return (0);
  959|       |
  960|      0|	idp = &msg->msg_parent->msg_auth;
  961|      0|	if (idp->id_type) {
  ------------------
  |  Branch (961:6): [True: 0, False: 0]
  ------------------
  962|      0|		log_debug("%s: duplicate auth payload", __func__);
  963|      0|		return (-1);
  964|      0|	}
  965|       |
  966|      0|	ibuf_release(idp->id_buf);
  967|      0|	idp->id_type = auth.auth_method;
  968|      0|	idp->id_offset = 0;
  969|      0|	if ((idp->id_buf = ibuf_new(buf, len)) == NULL)
  ------------------
  |  Branch (969:6): [True: 0, False: 0]
  ------------------
  970|      0|		return (-1);
  971|       |
  972|      0|	return (0);
  973|      0|}
ikev2_pld_nonce:
  978|    203|{
  979|    203|	size_t		 len;
  980|    203|	uint8_t		*buf;
  981|    203|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
  982|       |
  983|    203|	buf = msgbuf + offset;
  984|    203|	len = left;
  985|       |
  986|    203|	if (len == 0) {
  ------------------
  |  Branch (986:6): [True: 149, False: 54]
  ------------------
  987|    149|		log_debug("%s: malformed payload: no NONCE given", __func__);
  988|    149|		return (-1);
  989|    149|	}
  990|       |
  991|     54|	print_hex(buf, 0, len);
  992|       |
  993|     54|	if (ikev2_msg_frompeer(msg)) {
  ------------------
  |  Branch (993:6): [True: 0, False: 54]
  ------------------
  994|      0|		if (ibuf_length(msg->msg_parent->msg_nonce)) {
  ------------------
  |  Branch (994:7): [True: 0, False: 0]
  ------------------
  995|      0|			log_info("%s: duplicate NONCE payload", __func__);
  996|      0|			return (-1);
  997|      0|		}
  998|      0|		if ((msg->msg_nonce = ibuf_new(buf, len)) == NULL) {
  ------------------
  |  Branch (998:7): [True: 0, False: 0]
  ------------------
  999|      0|			log_debug("%s: failed to get peer nonce", __func__);
 1000|      0|			return (-1);
 1001|      0|		}
 1002|      0|		msg->msg_parent->msg_nonce = msg->msg_nonce;
 1003|      0|	}
 1004|       |
 1005|     54|	return (0);
 1006|     54|}
ikev2_validate_notify:
 1011|  4.44k|{
 1012|  4.44k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
 1013|       |
 1014|  4.44k|	if (left < sizeof(*n)) {
  ------------------
  |  Branch (1014:6): [True: 2.68k, False: 1.76k]
  ------------------
 1015|  2.68k|		log_debug("%s: malformed payload: too short for header "
 1016|  2.68k|		    "(%zu < %zu)", __func__, left, sizeof(*n));
 1017|  2.68k|		return (-1);
 1018|  2.68k|	}
 1019|  1.76k|	memcpy(n, msgbuf + offset, sizeof(*n));
 1020|       |
 1021|  1.76k|	return (0);
 1022|  4.44k|}
ikev2_pld_notify:
 1027|  4.44k|{
 1028|  4.44k|	struct ikev2_notify	 n;
 1029|  4.44k|	const struct iked_sa	*sa = msg->msg_sa;
 1030|  4.44k|	uint8_t			*buf, md[SHA_DIGEST_LENGTH];
 1031|  4.44k|	uint32_t		 spi32;
 1032|  4.44k|	uint64_t		 spi64;
 1033|  4.44k|	struct iked_spi		*rekey;
 1034|  4.44k|	uint16_t		 type;
 1035|  4.44k|	uint16_t		 signature_hash;
 1036|       |
 1037|  4.44k|	if (ikev2_validate_notify(msg, offset, left, &n))
  ------------------
  |  Branch (1037:6): [True: 2.68k, False: 1.76k]
  ------------------
 1038|  2.68k|		return (-1);
 1039|  1.76k|	type = betoh16(n.n_type);
  ------------------
  |  |   40|  1.76k|#define betoh16	be16toh
  ------------------
 1040|       |
 1041|  1.76k|	log_debug("%s: protoid %s spisize %d type %s",
 1042|  1.76k|	    __func__,
 1043|  1.76k|	    print_map(n.n_protoid, ikev2_saproto_map), n.n_spisize,
 1044|  1.76k|	    print_map(type, ikev2_n_map));
 1045|       |
 1046|  1.76k|	left -= sizeof(n);
 1047|  1.76k|	if ((buf = ibuf_seek(msg->msg_data, offset + sizeof(n), left)) == NULL)
  ------------------
  |  Branch (1047:6): [True: 0, False: 1.76k]
  ------------------
 1048|      0|		return (-1);
 1049|       |
 1050|  1.76k|	print_hex(buf, 0, left);
 1051|       |
 1052|  1.76k|	if (!ikev2_msg_frompeer(msg))
  ------------------
  |  Branch (1052:6): [True: 1.76k, False: 0]
  ------------------
 1053|  1.76k|		return (0);
 1054|       |
 1055|      0|	switch (type) {
  ------------------
  |  Branch (1055:10): [True: 0, False: 0]
  ------------------
 1056|      0|	case IKEV2_N_NAT_DETECTION_SOURCE_IP:
  ------------------
  |  |  330|      0|#define IKEV2_N_NAT_DETECTION_SOURCE_IP		16388	/* RFC7296 */
  ------------------
  |  Branch (1056:2): [True: 0, False: 0]
  ------------------
 1057|      0|	case IKEV2_N_NAT_DETECTION_DESTINATION_IP:
  ------------------
  |  |  331|      0|#define IKEV2_N_NAT_DETECTION_DESTINATION_IP	16389	/* RFC7296 */
  ------------------
  |  Branch (1057:2): [True: 0, False: 0]
  ------------------
 1058|      0|		if (left != sizeof(md)) {
  ------------------
  |  Branch (1058:7): [True: 0, False: 0]
  ------------------
 1059|      0|			log_debug("%s: malformed payload: hash size mismatch"
 1060|      0|			    " (%zu != %zu)", __func__, left, sizeof(md));
 1061|      0|			return (-1);
 1062|      0|		}
 1063|      0|		if (ikev2_nat_detection(env, msg, md, sizeof(md), type,
  ------------------
  |  Branch (1063:7): [True: 0, False: 0]
  ------------------
 1064|      0|		    ikev2_msg_frompeer(msg)) == -1)
 1065|      0|			return (-1);
 1066|      0|		if (memcmp(buf, md, left) != 0) {
  ------------------
  |  Branch (1066:7): [True: 0, False: 0]
  ------------------
 1067|      0|			log_debug("%s: %s detected NAT", __func__,
 1068|      0|			    print_map(type, ikev2_n_map));
 1069|      0|			if (type == IKEV2_N_NAT_DETECTION_SOURCE_IP)
  ------------------
  |  |  330|      0|#define IKEV2_N_NAT_DETECTION_SOURCE_IP		16388	/* RFC7296 */
  ------------------
  |  Branch (1069:8): [True: 0, False: 0]
  ------------------
 1070|      0|				msg->msg_parent->msg_nat_detected
 1071|      0|				    |= IKED_MSG_NAT_SRC_IP;
  ------------------
  |  |  648|      0|#define IKED_MSG_NAT_SRC_IP				0x01
  ------------------
 1072|      0|			else
 1073|      0|				msg->msg_parent->msg_nat_detected
 1074|      0|				    |= IKED_MSG_NAT_DST_IP;
  ------------------
  |  |  649|      0|#define IKED_MSG_NAT_DST_IP				0x02
  ------------------
 1075|      0|		}
 1076|      0|		print_hex(md, 0, sizeof(md));
 1077|       |		/* remember for MOBIKE */
 1078|      0|		msg->msg_parent->msg_natt_rcvd = 1;
 1079|      0|		break;
 1080|      0|	case IKEV2_N_AUTHENTICATION_FAILED:
  ------------------
  |  |  314|      0|#define IKEV2_N_AUTHENTICATION_FAILED		24	/* RFC7296 */
  ------------------
  |  Branch (1080:2): [True: 0, False: 0]
  ------------------
 1081|      0|		if (!msg->msg_e) {
  ------------------
  |  Branch (1081:7): [True: 0, False: 0]
  ------------------
 1082|      0|			log_debug("%s: AUTHENTICATION_FAILED not encrypted",
 1083|      0|			    __func__);
 1084|      0|			return (-1);
 1085|      0|		}
 1086|       |		/*
 1087|       |		 * If we are the responder, then we only accept
 1088|       |		 * AUTHENTICATION_FAILED from authenticated peers.
 1089|       |		 * If we are the initiator, the peer cannot be authenticated.
 1090|       |		 */
 1091|      0|		if (!sa->sa_hdr.sh_initiator) {
  ------------------
  |  Branch (1091:7): [True: 0, False: 0]
  ------------------
 1092|      0|			if (!sa_stateok(sa, IKEV2_STATE_VALID)) {
  ------------------
  |  |   41|      0|#define IKEV2_STATE_VALID		7	/* authenticated AND validated certs */
  ------------------
  |  Branch (1092:8): [True: 0, False: 0]
  ------------------
 1093|      0|				log_debug("%s: ignoring AUTHENTICATION_FAILED"
 1094|      0|				    " from unauthenticated initiator",
 1095|      0|				    __func__);
 1096|      0|				return (-1);
 1097|      0|			}
 1098|      0|		} else {
 1099|      0|			if (sa_stateok(sa, IKEV2_STATE_VALID)) {
  ------------------
  |  |   41|      0|#define IKEV2_STATE_VALID		7	/* authenticated AND validated certs */
  ------------------
  |  Branch (1099:8): [True: 0, False: 0]
  ------------------
 1100|      0|				log_debug("%s: ignoring AUTHENTICATION_FAILED"
 1101|      0|				    " from authenticated responder",
 1102|      0|				    __func__);
 1103|      0|				return (-1);
 1104|      0|			}
 1105|      0|		}
 1106|      0|		msg->msg_parent->msg_flags
 1107|      0|		    |= IKED_MSG_FLAGS_AUTHENTICATION_FAILED;
  ------------------
  |  |  656|      0|#define IKED_MSG_FLAGS_AUTHENTICATION_FAILED		0x0020
  ------------------
 1108|      0|		break;
 1109|      0|	case IKEV2_N_INVALID_KE_PAYLOAD:
  ------------------
  |  |  313|      0|#define IKEV2_N_INVALID_KE_PAYLOAD		17	/* RFC7296 */
  ------------------
  |  Branch (1109:2): [True: 0, False: 0]
  ------------------
 1110|      0|		if (sa_stateok(sa, IKEV2_STATE_VALID) &&
  ------------------
  |  |   41|      0|#define IKEV2_STATE_VALID		7	/* authenticated AND validated certs */
  ------------------
  |  Branch (1110:7): [True: 0, False: 0]
  ------------------
 1111|      0|		    !msg->msg_e) {
  ------------------
  |  Branch (1111:7): [True: 0, False: 0]
  ------------------
 1112|      0|			log_debug("%s: INVALID_KE_PAYLOAD not encrypted",
 1113|      0|			    __func__);
 1114|      0|			return (-1);
 1115|      0|		}
 1116|      0|		if (left != sizeof(msg->msg_parent->msg_group)) {
  ------------------
  |  Branch (1116:7): [True: 0, False: 0]
  ------------------
 1117|      0|			log_debug("%s: malformed payload: group size mismatch"
 1118|      0|			    " (%zu != %zu)", __func__, left,
 1119|      0|			    sizeof(msg->msg_parent->msg_group));
 1120|      0|			return (-1);
 1121|      0|		}
 1122|      0|		memcpy(&msg->msg_parent->msg_group, buf, left);
 1123|      0|		msg->msg_parent->msg_flags |= IKED_MSG_FLAGS_INVALID_KE;
  ------------------
  |  |  657|      0|#define IKED_MSG_FLAGS_INVALID_KE			0x0040
  ------------------
 1124|      0|		break;
 1125|      0|	case IKEV2_N_NO_ADDITIONAL_SAS:
  ------------------
  |  |  316|      0|#define IKEV2_N_NO_ADDITIONAL_SAS		35	/* RFC7296 */
  ------------------
  |  Branch (1125:2): [True: 0, False: 0]
  ------------------
 1126|      0|		if (!msg->msg_e) {
  ------------------
  |  Branch (1126:7): [True: 0, False: 0]
  ------------------
 1127|      0|			log_debug("%s: NO_ADDITIONAL_SAS not encrypted",
 1128|      0|			    __func__);
 1129|      0|			return (-1);
 1130|      0|		}
 1131|      0|		msg->msg_parent->msg_flags |= IKED_MSG_FLAGS_NO_ADDITIONAL_SAS;
  ------------------
  |  |  655|      0|#define IKED_MSG_FLAGS_NO_ADDITIONAL_SAS		0x0010
  ------------------
 1132|      0|		break;
 1133|      0|	case IKEV2_N_REKEY_SA:
  ------------------
  |  |  335|      0|#define IKEV2_N_REKEY_SA			16393	/* RFC7296 */
  ------------------
  |  Branch (1133:2): [True: 0, False: 0]
  ------------------
 1134|      0|		if (!msg->msg_e) {
  ------------------
  |  Branch (1134:7): [True: 0, False: 0]
  ------------------
 1135|      0|			log_debug("%s: N_REKEY_SA not encrypted", __func__);
 1136|      0|			return (-1);
 1137|      0|		}
 1138|      0|		if (left != n.n_spisize) {
  ------------------
  |  Branch (1138:7): [True: 0, False: 0]
  ------------------
 1139|      0|			log_debug("%s: malformed notification", __func__);
 1140|      0|			return (-1);
 1141|      0|		}
 1142|      0|		rekey = &msg->msg_parent->msg_rekey;
 1143|      0|		if (rekey->spi != 0) {
  ------------------
  |  Branch (1143:7): [True: 0, False: 0]
  ------------------
 1144|      0|			log_debug("%s: rekeying of multiple SAs not supported",
 1145|      0|			    __func__);
 1146|      0|			return (-1);
 1147|      0|		}
 1148|      0|		switch (n.n_spisize) {
 1149|      0|		case 4:
  ------------------
  |  Branch (1149:3): [True: 0, False: 0]
  ------------------
 1150|      0|			memcpy(&spi32, buf, left);
 1151|      0|			rekey->spi = betoh32(spi32);
  ------------------
  |  |   43|      0|#define betoh32	be32toh
  ------------------
 1152|      0|			break;
 1153|      0|		case 8:
  ------------------
  |  Branch (1153:3): [True: 0, False: 0]
  ------------------
 1154|      0|			memcpy(&spi64, buf, left);
 1155|      0|			rekey->spi = betoh64(spi64);
  ------------------
  |  |   46|      0|#define betoh64	be64toh
  ------------------
 1156|      0|			break;
 1157|      0|		default:
  ------------------
  |  Branch (1157:3): [True: 0, False: 0]
  ------------------
 1158|      0|			log_debug("%s: invalid spi size %d", __func__,
 1159|      0|			    n.n_spisize);
 1160|      0|			return (-1);
 1161|      0|		}
 1162|      0|		rekey->spi_size = n.n_spisize;
 1163|      0|		rekey->spi_protoid = n.n_protoid;
 1164|       |
 1165|      0|		log_debug("%s: rekey %s spi %s", __func__,
 1166|      0|		    print_map(n.n_protoid, ikev2_saproto_map),
 1167|      0|		    print_spi(rekey->spi, n.n_spisize));
 1168|      0|		break;
 1169|      0|	case IKEV2_N_TEMPORARY_FAILURE:
  ------------------
  |  |  324|      0|#define IKEV2_N_TEMPORARY_FAILURE		43	/* RFC7296 */
  ------------------
  |  Branch (1169:2): [True: 0, False: 0]
  ------------------
 1170|      0|		if (!msg->msg_e) {
  ------------------
  |  Branch (1170:7): [True: 0, False: 0]
  ------------------
 1171|      0|			log_debug("%s: IKEV2_N_TEMPORARY_FAILURE not encrypted",
 1172|      0|			    __func__);
 1173|      0|			return (-1);
 1174|      0|		}
 1175|      0|		msg->msg_parent->msg_flags |= IKED_MSG_FLAGS_TEMPORARY_FAILURE;
  ------------------
  |  |  660|      0|#define IKED_MSG_FLAGS_TEMPORARY_FAILURE		0x0200
  ------------------
 1176|      0|		break;
 1177|      0|	case IKEV2_N_IPCOMP_SUPPORTED:
  ------------------
  |  |  329|      0|#define IKEV2_N_IPCOMP_SUPPORTED		16387	/* RFC7296 */
  ------------------
  |  Branch (1177:2): [True: 0, False: 0]
  ------------------
 1178|      0|		if (!msg->msg_e) {
  ------------------
  |  Branch (1178:7): [True: 0, False: 0]
  ------------------
 1179|      0|			log_debug("%s: N_IPCOMP_SUPPORTED not encrypted",
 1180|      0|			    __func__);
 1181|      0|			return (-1);
 1182|      0|		}
 1183|      0|		if (left < sizeof(msg->msg_parent->msg_cpi) +
  ------------------
  |  Branch (1183:7): [True: 0, False: 0]
  ------------------
 1184|      0|		    sizeof(msg->msg_parent->msg_transform)) {
 1185|      0|			log_debug("%s: ignoring malformed ipcomp notification",
 1186|      0|			    __func__);
 1187|      0|			return (0);
 1188|      0|		}
 1189|      0|		memcpy(&msg->msg_parent->msg_cpi, buf,
 1190|      0|		    sizeof(msg->msg_parent->msg_cpi));
 1191|      0|		memcpy(&msg->msg_parent->msg_transform,
 1192|      0|		    buf + sizeof(msg->msg_parent->msg_cpi),
 1193|      0|		    sizeof(msg->msg_parent->msg_transform));
 1194|       |
 1195|      0|		log_debug("%s: %s cpi 0x%x, transform %s, length %zu", __func__,
 1196|      0|		    msg->msg_parent->msg_response ? "res" : "req",
  ------------------
  |  Branch (1196:7): [True: 0, False: 0]
  ------------------
 1197|      0|		    betoh16(msg->msg_parent->msg_cpi),
  ------------------
  |  |   40|      0|#define betoh16	be16toh
  ------------------
 1198|      0|		    print_map(msg->msg_parent->msg_transform,
 1199|      0|		    ikev2_ipcomp_map), left);
 1200|       |
 1201|      0|		msg->msg_parent->msg_flags |= IKED_MSG_FLAGS_IPCOMP_SUPPORTED;
  ------------------
  |  |  658|      0|#define IKED_MSG_FLAGS_IPCOMP_SUPPORTED			0x0080
  ------------------
 1202|      0|		break;
 1203|      0|	case IKEV2_N_CHILD_SA_NOT_FOUND:
  ------------------
  |  |  325|      0|#define IKEV2_N_CHILD_SA_NOT_FOUND		44	/* RFC7296 */
  ------------------
  |  Branch (1203:2): [True: 0, False: 0]
  ------------------
 1204|      0|		if (!msg->msg_e) {
  ------------------
  |  Branch (1204:7): [True: 0, False: 0]
  ------------------
 1205|      0|			log_debug("%s: N_CHILD_SA_NOT_FOUND not encrypted",
 1206|      0|			    __func__);
 1207|      0|			return (-1);
 1208|      0|		}
 1209|      0|		msg->msg_parent->msg_flags |= IKED_MSG_FLAGS_CHILD_SA_NOT_FOUND;
  ------------------
  |  |  654|      0|#define IKED_MSG_FLAGS_CHILD_SA_NOT_FOUND		0x0008
  ------------------
 1210|      0|		break;
 1211|      0|	case IKEV2_N_NO_PROPOSAL_CHOSEN:
  ------------------
  |  |  312|      0|#define IKEV2_N_NO_PROPOSAL_CHOSEN		14	/* RFC7296 */
  ------------------
  |  Branch (1211:2): [True: 0, False: 0]
  ------------------
 1212|      0|		msg->msg_parent->msg_flags |= IKED_MSG_FLAGS_NO_PROPOSAL_CHOSEN;
  ------------------
  |  |  661|      0|#define IKED_MSG_FLAGS_NO_PROPOSAL_CHOSEN		0x0400
  ------------------
 1213|      0|		break;
 1214|      0|	case IKEV2_N_MOBIKE_SUPPORTED:
  ------------------
  |  |  338|      0|#define IKEV2_N_MOBIKE_SUPPORTED		16396	/* RFC4555 */
  ------------------
  |  Branch (1214:2): [True: 0, False: 0]
  ------------------
 1215|      0|		if (!msg->msg_e) {
  ------------------
  |  Branch (1215:7): [True: 0, False: 0]
  ------------------
 1216|      0|			log_debug("%s: N_MOBIKE_SUPPORTED not encrypted",
 1217|      0|			    __func__);
 1218|      0|			return (-1);
 1219|      0|		}
 1220|      0|		if (left != 0) {
  ------------------
  |  Branch (1220:7): [True: 0, False: 0]
  ------------------
 1221|      0|			log_debug("%s: ignoring malformed mobike"
 1222|      0|			    " notification: %zu", __func__, left);
 1223|      0|			return (0);
 1224|      0|		}
 1225|      0|		msg->msg_parent->msg_flags |= IKED_MSG_FLAGS_MOBIKE;
  ------------------
  |  |  652|      0|#define IKED_MSG_FLAGS_MOBIKE				0x0002
  ------------------
 1226|      0|		break;
 1227|      0|	case IKEV2_N_USE_TRANSPORT_MODE:
  ------------------
  |  |  333|      0|#define IKEV2_N_USE_TRANSPORT_MODE		16391	/* RFC7296 */
  ------------------
  |  Branch (1227:2): [True: 0, False: 0]
  ------------------
 1228|      0|		if (!msg->msg_e) {
  ------------------
  |  Branch (1228:7): [True: 0, False: 0]
  ------------------
 1229|      0|			log_debug("%s: N_USE_TRANSPORT_MODE not encrypted",
 1230|      0|			    __func__);
 1231|      0|			return (-1);
 1232|      0|		}
 1233|      0|		if (left != 0) {
  ------------------
  |  Branch (1233:7): [True: 0, False: 0]
  ------------------
 1234|      0|			log_debug("%s: ignoring malformed transport mode"
 1235|      0|			    " notification: %zu", __func__, left);
 1236|      0|			return (0);
 1237|      0|		}
 1238|      0|		if (msg->msg_parent->msg_response) {
  ------------------
  |  Branch (1238:7): [True: 0, False: 0]
  ------------------
 1239|      0|			if (!(msg->msg_policy->pol_flags & IKED_POLICY_TRANSPORT)) {
  ------------------
  |  |  266|      0|#define IKED_POLICY_TRANSPORT		 0x40
  ------------------
  |  Branch (1239:8): [True: 0, False: 0]
  ------------------
 1240|      0|				log_debug("%s: ignoring transport mode"
 1241|      0|				    " notification (policy)", __func__);
 1242|      0|				return (0);
 1243|      0|			}
 1244|      0|		}
 1245|      0|		msg->msg_parent->msg_flags |= IKED_MSG_FLAGS_USE_TRANSPORT;
  ------------------
  |  |  659|      0|#define IKED_MSG_FLAGS_USE_TRANSPORT			0x0100
  ------------------
 1246|      0|		break;
 1247|      0|	case IKEV2_N_UPDATE_SA_ADDRESSES:
  ------------------
  |  |  342|      0|#define IKEV2_N_UPDATE_SA_ADDRESSES		16400	/* RFC4555 */
  ------------------
  |  Branch (1247:2): [True: 0, False: 0]
  ------------------
 1248|      0|		if (!msg->msg_e) {
  ------------------
  |  Branch (1248:7): [True: 0, False: 0]
  ------------------
 1249|      0|			log_debug("%s: N_UPDATE_SA_ADDRESSES not encrypted",
 1250|      0|			    __func__);
 1251|      0|			return (-1);
 1252|      0|		}
 1253|      0|		if (!sa->sa_mobike) {
  ------------------
  |  Branch (1253:7): [True: 0, False: 0]
  ------------------
 1254|      0|			log_debug("%s: ignoring update sa addresses"
 1255|      0|			    " notification w/o mobike: %zu", __func__, left);
 1256|      0|			return (0);
 1257|      0|		}
 1258|      0|		if (left != 0) {
  ------------------
  |  Branch (1258:7): [True: 0, False: 0]
  ------------------
 1259|      0|			log_debug("%s: ignoring malformed update sa addresses"
 1260|      0|			    " notification: %zu", __func__, left);
 1261|      0|			return (0);
 1262|      0|		}
 1263|      0|		msg->msg_parent->msg_update_sa_addresses = 1;
 1264|      0|		break;
 1265|      0|	case IKEV2_N_COOKIE2:
  ------------------
  |  |  343|      0|#define IKEV2_N_COOKIE2				16401	/* RFC4555 */
  ------------------
  |  Branch (1265:2): [True: 0, False: 0]
  ------------------
 1266|      0|		if (!msg->msg_e) {
  ------------------
  |  Branch (1266:7): [True: 0, False: 0]
  ------------------
 1267|      0|			log_debug("%s: N_COOKIE2 not encrypted",
 1268|      0|			    __func__);
 1269|      0|			return (-1);
 1270|      0|		}
 1271|      0|		if (!sa->sa_mobike) {
  ------------------
  |  Branch (1271:7): [True: 0, False: 0]
  ------------------
 1272|      0|			log_debug("%s: ignoring cookie2 notification"
 1273|      0|			    " w/o mobike: %zu", __func__, left);
 1274|      0|			return (0);
 1275|      0|		}
 1276|      0|		if (left < IKED_COOKIE2_MIN || left > IKED_COOKIE2_MAX) {
  ------------------
  |  |   59|      0|#define IKED_COOKIE2_MIN	8	/* min 8 bytes */
  ------------------
              		if (left < IKED_COOKIE2_MIN || left > IKED_COOKIE2_MAX) {
  ------------------
  |  |   60|      0|#define IKED_COOKIE2_MAX	64	/* max 64 bytes */
  ------------------
  |  Branch (1276:7): [True: 0, False: 0]
  |  Branch (1276:34): [True: 0, False: 0]
  ------------------
 1277|      0|			log_debug("%s: ignoring malformed cookie2"
 1278|      0|			    " notification: %zu", __func__, left);
 1279|      0|			return (0);
 1280|      0|		}
 1281|      0|		ibuf_release(msg->msg_cookie2);	/* should not happen */
 1282|      0|		if ((msg->msg_cookie2 = ibuf_new(buf, left)) == NULL) {
  ------------------
  |  Branch (1282:7): [True: 0, False: 0]
  ------------------
 1283|      0|			log_debug("%s: failed to get peer cookie2", __func__);
 1284|      0|			return (-1);
 1285|      0|		}
 1286|      0|		msg->msg_parent->msg_cookie2 = msg->msg_cookie2;
 1287|      0|		break;
 1288|      0|	case IKEV2_N_COOKIE:
  ------------------
  |  |  332|      0|#define IKEV2_N_COOKIE				16390	/* RFC7296 */
  ------------------
  |  Branch (1288:2): [True: 0, False: 0]
  ------------------
 1289|      0|		if (msg->msg_e) {
  ------------------
  |  Branch (1289:7): [True: 0, False: 0]
  ------------------
 1290|      0|			log_debug("%s: N_COOKIE encrypted",
 1291|      0|			    __func__);
 1292|      0|			return (-1);
 1293|      0|		}
 1294|      0|		if (left < IKED_COOKIE_MIN || left > IKED_COOKIE_MAX) {
  ------------------
  |  |   56|      0|#define IKED_COOKIE_MIN		1	/* min 1 bytes */
  ------------------
              		if (left < IKED_COOKIE_MIN || left > IKED_COOKIE_MAX) {
  ------------------
  |  |   57|      0|#define IKED_COOKIE_MAX		64	/* max 64 bytes */
  ------------------
  |  Branch (1294:7): [True: 0, False: 0]
  |  Branch (1294:33): [True: 0, False: 0]
  ------------------
 1295|      0|			log_debug("%s: ignoring malformed cookie"
 1296|      0|			    " notification: %zu", __func__, left);
 1297|      0|			return (0);
 1298|      0|		}
 1299|      0|		log_debug("%s: received cookie, len %zu", __func__, left);
 1300|      0|		print_hex(buf, 0, left);
 1301|       |
 1302|      0|		ibuf_release(msg->msg_cookie);
 1303|      0|		if ((msg->msg_cookie = ibuf_new(buf, left)) == NULL) {
  ------------------
  |  Branch (1303:7): [True: 0, False: 0]
  ------------------
 1304|      0|			log_debug("%s: failed to get peer cookie", __func__);
 1305|      0|			return (-1);
 1306|      0|		}
 1307|      0|		msg->msg_parent->msg_cookie = msg->msg_cookie;
 1308|      0|		break;
 1309|      0|	case IKEV2_N_FRAGMENTATION_SUPPORTED:
  ------------------
  |  |  371|      0|#define IKEV2_N_FRAGMENTATION_SUPPORTED		16430	/* RFC7383 */
  ------------------
  |  Branch (1309:2): [True: 0, False: 0]
  ------------------
 1310|      0|		if (msg->msg_e) {
  ------------------
  |  Branch (1310:7): [True: 0, False: 0]
  ------------------
 1311|      0|			log_debug("%s: N_FRAGMENTATION_SUPPORTED encrypted",
 1312|      0|			    __func__);
 1313|      0|			return (-1);
 1314|      0|		}
 1315|      0|		if (left != 0) {
  ------------------
  |  Branch (1315:7): [True: 0, False: 0]
  ------------------
 1316|      0|			log_debug("%s: ignoring malformed fragmentation"
 1317|      0|			    " notification: %zu", __func__, left);
 1318|      0|			return (0);
 1319|      0|		}
 1320|      0|		msg->msg_parent->msg_flags |= IKED_MSG_FLAGS_FRAGMENTATION;
  ------------------
  |  |  651|      0|#define IKED_MSG_FLAGS_FRAGMENTATION			0x0001
  ------------------
 1321|      0|		break;
 1322|      0|	case IKEV2_N_SIGNATURE_HASH_ALGORITHMS:
  ------------------
  |  |  372|      0|#define IKEV2_N_SIGNATURE_HASH_ALGORITHMS	16431	/* RFC7427 */
  ------------------
  |  Branch (1322:2): [True: 0, False: 0]
  ------------------
 1323|      0|		if (msg->msg_e) {
  ------------------
  |  Branch (1323:7): [True: 0, False: 0]
  ------------------
 1324|      0|			log_debug("%s: SIGNATURE_HASH_ALGORITHMS: encrypted",
 1325|      0|			    __func__);
 1326|      0|			return (-1);
 1327|      0|		}
 1328|      0|		if (sa == NULL) {
  ------------------
  |  Branch (1328:7): [True: 0, False: 0]
  ------------------
 1329|      0|			log_debug("%s: SIGNATURE_HASH_ALGORITHMS: no SA",
 1330|      0|			    __func__);
 1331|      0|			return (-1);
 1332|      0|		}
 1333|      0|		if (sa->sa_sigsha2) {
  ------------------
  |  Branch (1333:7): [True: 0, False: 0]
  ------------------
 1334|      0|			log_debug("%s: SIGNATURE_HASH_ALGORITHMS: "
 1335|      0|			    "duplicate notify", __func__);
 1336|      0|			return (0);
 1337|      0|		}
 1338|      0|		if (left < sizeof(signature_hash) ||
  ------------------
  |  Branch (1338:7): [True: 0, False: 0]
  ------------------
 1339|      0|		    left % sizeof(signature_hash)) {
  ------------------
  |  Branch (1339:7): [True: 0, False: 0]
  ------------------
 1340|      0|			log_debug("%s: malformed signature hash notification"
 1341|      0|			    "(%zu bytes)", __func__, left);
 1342|      0|			return (0);
 1343|      0|		}
 1344|      0|		while (left >= sizeof(signature_hash)) {
  ------------------
  |  Branch (1344:10): [True: 0, False: 0]
  ------------------
 1345|      0|			memcpy(&signature_hash, buf, sizeof(signature_hash));
 1346|      0|			signature_hash = betoh16(signature_hash);
  ------------------
  |  |   40|      0|#define betoh16	be16toh
  ------------------
 1347|      0|			log_debug("%s: signature hash %s (%x)", __func__,
 1348|      0|			    print_map(signature_hash, ikev2_sighash_map),
 1349|      0|			    signature_hash);
 1350|      0|			left -= sizeof(signature_hash);
 1351|      0|			buf += sizeof(signature_hash);
 1352|      0|			if (signature_hash == IKEV2_SIGHASH_SHA2_256)
  ------------------
  |  |  498|      0|#define IKEV2_SIGHASH_SHA2_256		2	/* RFC7427 */
  ------------------
  |  Branch (1352:8): [True: 0, False: 0]
  ------------------
 1353|      0|				msg->msg_parent->msg_flags
 1354|      0|				    |= IKED_MSG_FLAGS_SIGSHA2;
  ------------------
  |  |  653|      0|#define IKED_MSG_FLAGS_SIGSHA2				0x0004
  ------------------
 1355|      0|		}
 1356|      0|		break;
 1357|      0|	}
 1358|       |
 1359|      0|	return (0);
 1360|      0|}
ikev2_validate_delete:
 1365|  2.24k|{
 1366|  2.24k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
 1367|       |
 1368|  2.24k|	if (left < sizeof(*del)) {
  ------------------
  |  Branch (1368:6): [True: 287, False: 1.95k]
  ------------------
 1369|    287|		log_debug("%s: malformed payload: too short for header "
 1370|    287|		    "(%zu < %zu)", __func__, left, sizeof(*del));
 1371|    287|		return (-1);
 1372|    287|	}
 1373|  1.95k|	memcpy(del, msgbuf + offset, sizeof(*del));
 1374|       |
 1375|  1.95k|	if (del->del_protoid == 0) {
  ------------------
  |  Branch (1375:6): [True: 48, False: 1.90k]
  ------------------
 1376|     48|		log_info("%s: malformed payload: invalid protoid", __func__);
 1377|     48|		return (-1);
 1378|     48|	}
 1379|       |
 1380|  1.90k|	return (0);
 1381|  1.95k|}
ikev2_pld_delete:
 1386|  2.24k|{
 1387|  2.24k|	struct ikev2_delete	 del;
 1388|  2.24k|	uint8_t			*buf, *msgbuf = ibuf_data(msg->msg_data);
 1389|  2.24k|	size_t			 cnt, sz, len;
 1390|       |
 1391|  2.24k|	if (ikev2_validate_delete(msg, offset, left, &del))
  ------------------
  |  Branch (1391:6): [True: 335, False: 1.90k]
  ------------------
 1392|    335|		return (-1);
 1393|       |
 1394|       |	/* Skip if it's a response, then we don't have to deal with it */
 1395|  1.90k|	if (ikev2_msg_frompeer(msg) &&
  ------------------
  |  Branch (1395:6): [True: 0, False: 1.90k]
  ------------------
 1396|  1.90k|	    msg->msg_parent->msg_response)
  ------------------
  |  Branch (1396:6): [True: 0, False: 0]
  ------------------
 1397|      0|		return (0);
 1398|       |
 1399|  1.90k|	cnt = betoh16(del.del_nspi);
  ------------------
  |  |   40|  1.90k|#define betoh16	be16toh
  ------------------
 1400|  1.90k|	sz = del.del_spisize;
 1401|       |
 1402|  1.90k|	log_debug("%s: proto %s spisize %zu nspi %zu",
 1403|  1.90k|	    __func__, print_map(del.del_protoid, ikev2_saproto_map),
 1404|  1.90k|	    sz, cnt);
 1405|       |
 1406|  1.90k|	if (msg->msg_parent->msg_del_protoid) {
  ------------------
  |  Branch (1406:6): [True: 1.80k, False: 107]
  ------------------
 1407|  1.80k|		log_debug("%s: duplicate delete payload", __func__);
 1408|  1.80k|		return (0);
 1409|  1.80k|	}
 1410|       |
 1411|    107|	msg->msg_parent->msg_del_protoid = del.del_protoid;
 1412|    107|	msg->msg_parent->msg_del_cnt = cnt;
 1413|    107|	msg->msg_parent->msg_del_spisize = sz;
 1414|       |
 1415|    107|	buf = msgbuf + offset + sizeof(del);
 1416|    107|	len = left - sizeof(del);
 1417|    107|	if (len == 0 || sz == 0 || cnt == 0)
  ------------------
  |  Branch (1417:6): [True: 2, False: 105]
  |  Branch (1417:18): [True: 91, False: 14]
  |  Branch (1417:29): [True: 3, False: 11]
  ------------------
 1418|     96|		return (0);
 1419|       |
 1420|     11|	if ((len / sz) != cnt) {
  ------------------
  |  Branch (1420:6): [True: 10, False: 1]
  ------------------
 1421|     10|		log_debug("%s: invalid payload length %zu/%zu != %zu",
 1422|     10|		    __func__, len, sz, cnt);
 1423|     10|		return (-1);
 1424|     10|	}
 1425|       |
 1426|      1|	print_hex(buf, 0, len);
 1427|       |
 1428|      1|	msg->msg_parent->msg_del_buf = ibuf_new(buf, len);
 1429|       |
 1430|      1|	return (0);
 1431|     11|}
ikev2_validate_tss:
 1436|  6.58k|{
 1437|  6.58k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
 1438|       |
 1439|  6.58k|	if (left < sizeof(*tsp)) {
  ------------------
  |  Branch (1439:6): [True: 740, False: 5.84k]
  ------------------
 1440|    740|		log_debug("%s: malformed payload: too short for header "
 1441|    740|		    "(%zu < %zu)", __func__, left, sizeof(*tsp));
 1442|    740|		return (-1);
 1443|    740|	}
 1444|  5.84k|	memcpy(tsp, msgbuf + offset, sizeof(*tsp));
 1445|       |
 1446|  5.84k|	return (0);
 1447|  6.58k|}
ikev2_pld_tss:
 1452|  6.58k|{
 1453|  6.58k|	struct ikev2_tsp		 tsp;
 1454|  6.58k|	struct ikev2_ts			 ts;
 1455|  6.58k|	size_t				 ts_len, i;
 1456|       |
 1457|  6.58k|	if (ikev2_validate_tss(msg, offset, left, &tsp))
  ------------------
  |  Branch (1457:6): [True: 740, False: 5.84k]
  ------------------
 1458|    740|		return (-1);
 1459|       |
 1460|  5.84k|	offset += sizeof(tsp);
 1461|  5.84k|	left -= sizeof(tsp);
 1462|       |
 1463|  5.84k|	log_debug("%s: count %d length %zu", __func__,
 1464|  5.84k|	    tsp.tsp_count, left);
 1465|       |
 1466|  9.26k|	for (i = 0; i < tsp.tsp_count; i++) {
  ------------------
  |  Branch (1466:14): [True: 9.22k, False: 40]
  ------------------
 1467|  9.22k|		if (ikev2_validate_ts(msg, offset, left, &ts))
  ------------------
  |  Branch (1467:7): [True: 5.33k, False: 3.89k]
  ------------------
 1468|  5.33k|			return (-1);
 1469|       |
 1470|  3.89k|		log_debug("%s: type %s protoid %u length %d "
 1471|  3.89k|		    "startport %u endport %u", __func__,
 1472|  3.89k|		    print_map(ts.ts_type, ikev2_ts_map),
 1473|  3.89k|		    ts.ts_protoid, betoh16(ts.ts_length),
  ------------------
  |  |   40|  3.89k|#define betoh16	be16toh
  ------------------
 1474|  3.89k|		    betoh16(ts.ts_startport),
  ------------------
  |  |   40|  3.89k|#define betoh16	be16toh
  ------------------
 1475|  3.89k|		    betoh16(ts.ts_endport));
  ------------------
  |  |   40|  3.89k|#define betoh16	be16toh
  ------------------
 1476|       |
 1477|  3.89k|		offset += sizeof(ts);
 1478|  3.89k|		left -= sizeof(ts);
 1479|       |
 1480|  3.89k|		ts_len = betoh16(ts.ts_length) - sizeof(ts);
  ------------------
  |  |   40|  3.89k|#define betoh16	be16toh
  ------------------
 1481|  3.89k|		if (ikev2_pld_ts(env, pld, msg, offset, ts_len, ts.ts_type))
  ------------------
  |  Branch (1481:7): [True: 471, False: 3.42k]
  ------------------
 1482|    471|			return (-1);
 1483|       |
 1484|  3.42k|		offset += ts_len;
 1485|  3.42k|		left -= ts_len;
 1486|  3.42k|	}
 1487|       |
 1488|     40|	return (0);
 1489|  5.84k|}
ikev2_validate_ts:
 1494|  9.22k|{
 1495|  9.22k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
 1496|  9.22k|	size_t		 ts_length;
 1497|       |
 1498|  9.22k|	if (left < sizeof(*ts)) {
  ------------------
  |  Branch (1498:6): [True: 4.73k, False: 4.49k]
  ------------------
 1499|  4.73k|		log_debug("%s: malformed payload: too short for header "
 1500|  4.73k|		    "(%zu < %zu)", __func__, left, sizeof(*ts));
 1501|  4.73k|		return (-1);
 1502|  4.73k|	}
 1503|  4.49k|	memcpy(ts, msgbuf + offset, sizeof(*ts));
 1504|       |
 1505|  4.49k|	ts_length = betoh16(ts->ts_length);
  ------------------
  |  |   40|  4.49k|#define betoh16	be16toh
  ------------------
 1506|  4.49k|	if (ts_length < sizeof(*ts)) {
  ------------------
  |  Branch (1506:6): [True: 393, False: 4.10k]
  ------------------
 1507|    393|		log_debug("%s: malformed payload: shorter than minimum header "
 1508|    393|		    "size (%zu < %zu)", __func__, ts_length, sizeof(*ts));
 1509|    393|		return (-1);
 1510|    393|	}
 1511|  4.10k|	if (left < ts_length) {
  ------------------
  |  Branch (1511:6): [True: 211, False: 3.89k]
  ------------------
 1512|    211|		log_debug("%s: malformed payload: too long for payload size "
 1513|    211|		    "(%zu < %zu)", __func__, left, ts_length);
 1514|    211|		return (-1);
 1515|    211|	}
 1516|       |
 1517|  3.89k|	return (0);
 1518|  4.10k|}
ikev2_pld_ts:
 1523|  3.89k|{
 1524|  3.89k|	struct sockaddr_in		 s4;
 1525|  3.89k|	struct sockaddr_in6		 s6;
 1526|  3.89k|	uint8_t				 buf[2][128];
 1527|  3.89k|	uint8_t				*ptr;
 1528|       |
 1529|  3.89k|	ptr = ibuf_data(msg->msg_data) + offset;
 1530|       |
 1531|  3.89k|	switch (type) {
 1532|    126|	case IKEV2_TS_IPV4_ADDR_RANGE:
  ------------------
  |  |  459|    126|#define IKEV2_TS_IPV4_ADDR_RANGE	7	/* RFC7296 */
  ------------------
  |  Branch (1532:2): [True: 126, False: 3.76k]
  ------------------
 1533|    126|		if (left < 2 * 4) {
  ------------------
  |  Branch (1533:7): [True: 50, False: 76]
  ------------------
 1534|     50|			log_debug("%s: malformed payload: too short "
 1535|     50|			    "for ipv4 addr range (%zu < %u)",
 1536|     50|			    __func__, left, 2 * 4);
 1537|     50|			return (-1);
 1538|     50|		}
 1539|       |
 1540|     76|		bzero(&s4, sizeof(s4));
 1541|     76|		s4.sin_family = AF_INET;
 1542|       |#ifdef HAVE_SOCKADDR_SA_LEN
 1543|       |		s4.sin_len = sizeof(s4);
 1544|       |#endif
 1545|     76|		memcpy(&s4.sin_addr.s_addr, ptr, 4);
 1546|     76|		ptr += 4;
 1547|     76|		left -= 4;
 1548|     76|		print_host((struct sockaddr *)&s4,
 1549|     76|		    (char *)buf[0], sizeof(buf[0]));
 1550|       |
 1551|     76|		memcpy(&s4.sin_addr.s_addr, ptr, 4);
 1552|     76|		left -= 4;
 1553|     76|		print_host((struct sockaddr *)&s4,
 1554|     76|		    (char *)buf[1], sizeof(buf[1]));
 1555|       |
 1556|     76|		log_debug("%s: start %s end %s", __func__,
 1557|     76|		    buf[0], buf[1]);
 1558|     76|		break;
 1559|    411|	case IKEV2_TS_IPV6_ADDR_RANGE:
  ------------------
  |  |  460|    411|#define IKEV2_TS_IPV6_ADDR_RANGE	8	/* RFC7296 */
  ------------------
  |  Branch (1559:2): [True: 411, False: 3.48k]
  ------------------
 1560|    411|		if (left < 2 * 16) {
  ------------------
  |  Branch (1560:7): [True: 26, False: 385]
  ------------------
 1561|     26|			log_debug("%s: malformed payload: too short "
 1562|     26|			    "for ipv6 addr range (%zu < %u)",
 1563|     26|			    __func__, left, 2 * 16);
 1564|     26|			return (-1);
 1565|     26|		}
 1566|    385|		bzero(&s6, sizeof(s6));
 1567|    385|		s6.sin6_family = AF_INET6;
 1568|       |#ifdef HAVE_SOCKADDR_SA_LEN
 1569|       |		s6.sin6_len = sizeof(s6);
 1570|       |#endif
 1571|    385|		memcpy(&s6.sin6_addr, ptr, 16);
 1572|    385|		ptr += 16;
 1573|    385|		left -= 16;
 1574|    385|		print_host((struct sockaddr *)&s6,
 1575|    385|		    (char *)buf[0], sizeof(buf[0]));
 1576|       |
 1577|    385|		memcpy(&s6.sin6_addr, ptr, 16);
 1578|    385|		left -= 16;
 1579|    385|		print_host((struct sockaddr *)&s6,
 1580|    385|		    (char *)buf[1], sizeof(buf[1]));
 1581|    385|		log_debug("%s: start %s end %s", __func__,
 1582|    385|		    buf[0], buf[1]);
 1583|    385|		break;
 1584|  3.35k|	default:
  ------------------
  |  Branch (1584:2): [True: 3.35k, False: 537]
  ------------------
 1585|  3.35k|		log_debug("%s: ignoring unknown TS type %u", __func__, type);
 1586|  3.35k|		return (0);
 1587|  3.89k|	}
 1588|       |
 1589|    461|	if (left > 0) {
  ------------------
  |  Branch (1589:6): [True: 395, False: 66]
  ------------------
 1590|    395|		log_debug("%s: malformed payload: left (%zu) > 0",
 1591|    395|		    __func__, left);
 1592|    395|		return (-1);
 1593|    395|	}
 1594|       |
 1595|     66|	return (0);
 1596|    461|}
ikev2_validate_cp:
 1837|  7.04k|{
 1838|  7.04k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
 1839|       |
 1840|  7.04k|	if (left < sizeof(*cp)) {
  ------------------
  |  Branch (1840:6): [True: 1.86k, False: 5.18k]
  ------------------
 1841|  1.86k|		log_debug("%s: malformed payload: too short for header "
 1842|  1.86k|		    "(%zu < %zu)", __func__, left, sizeof(*cp));
 1843|  1.86k|		return (-1);
 1844|  1.86k|	}
 1845|  5.18k|	memcpy(cp, msgbuf + offset, sizeof(*cp));
 1846|       |
 1847|  5.18k|	return (0);
 1848|  7.04k|}
ikev2_pld_cp:
 1853|  7.04k|{
 1854|  7.04k|	struct ikev2_cp		 cp;
 1855|  7.04k|	struct ikev2_cfg	*cfg;
 1856|  7.04k|	struct iked_addr	*addr;
 1857|  7.04k|	struct sockaddr_in	*in4;
 1858|  7.04k|	struct sockaddr_in6	*in6;
 1859|  7.04k|	uint8_t			*ptr;
 1860|  7.04k|	size_t			 len;
 1861|  7.04k|	uint8_t			 buf[128];
 1862|  7.04k|	int			 cfg_type;
 1863|       |
 1864|  7.04k|	if (ikev2_validate_cp(msg, offset, left, &cp))
  ------------------
  |  Branch (1864:6): [True: 1.86k, False: 5.18k]
  ------------------
 1865|  1.86k|		return (-1);
 1866|       |
 1867|  5.18k|	ptr = ibuf_data(msg->msg_data) + offset + sizeof(cp);
 1868|  5.18k|	len = left - sizeof(cp);
 1869|       |
 1870|  5.18k|	log_debug("%s: type %s length %zu",
 1871|  5.18k|	    __func__, print_map(cp.cp_type, ikev2_cp_map), len);
 1872|  5.18k|	print_hex(ptr, 0, len);
 1873|       |
 1874|  6.43k|	while (len > 0) {
  ------------------
  |  Branch (1874:9): [True: 1.79k, False: 4.64k]
  ------------------
 1875|  1.79k|		if (len < sizeof(*cfg)) {
  ------------------
  |  Branch (1875:7): [True: 368, False: 1.43k]
  ------------------
 1876|    368|			log_debug("%s: malformed payload: too short for cfg "
 1877|    368|			    "(%zu < %zu)", __func__, len, sizeof(*cfg));
 1878|    368|			return (-1);
 1879|    368|		}
 1880|  1.43k|		cfg = (struct ikev2_cfg *)ptr;
 1881|       |
 1882|  1.43k|		log_debug("%s: %s 0x%04x length %d", __func__,
 1883|  1.43k|		    print_map(betoh16(cfg->cfg_type), ikev2_cfg_map),
  ------------------
  |  |   40|  1.43k|#define betoh16	be16toh
  ------------------
 1884|  1.43k|		    betoh16(cfg->cfg_type),
  ------------------
  |  |   40|  1.43k|#define betoh16	be16toh
  ------------------
 1885|  1.43k|		    betoh16(cfg->cfg_length));
  ------------------
  |  |   40|  1.43k|#define betoh16	be16toh
  ------------------
 1886|       |
 1887|  1.43k|		ptr += sizeof(*cfg);
 1888|  1.43k|		len -= sizeof(*cfg);
 1889|       |
 1890|  1.43k|		if (len < betoh16(cfg->cfg_length)) {
  ------------------
  |  |   40|  1.43k|#define betoh16	be16toh
  ------------------
  |  Branch (1890:7): [True: 177, False: 1.25k]
  ------------------
 1891|    177|			log_debug("%s: malformed payload: too short for "
 1892|    177|			    "cfg_length (%zu < %u)", __func__, len,
 1893|    177|			    betoh16(cfg->cfg_length));
  ------------------
  |  |   40|    177|#define betoh16	be16toh
  ------------------
 1894|    177|			return (-1);
 1895|    177|		}
 1896|       |
 1897|  1.25k|		print_hex(ptr, sizeof(*cfg), betoh16(cfg->cfg_length));
  ------------------
  |  |   40|  1.25k|#define betoh16	be16toh
  ------------------
 1898|       |
 1899|  1.25k|		cfg_type = betoh16(cfg->cfg_type);
  ------------------
  |  |   40|  1.25k|#define betoh16	be16toh
  ------------------
 1900|  1.25k|		switch (cfg_type) {
  ------------------
  |  Branch (1900:11): [True: 848, False: 405]
  ------------------
 1901|    154|		case IKEV2_CFG_INTERNAL_IP4_ADDRESS:
  ------------------
  |  |  527|    154|#define IKEV2_CFG_INTERNAL_IP4_ADDRESS		1	/* RFC7296 */
  ------------------
  |  Branch (1901:3): [True: 154, False: 1.09k]
  ------------------
 1902|    282|		case IKEV2_CFG_INTERNAL_IP4_DNS:
  ------------------
  |  |  529|    282|#define IKEV2_CFG_INTERNAL_IP4_DNS		3	/* RFC7296 */
  ------------------
  |  Branch (1902:3): [True: 128, False: 1.12k]
  ------------------
 1903|    282|			if (!ikev2_msg_frompeer(msg))
  ------------------
  |  Branch (1903:8): [True: 282, False: 0]
  ------------------
 1904|    282|				break;
 1905|      0|			if (betoh16(cfg->cfg_length) == 0)
  ------------------
  |  |   40|      0|#define betoh16	be16toh
  ------------------
  |  Branch (1905:8): [True: 0, False: 0]
  ------------------
 1906|      0|				break;
 1907|       |			/* XXX multiple-valued */
 1908|      0|			if (betoh16(cfg->cfg_length) < 4) {
  ------------------
  |  |   40|      0|#define betoh16	be16toh
  ------------------
  |  Branch (1908:8): [True: 0, False: 0]
  ------------------
 1909|      0|				log_debug("%s: malformed payload: too short "
 1910|      0|				    "for ipv4 addr (%u < %u)",
 1911|      0|				    __func__, betoh16(cfg->cfg_length), 4);
  ------------------
  |  |   40|      0|#define betoh16	be16toh
  ------------------
 1912|      0|				return (-1);
 1913|      0|			}
 1914|      0|			switch(cfg_type) {
 1915|      0|			case IKEV2_CFG_INTERNAL_IP4_ADDRESS:
  ------------------
  |  |  527|      0|#define IKEV2_CFG_INTERNAL_IP4_ADDRESS		1	/* RFC7296 */
  ------------------
  |  Branch (1915:4): [True: 0, False: 0]
  ------------------
 1916|      0|				if (msg->msg_parent->msg_cp_addr != NULL) {
  ------------------
  |  Branch (1916:9): [True: 0, False: 0]
  ------------------
 1917|      0|					log_debug("%s: address already set", __func__);
 1918|      0|					goto skip;
 1919|      0|				}
 1920|      0|				break;
 1921|      0|			case IKEV2_CFG_INTERNAL_IP4_DNS:
  ------------------
  |  |  529|      0|#define IKEV2_CFG_INTERNAL_IP4_DNS		3	/* RFC7296 */
  ------------------
  |  Branch (1921:4): [True: 0, False: 0]
  ------------------
 1922|      0|				if (msg->msg_parent->msg_cp_dns != NULL) {
  ------------------
  |  Branch (1922:9): [True: 0, False: 0]
  ------------------
 1923|      0|					log_debug("%s: dns already set", __func__);
 1924|      0|					goto skip;
 1925|      0|				}
 1926|      0|				break;
 1927|      0|			default:
  ------------------
  |  Branch (1927:4): [True: 0, False: 0]
  ------------------
 1928|      0|				break;
 1929|      0|			}
 1930|      0|			if ((addr = calloc(1, sizeof(*addr))) == NULL) {
  ------------------
  |  Branch (1930:8): [True: 0, False: 0]
  ------------------
 1931|      0|				log_debug("%s: malloc failed", __func__);
 1932|      0|				break;
 1933|      0|			}
 1934|      0|			addr->addr_af = AF_INET;
 1935|      0|			in4 = (struct sockaddr_in *)&addr->addr;
 1936|      0|			in4->sin_family = AF_INET;
 1937|       |#ifdef HAVE_SOCKADDR_SA_LEN
 1938|       |			in4->sin_len = sizeof(*in4);
 1939|       |#endif
 1940|      0|			memcpy(&in4->sin_addr.s_addr, ptr, 4);
 1941|      0|			print_host((struct sockaddr *)in4, (char *)buf,
 1942|      0|			    sizeof(buf));
 1943|      0|			log_debug("%s: cfg %s", __func__, buf);
 1944|      0|			switch(cfg_type) {
  ------------------
  |  Branch (1944:11): [True: 0, False: 0]
  ------------------
 1945|      0|			case IKEV2_CFG_INTERNAL_IP4_ADDRESS:
  ------------------
  |  |  527|      0|#define IKEV2_CFG_INTERNAL_IP4_ADDRESS		1	/* RFC7296 */
  ------------------
  |  Branch (1945:4): [True: 0, False: 0]
  ------------------
 1946|      0|				msg->msg_parent->msg_cp_addr = addr;
 1947|      0|				log_debug("%s: IP4_ADDRESS %s", __func__, buf);
 1948|      0|				break;
 1949|      0|			case IKEV2_CFG_INTERNAL_IP4_DNS:
  ------------------
  |  |  529|      0|#define IKEV2_CFG_INTERNAL_IP4_DNS		3	/* RFC7296 */
  ------------------
  |  Branch (1949:4): [True: 0, False: 0]
  ------------------
 1950|      0|				msg->msg_parent->msg_cp_dns = addr;
 1951|      0|				log_debug("%s: IP4_DNS %s", __func__, buf);
 1952|      0|				break;
 1953|      0|			}
 1954|      0|			break;
 1955|     57|		case IKEV2_CFG_INTERNAL_IP6_ADDRESS:
  ------------------
  |  |  534|     57|#define IKEV2_CFG_INTERNAL_IP6_ADDRESS		8	/* RFC7296 */
  ------------------
  |  Branch (1955:3): [True: 57, False: 1.19k]
  ------------------
 1956|    123|		case IKEV2_CFG_INTERNAL_IP6_DNS:
  ------------------
  |  |  535|    123|#define IKEV2_CFG_INTERNAL_IP6_DNS		10	/* RFC7296 */
  ------------------
  |  Branch (1956:3): [True: 66, False: 1.18k]
  ------------------
 1957|    123|			if (!ikev2_msg_frompeer(msg))
  ------------------
  |  Branch (1957:8): [True: 123, False: 0]
  ------------------
 1958|    123|				break;
 1959|      0|			if (betoh16(cfg->cfg_length) == 0)
  ------------------
  |  |   40|      0|#define betoh16	be16toh
  ------------------
  |  Branch (1959:8): [True: 0, False: 0]
  ------------------
 1960|      0|				break;
 1961|       |			/* XXX multiple-valued */
 1962|      0|			if (betoh16(cfg->cfg_length) < 16) {
  ------------------
  |  |   40|      0|#define betoh16	be16toh
  ------------------
  |  Branch (1962:8): [True: 0, False: 0]
  ------------------
 1963|      0|				log_debug("%s: malformed payload: too short "
 1964|      0|				    "for ipv6 addr w/prefixlen (%u < %u)",
 1965|      0|				    __func__, betoh16(cfg->cfg_length), 16);
  ------------------
  |  |   40|      0|#define betoh16	be16toh
  ------------------
 1966|      0|				return (-1);
 1967|      0|			}
 1968|      0|			switch(cfg_type) {
  ------------------
  |  Branch (1968:11): [True: 0, False: 0]
  ------------------
 1969|      0|			case IKEV2_CFG_INTERNAL_IP6_ADDRESS:
  ------------------
  |  |  534|      0|#define IKEV2_CFG_INTERNAL_IP6_ADDRESS		8	/* RFC7296 */
  ------------------
  |  Branch (1969:4): [True: 0, False: 0]
  ------------------
 1970|      0|				if (msg->msg_parent->msg_cp_addr6 != NULL) {
  ------------------
  |  Branch (1970:9): [True: 0, False: 0]
  ------------------
 1971|      0|					log_debug("%s: address6 already set", __func__);
 1972|      0|					goto skip;
 1973|      0|				}
 1974|      0|				break;
 1975|      0|			case IKEV2_CFG_INTERNAL_IP6_DNS:
  ------------------
  |  |  535|      0|#define IKEV2_CFG_INTERNAL_IP6_DNS		10	/* RFC7296 */
  ------------------
  |  Branch (1975:4): [True: 0, False: 0]
  ------------------
 1976|      0|				if (msg->msg_parent->msg_cp_dns != NULL) {
  ------------------
  |  Branch (1976:9): [True: 0, False: 0]
  ------------------
 1977|      0|					log_debug("%s: dns already set", __func__);
 1978|      0|					goto skip;
 1979|      0|				}
 1980|      0|				break;
 1981|      0|			}
 1982|      0|			if ((addr = calloc(1, sizeof(*addr))) == NULL) {
  ------------------
  |  Branch (1982:8): [True: 0, False: 0]
  ------------------
 1983|      0|				log_debug("%s: malloc failed", __func__);
 1984|      0|				break;
 1985|      0|			}
 1986|      0|			addr->addr_af = AF_INET6;
 1987|      0|			in6 = (struct sockaddr_in6 *)&addr->addr;
 1988|      0|			in6->sin6_family = AF_INET6;
 1989|       |#ifdef HAVE_SOCKADDR_SA_LEN
 1990|       |			in6->sin6_len = sizeof(*in6);
 1991|       |#endif
 1992|      0|			memcpy(&in6->sin6_addr, ptr, 16);
 1993|      0|			print_host((struct sockaddr *)in6, (char *)buf,
 1994|      0|			    sizeof(buf));
 1995|      0|			log_debug("%s: cfg %s/%d", __func__, buf, ptr[16]);
 1996|      0|			switch(cfg_type) {
  ------------------
  |  Branch (1996:11): [True: 0, False: 0]
  ------------------
 1997|      0|			case IKEV2_CFG_INTERNAL_IP6_ADDRESS:
  ------------------
  |  |  534|      0|#define IKEV2_CFG_INTERNAL_IP6_ADDRESS		8	/* RFC7296 */
  ------------------
  |  Branch (1997:4): [True: 0, False: 0]
  ------------------
 1998|      0|				msg->msg_parent->msg_cp_addr6 = addr;
 1999|      0|				log_debug("%s: IP6_ADDRESS %s", __func__, buf);
 2000|      0|				break;
 2001|      0|			case IKEV2_CFG_INTERNAL_IP6_DNS:
  ------------------
  |  |  535|      0|#define IKEV2_CFG_INTERNAL_IP6_DNS		10	/* RFC7296 */
  ------------------
  |  Branch (2001:4): [True: 0, False: 0]
  ------------------
 2002|      0|				msg->msg_parent->msg_cp_dns = addr;
 2003|      0|				log_debug("%s: IP6_DNS %s", __func__, buf);
 2004|      0|				break;
 2005|      0|			}
 2006|      0|			break;
 2007|  1.25k|		}
 2008|       |
 2009|  1.25k| skip:
 2010|  1.25k|		ptr += betoh16(cfg->cfg_length);
  ------------------
  |  |   40|  1.25k|#define betoh16	be16toh
  ------------------
 2011|  1.25k|		len -= betoh16(cfg->cfg_length);
  ------------------
  |  |   40|  1.25k|#define betoh16	be16toh
  ------------------
 2012|  1.25k|	}
 2013|       |
 2014|  4.64k|	if (!ikev2_msg_frompeer(msg))
  ------------------
  |  Branch (2014:6): [True: 4.64k, False: 0]
  ------------------
 2015|  4.64k|		return (0);
 2016|       |
 2017|      0|	msg->msg_parent->msg_cp = cp.cp_type;
 2018|       |
 2019|      0|	return (0);
 2020|  4.64k|}
ikev2_validate_eap:
 2025|  16.7k|{
 2026|  16.7k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
 2027|       |
 2028|  16.7k|	if (left < sizeof(*hdr)) {
  ------------------
  |  Branch (2028:6): [True: 5.96k, False: 10.8k]
  ------------------
 2029|  5.96k|		log_debug("%s: malformed payload: too short for header "
 2030|  5.96k|		    "(%zu < %zu)", __func__, left, sizeof(*hdr));
 2031|  5.96k|		return (-1);
 2032|  5.96k|	}
 2033|  10.8k|	memcpy(hdr, msgbuf + offset, sizeof(*hdr));
 2034|       |
 2035|  10.8k|	return (0);
 2036|  16.7k|}
ikev2_pld_eap:
 2041|  16.7k|{
 2042|  16.7k|	struct eap_header		 hdr;
 2043|  16.7k|	struct eap_message		*eap = NULL;
 2044|  16.7k|	const struct iked_sa		*sa = msg->msg_sa;
 2045|  16.7k|	size_t				 len;
 2046|       |
 2047|  16.7k|	if (ikev2_validate_eap(msg, offset, left, &hdr))
  ------------------
  |  Branch (2047:6): [True: 5.96k, False: 10.8k]
  ------------------
 2048|  5.96k|		return (-1);
 2049|  10.8k|	len = betoh16(hdr.eap_length);
  ------------------
  |  |   40|  10.8k|#define betoh16	be16toh
  ------------------
 2050|       |
 2051|  10.8k|	if (len < sizeof(*eap)) {
  ------------------
  |  Branch (2051:6): [True: 4.66k, False: 6.16k]
  ------------------
 2052|  4.66k|		log_info("%s: %s id %d length %d", SPI_SA(sa, __func__),
  ------------------
  |  | 1050|  4.66k|#define SPI_SA(sa, f)    SPI_SH(&(sa)->sa_hdr, (f))
  |  |  ------------------
  |  |  |  | 1049|  4.66k|#define SPI_SH(sh, f)    ikev2_ikesa_info((sh)->sh_ispi, (f))
  |  |  ------------------
  ------------------
 2053|  4.66k|		    print_map(hdr.eap_code, eap_code_map),
 2054|  4.66k|		    hdr.eap_id, betoh16(hdr.eap_length));
  ------------------
  |  |   40|  4.66k|#define betoh16	be16toh
  ------------------
 2055|  6.16k|	} else {
 2056|       |		/* Now try to get the indicated length */
 2057|  6.16k|		if ((eap = ibuf_seek(msg->msg_data, offset, len)) == NULL) {
  ------------------
  |  Branch (2057:7): [True: 2.54k, False: 3.61k]
  ------------------
 2058|  2.54k|			log_debug("%s: invalid EAP length", __func__);
 2059|  2.54k|			return (-1);
 2060|  2.54k|		}
 2061|       |
 2062|  3.61k|		log_info("%s: %s id %d length %d EAP-%s", SPI_SA(sa, __func__),
  ------------------
  |  | 1050|  3.61k|#define SPI_SA(sa, f)    SPI_SH(&(sa)->sa_hdr, (f))
  |  |  ------------------
  |  |  |  | 1049|  3.61k|#define SPI_SH(sh, f)    ikev2_ikesa_info((sh)->sh_ispi, (f))
  |  |  ------------------
  ------------------
 2063|  3.61k|		    print_map(eap->eap_code, eap_code_map),
 2064|  3.61k|		    eap->eap_id, betoh16(eap->eap_length),
  ------------------
  |  |   40|  3.61k|#define betoh16	be16toh
  ------------------
 2065|  3.61k|		    print_map(eap->eap_type, eap_type_map));
 2066|       |
 2067|  3.61k|		if (eap_parse(env, sa, msg, eap, msg->msg_response) == -1)
  ------------------
  |  Branch (2067:7): [True: 0, False: 3.61k]
  ------------------
 2068|      0|			return (-1);
 2069|  3.61k|		msg->msg_parent->msg_eap.eam_found = 1;
 2070|  3.61k|	}
 2071|       |
 2072|  8.28k|	return (0);
 2073|  10.8k|}

ibuf_zero:
   47|  5.60k|{
   48|  5.60k|	explicit_bzero(buf->buf, buf->wpos);
   49|  5.60k|}
ibuf_new:
   53|  2.80k|{
   54|  2.80k|	struct ibuf	*buf;
   55|       |
   56|  2.80k|	if ((buf = ibuf_dynamic(len,
  ------------------
  |  Branch (56:6): [True: 0, False: 2.80k]
  ------------------
   57|  2.80k|	    IKED_MSGBUF_MAX)) == NULL)
  ------------------
  |  |   64|  2.80k|#define IKED_MSGBUF_MAX		8192
  ------------------
   58|      0|		return (NULL);
   59|       |
   60|  2.80k|	ibuf_zero(buf);
   61|       |
   62|  2.80k|	if (len == 0)
  ------------------
  |  Branch (62:6): [True: 0, False: 2.80k]
  ------------------
   63|      0|		return (buf);
   64|       |
   65|  2.80k|	if (data == NULL) {
  ------------------
  |  Branch (65:6): [True: 0, False: 2.80k]
  ------------------
   66|      0|		if (ibuf_advance(buf, len) == NULL) {
  ------------------
  |  Branch (66:7): [True: 0, False: 0]
  ------------------
   67|      0|			ibuf_free(buf);
   68|      0|			return (NULL);
   69|      0|		}
   70|  2.80k|	} else {
   71|  2.80k|		if (ibuf_add(buf, data, len) != 0) {
  ------------------
  |  Branch (71:7): [True: 0, False: 2.80k]
  ------------------
   72|      0|			ibuf_free(buf);
   73|      0|			return (NULL);
   74|      0|		}
   75|  2.80k|	}
   76|       |
   77|  2.80k|	return (buf);
   78|  2.80k|}
ibuf_release:
  106|  17.4k|{
  107|  17.4k|	if (buf == NULL)
  ------------------
  |  Branch (107:6): [True: 14.6k, False: 2.80k]
  ------------------
  108|  14.6k|		return;
  109|  2.80k|	if (buf->buf != NULL) {
  ------------------
  |  Branch (109:6): [True: 2.80k, False: 0]
  ------------------
  110|  2.80k|		ibuf_zero(buf);
  111|  2.80k|		free(buf->buf);
  112|  2.80k|	}
  113|  2.80k|	free(buf);
  114|  2.80k|}
ibuf_data:
  126|   285k|{
  127|   285k|	return (ibuf_seek(buf, 0, 0));
  128|   285k|}

log_getverbose:
   82|  47.6k|{
   83|  47.6k|	return (verbose);
   84|  47.6k|}
vlog:
   98|  8.70k|{
   99|  8.70k|	char	*nfmt;
  100|  8.70k|	int	 saved_errno = errno;
  101|       |
  102|  8.70k|	if (debug) {
  ------------------
  |  Branch (102:6): [True: 0, False: 8.70k]
  ------------------
  103|       |		/* best effort in out of mem situations */
  104|      0|		if (asprintf(&nfmt, "%s\n", fmt) == -1) {
  ------------------
  |  Branch (104:7): [True: 0, False: 0]
  ------------------
  105|      0|			vfprintf(stderr, fmt, ap);
  106|      0|			fprintf(stderr, "\n");
  107|      0|		} else {
  108|      0|			vfprintf(stderr, nfmt, ap);
  109|      0|			free(nfmt);
  110|      0|		}
  111|      0|		fflush(stderr);
  112|      0|	} else
  113|  8.70k|		vsyslog(pri, fmt, ap);
  114|       |
  115|  8.70k|	errno = saved_errno;
  116|  8.70k|}
log_info:
  158|  8.70k|{
  159|  8.70k|	va_list	 ap;
  160|       |
  161|  8.70k|	va_start(ap, emsg);
  162|  8.70k|	vlog(LOG_INFO, emsg, ap);
  163|  8.70k|	va_end(ap);
  164|  8.70k|}
log_debug:
  168|   212k|{
  169|   212k|	va_list	 ap;
  170|       |
  171|   212k|	if (verbose > 1) {
  ------------------
  |  Branch (171:6): [True: 0, False: 212k]
  ------------------
  172|      0|		va_start(ap, emsg);
  173|      0|		vlog(LOG_DEBUG, emsg, ap);
  174|      0|		va_end(ap);
  175|      0|	}
  176|   212k|}

socket_getport:
   71|    922|{
   72|    922|	switch (sa->sa_family) {
   73|    152|	case AF_INET:
  ------------------
  |  Branch (73:2): [True: 152, False: 770]
  ------------------
   74|    152|		return (ntohs(((struct sockaddr_in *)sa)->sin_port));
   75|    770|	case AF_INET6:
  ------------------
  |  Branch (75:2): [True: 770, False: 152]
  ------------------
   76|    770|		return (ntohs(((struct sockaddr_in6 *)sa)->sin6_port));
   77|      0|	default:
  ------------------
  |  Branch (77:2): [True: 0, False: 922]
  ------------------
   78|      0|		return (0);
   79|    922|	}
   80|       |
   81|       |	/* NOTREACHED */
   82|      0|	return (0);
   83|    922|}
print_spi:
  499|  10.8k|{
  500|  10.8k|	static char		 buf[IKED_CYCLE_BUFFERS][32];
  501|  10.8k|	static int		 i = 0;
  502|  10.8k|	char			*ptr;
  503|       |
  504|  10.8k|	ptr = buf[i];
  505|       |
  506|  10.8k|	switch (size) {
  507|      0|	case 2:
  ------------------
  |  Branch (507:2): [True: 0, False: 10.8k]
  ------------------
  508|      0|		snprintf(ptr, 32, "0x%04x", (uint16_t)spi);
  509|      0|		break;
  510|    113|	case 4:
  ------------------
  |  Branch (510:2): [True: 113, False: 10.6k]
  ------------------
  511|    113|		snprintf(ptr, 32, "0x%08x", (uint32_t)spi);
  512|    113|		break;
  513|  3.37k|	case 8:
  ------------------
  |  Branch (513:2): [True: 3.37k, False: 7.43k]
  ------------------
  514|  3.37k|		snprintf(ptr, 32, "0x%016llx", (long long unsigned)spi);
  515|  3.37k|		break;
  516|  7.32k|	default:
  ------------------
  |  Branch (516:2): [True: 7.32k, False: 3.48k]
  ------------------
  517|  7.32k|		snprintf(ptr, 32, "%llu", (long long unsigned)spi);
  518|  7.32k|		break;
  519|  10.8k|	}
  520|       |
  521|  10.8k|	if (++i >= IKED_CYCLE_BUFFERS)
  ------------------
  |  |   68|  10.8k|#define IKED_CYCLE_BUFFERS	8	/* # of static buffers for mapping */
  ------------------
  |  Branch (521:6): [True: 1.35k, False: 9.45k]
  ------------------
  522|  1.35k|		i = 0;
  523|       |
  524|  10.8k|	return (ptr);
  525|  10.8k|}
print_map:
  529|   259k|{
  530|   259k|	unsigned int		 i;
  531|   259k|	static char		 buf[IKED_CYCLE_BUFFERS][32];
  532|   259k|	static int		 idx = 0;
  533|   259k|	const char		*name = NULL;
  534|       |
  535|   259k|	if (idx >= IKED_CYCLE_BUFFERS)
  ------------------
  |  |   68|   259k|#define IKED_CYCLE_BUFFERS	8	/* # of static buffers for mapping */
  ------------------
  |  Branch (535:6): [True: 32.4k, False: 226k]
  ------------------
  536|  32.4k|		idx = 0;
  537|   259k|	bzero(buf[idx], sizeof(buf[idx]));
  538|       |
  539|  4.41M|	for (i = 0; map[i].cm_name != NULL; i++) {
  ------------------
  |  Branch (539:14): [True: 4.15M, False: 259k]
  ------------------
  540|  4.15M|		if (map[i].cm_type == type)
  ------------------
  |  Branch (540:7): [True: 182k, False: 3.97M]
  ------------------
  541|   182k|			name = map[i].cm_name;
  542|  4.15M|	}
  543|       |
  544|   259k|	if (name == NULL)
  ------------------
  |  Branch (544:6): [True: 77.2k, False: 182k]
  ------------------
  545|  77.2k|		snprintf(buf[idx], sizeof(buf[idx]), "<UNKNOWN:%u>", type);
  546|   182k|	else
  547|   182k|		strlcpy(buf[idx], name, sizeof(buf[idx]));
  548|       |
  549|   259k|	return (buf[idx++]);
  550|   259k|}
print_hex:
  561|  47.6k|{
  562|  47.6k|	unsigned int	 i;
  563|       |
  564|  47.6k|	if (log_getverbose() < 3 || !length)
  ------------------
  |  Branch (564:6): [True: 47.6k, False: 0]
  |  Branch (564:30): [True: 0, False: 0]
  ------------------
  565|  47.6k|		return;
  566|       |
  567|      0|	for (i = 0; i < length; i++) {
  ------------------
  |  Branch (567:14): [True: 0, False: 0]
  ------------------
  568|      0|		if (i && (i % 4) == 0) {
  ------------------
  |  Branch (568:7): [True: 0, False: 0]
  |  Branch (568:12): [True: 0, False: 0]
  ------------------
  569|      0|			if ((i % 32) == 0)
  ------------------
  |  Branch (569:8): [True: 0, False: 0]
  ------------------
  570|      0|				print_debug("\n");
  571|      0|			else
  572|      0|				print_debug(" ");
  573|      0|		}
  574|      0|		print_debug("%02x", buf[offset + i]);
  575|      0|	}
  576|      0|	print_debug("\n");
  577|      0|}
print_host:
  731|    922|{
  732|    922|	static char	sbuf[IKED_CYCLE_BUFFERS][NI_MAXHOST + 7];
  733|    922|	static int	idx = 0;
  734|    922|	char		pbuf[7];
  735|    922|	in_port_t	port;
  736|       |
  737|    922|	if (buf == NULL) {
  ------------------
  |  Branch (737:6): [True: 0, False: 922]
  ------------------
  738|      0|		buf = sbuf[idx];
  739|      0|		len = sizeof(sbuf[idx]);
  740|      0|		if (++idx >= IKED_CYCLE_BUFFERS)
  ------------------
  |  |   68|      0|#define IKED_CYCLE_BUFFERS	8	/* # of static buffers for mapping */
  ------------------
  |  Branch (740:7): [True: 0, False: 0]
  ------------------
  741|      0|			idx = 0;
  742|      0|	}
  743|       |
  744|    922|	if (sa->sa_family == AF_UNSPEC) {
  ------------------
  |  Branch (744:6): [True: 0, False: 922]
  ------------------
  745|      0|		strlcpy(buf, "any", len);
  746|      0|		return (buf);
  747|      0|	}
  748|       |
  749|    922|	if (getnameinfo(sa, SA_LEN(sa),
  ------------------
  |  |  177|    922|	((sa->sa_family == AF_INET)  ? sizeof(struct sockaddr_in) :	\
  |  |  ------------------
  |  |  |  Branch (177:3): [True: 152, False: 770]
  |  |  ------------------
  |  |  178|    922|	(sa->sa_family == AF_INET6) ? sizeof(struct sockaddr_in6) :	\
  |  |  ------------------
  |  |  |  Branch (178:2): [True: 770, False: 0]
  |  |  ------------------
  |  |  179|    770|	sizeof(struct sockaddr))
  ------------------
  |  Branch (749:6): [True: 0, False: 922]
  ------------------
  750|    922|	    buf, len, NULL, 0, NI_NUMERICHOST) != 0) {
  751|      0|		strlcpy(buf, "unknown", len);
  752|      0|		return (buf);
  753|      0|	}
  754|       |
  755|    922|	if ((port = socket_getport(sa)) != 0) {
  ------------------
  |  Branch (755:6): [True: 0, False: 922]
  ------------------
  756|      0|		snprintf(pbuf, sizeof(pbuf), ":%d", port);
  757|      0|		(void)strlcat(buf, pbuf, len);
  758|      0|	}
  759|       |
  760|    922|	return (buf);
  761|    922|}

eap_parse:
   58|  3.61k|{
   59|  3.61k|	return (0);
   60|  3.61k|}
ikev2_msg_frompeer:
   64|  74.4k|{
   65|  74.4k|	return (0);
   66|  74.4k|}
ikev2_ikesa_info:
   82|  8.28k|{
   83|  8.28k|	return "";
   84|  8.28k|}
ikev2_print_id:
  159|  1.18k|{
  160|  1.18k|	return (0);
  161|  1.18k|}
ikev2_msg_cleanup:
  230|  1.62k|{
  231|  1.62k|	struct iked_certreq *cr;
  232|  1.62k|	struct iked_proposal *prop, *proptmp;
  233|       |
  234|  1.62k|	if (msg == msg->msg_parent) {
  ------------------
  |  Branch (234:6): [True: 1.62k, False: 0]
  ------------------
  235|  1.62k|		ibuf_release(msg->msg_nonce);
  236|  1.62k|		ibuf_release(msg->msg_ke);
  237|  1.62k|		ibuf_release(msg->msg_auth.id_buf);
  238|  1.62k|		ibuf_release(msg->msg_peerid.id_buf);
  239|  1.62k|		ibuf_release(msg->msg_localid.id_buf);
  240|  1.62k|		ibuf_release(msg->msg_cert.id_buf);
  241|  1.62k|		ibuf_release(msg->msg_cookie);
  242|  1.62k|		ibuf_release(msg->msg_cookie2);
  243|  1.62k|		ibuf_release(msg->msg_del_buf);
  244|  1.62k|		free(msg->msg_eap.eam_user);
  245|  1.62k|		free(msg->msg_cp_addr);
  246|  1.62k|		free(msg->msg_cp_addr6);
  247|       |
  248|  1.62k|		TAILQ_FOREACH_SAFE(prop, &msg->msg_proposals, prop_entry,
  ------------------
  |  |  445|  1.62k|	for ((var) = TAILQ_FIRST(head);					\
  |  |  ------------------
  |  |  |  |  428|  1.62k|#define	TAILQ_FIRST(head)		((head)->tqh_first)
  |  |  ------------------
  |  |  446|  1.62k|	    (var) != TAILQ_END(head) &&					\
  |  |  ------------------
  |  |  |  |  429|  3.24k|#define	TAILQ_END(head)			NULL
  |  |  ------------------
  |  |  |  Branch (446:6): [True: 0, False: 1.62k]
  |  |  ------------------
  |  |  447|  1.62k|	    ((tvar) = TAILQ_NEXT(var, field), 1);			\
  |  |  ------------------
  |  |  |  |  430|      0|#define	TAILQ_NEXT(elm, field)		((elm)->field.tqe_next)
  |  |  ------------------
  |  |  |  Branch (447:6): [True: 0, False: 0]
  |  |  ------------------
  |  |  448|  1.62k|	    (var) = (tvar))
  ------------------
  249|  1.62k|		    proptmp) {
  250|      0|			TAILQ_REMOVE(&msg->msg_proposals, prop, prop_entry);
  ------------------
  |  |  504|      0|#define TAILQ_REMOVE(head, elm, field) do {				\
  |  |  505|      0|	if (((elm)->field.tqe_next) != NULL)				\
  |  |  ------------------
  |  |  |  Branch (505:6): [True: 0, False: 0]
  |  |  ------------------
  |  |  506|      0|		(elm)->field.tqe_next->field.tqe_prev =			\
  |  |  507|      0|		    (elm)->field.tqe_prev;				\
  |  |  508|      0|	else								\
  |  |  509|      0|		(head)->tqh_last = (elm)->field.tqe_prev;		\
  |  |  510|      0|	*(elm)->field.tqe_prev = (elm)->field.tqe_next;			\
  |  |  511|      0|	_Q_INVALIDATE((elm)->field.tqe_prev);				\
  |  |  512|      0|	_Q_INVALIDATE((elm)->field.tqe_next);				\
  |  |  513|      0|} while (0)
  |  |  ------------------
  |  |  |  Branch (513:10): [Folded - Ignored]
  |  |  ------------------
  ------------------
  251|      0|			if (prop->prop_nxforms)
  ------------------
  |  Branch (251:8): [True: 0, False: 0]
  ------------------
  252|      0|				free(prop->prop_xforms);
  253|      0|			free(prop);
  254|      0|		}
  255|       |
  256|  1.62k|		while ((cr = SIMPLEQ_FIRST(&msg->msg_certreqs))) {
  ------------------
  |  |  267|  1.62k|#define	SIMPLEQ_FIRST(head)	    ((head)->sqh_first)
  ------------------
  |  Branch (256:10): [True: 0, False: 1.62k]
  ------------------
  257|      0|			ibuf_release(cr->cr_data);
  258|      0|			SIMPLEQ_REMOVE_HEAD(&msg->msg_certreqs, cr_entry);
  ------------------
  |  |  308|      0|#define SIMPLEQ_REMOVE_HEAD(head, field) do {			\
  |  |  309|      0|	if (((head)->sqh_first = (head)->sqh_first->field.sqe_next) == NULL) \
  |  |  ------------------
  |  |  |  Branch (309:6): [True: 0, False: 0]
  |  |  ------------------
  |  |  310|      0|		(head)->sqh_last = &(head)->sqh_first;			\
  |  |  311|      0|} while (0)
  |  |  ------------------
  |  |  |  Branch (311:10): [Folded - Ignored]
  |  |  ------------------
  ------------------
  259|      0|			free(cr);
  260|      0|		}
  261|  1.62k|	}
  262|       |
  263|  1.62k|	if (msg->msg_data != NULL) {
  ------------------
  |  Branch (263:6): [True: 1.62k, False: 0]
  ------------------
  264|  1.62k|		ibuf_release(msg->msg_data);
  265|  1.62k|		msg->msg_data = NULL;
  266|  1.62k|	}
  267|  1.62k|}

LLVMFuzzerTestOneInput:
  104|  1.62k|{
  105|  1.62k|	struct ibuf		*fuzzed;
  106|  1.62k|	struct ike_header	 hdr;
  107|  1.62k|	struct iked_message	 msg;
  108|       |
  109|  1.62k|	bzero(&hdr, sizeof(hdr));
  110|  1.62k|	bzero(&msg, sizeof(msg));
  111|       |
  112|  1.62k|	fuzzed = ibuf_new(data, size);
  113|  1.62k|	if (fuzzed == NULL){
  ------------------
  |  Branch (113:6): [True: 0, False: 1.62k]
  ------------------
  114|      0|		fprintf(stderr, "%s\n", "ERROR: fuzzed == NULL! "
  115|      0|		    "(hint: fuzz-input too long?)");
  116|      0|		return -1;
  117|      0|	}	
  118|       |	
  119|       |	/* size too small? */
  120|  1.62k|	if (size < sizeof(cookies) + sizeof(genhdr)){
  ------------------
  |  Branch (120:6): [True: 1, False: 1.62k]
  ------------------
  121|      1|		ibuf_free(fuzzed);
  122|      1|		return 0;
  123|      1|	}	       
  124|       |
  125|  1.62k|	prepare_header(&hdr, fuzzed);
  126|  1.62k|	prepare_message(&msg, fuzzed);
  127|       |
  128|  1.62k|	ikev2_pld_parse(NULL, &hdr, &msg, 0);
  129|       |
  130|  1.62k|	ikev2_msg_cleanup(NULL, &msg);
  131|       |
  132|  1.62k|	return 0;
  133|  1.62k|}
test_parser_fuzz.c:prepare_header:
   75|  1.62k|{
   76|  1.62k|	bzero(hdr, sizeof(*hdr));
   77|  1.62k|	bcopy(get_icookie(ibuf_data(data)), &hdr->ike_ispi,
   78|  1.62k|	    sizeof(hdr->ike_ispi));
   79|  1.62k|	bcopy(get_rcookie(ibuf_data(data)), &hdr->ike_rspi,
   80|  1.62k|	    sizeof(hdr->ike_rspi));
   81|  1.62k|	hdr->ike_nextpayload = get_nextpayload(ibuf_data(data));
   82|  1.62k|	hdr->ike_version = get_version(ibuf_data(data));
   83|  1.62k|	hdr->ike_exchange = get_exchange(ibuf_data(data));
   84|  1.62k|	hdr->ike_length = get_length(ibuf_data(data));
   85|  1.62k|}
test_parser_fuzz.c:get_icookie:
   39|  1.62k|{
   40|  1.62k|	return &data[OFFSET_ICOOKIE];
  ------------------
  |  |   30|  1.62k|#define OFFSET_ICOOKIE		0
  ------------------
   41|  1.62k|}
test_parser_fuzz.c:get_rcookie:
   45|  1.62k|{
   46|  1.62k|	return &data[OFFSET_RCOOKIE];
  ------------------
  |  |   31|  1.62k|#define OFFSET_RCOOKIE		8
  ------------------
   47|  1.62k|}
test_parser_fuzz.c:get_nextpayload:
   51|  1.62k|{
   52|  1.62k|	return data[OFFSET_NEXTPAYLOAD];
  ------------------
  |  |   32|  1.62k|#define OFFSET_NEXTPAYLOAD	(0 + sizeof(cookies))
  ------------------
   53|  1.62k|}
test_parser_fuzz.c:get_version:
   57|  1.62k|{
   58|  1.62k|	return data[OFFSET_VERSION];
  ------------------
  |  |   33|  1.62k|#define OFFSET_VERSION		(1 + sizeof(cookies))
  ------------------
   59|  1.62k|}
test_parser_fuzz.c:get_exchange:
   63|  1.62k|{
   64|  1.62k|	return data[OFFSET_EXCHANGE];
  ------------------
  |  |   34|  1.62k|#define OFFSET_EXCHANGE		(2 + sizeof(cookies))
  ------------------
   65|  1.62k|}
test_parser_fuzz.c:get_length:
   69|  1.62k|{
   70|  1.62k|	return *(u_int32_t *)&data[OFFSET_LENGTH];
  ------------------
  |  |   35|  1.62k|#define OFFSET_LENGTH		(8 + sizeof(cookies))
  ------------------
   71|  1.62k|}
test_parser_fuzz.c:prepare_message:
   89|  1.62k|{
   90|  1.62k|	static struct iked_sa	sa;
   91|       |
   92|  1.62k|	bzero(&sa, sizeof(sa));
   93|  1.62k|	bzero(msg, sizeof(*msg));
   94|       |
   95|  1.62k|	msg->msg_sa = &sa;
   96|  1.62k|	msg->msg_data = data;
   97|  1.62k|	msg->msg_e = 1;
   98|  1.62k|	msg->msg_parent = msg;
   99|  1.62k|}

