freezero:
   25|  22.8k|{
   26|       |	/* This is legal. */
   27|  22.8k|	if (ptr == NULL)
  ------------------
  |  Branch (27:6): [True: 1.59k, False: 21.2k]
  ------------------
   28|  1.59k|		return;
   29|       |
   30|  21.2k|	explicit_bzero(ptr, sz);
   31|  21.2k|	free(ptr);
   32|  21.2k|}

ibuf_dynamic:
   62|  22.8k|{
   63|  22.8k|	struct ibuf	*buf;
   64|       |
   65|  22.8k|	if (max < len) {
  ------------------
  |  Branch (65:6): [True: 0, False: 22.8k]
  ------------------
   66|      0|		errno = EINVAL;
   67|      0|		return (NULL);
   68|      0|	}
   69|       |
   70|  22.8k|	if ((buf = calloc(1, sizeof(struct ibuf))) == NULL)
  ------------------
  |  Branch (70:6): [True: 0, False: 22.8k]
  ------------------
   71|      0|		return (NULL);
   72|  22.8k|	if (len > 0) {
  ------------------
  |  Branch (72:6): [True: 21.2k, False: 1.59k]
  ------------------
   73|  21.2k|		if ((buf->buf = calloc(len, 1)) == NULL) {
  ------------------
  |  Branch (73:7): [True: 0, False: 21.2k]
  ------------------
   74|      0|			free(buf);
   75|      0|			return (NULL);
   76|      0|		}
   77|  21.2k|	}
   78|  22.8k|	buf->size = len;
   79|  22.8k|	buf->max = max;
   80|  22.8k|	buf->fd = -1;
   81|       |
   82|  22.8k|	return (buf);
   83|  22.8k|}
ibuf_reserve:
  107|  21.2k|{
  108|  21.2k|	void	*b;
  109|       |
  110|  21.2k|	if (len > SIZE_MAX - buf->wpos) {
  ------------------
  |  Branch (110:6): [True: 0, False: 21.2k]
  ------------------
  111|      0|		errno = ERANGE;
  112|      0|		return (NULL);
  113|      0|	}
  114|       |
  115|  21.2k|	if (buf->wpos + len > buf->size)
  ------------------
  |  Branch (115:6): [True: 0, False: 21.2k]
  ------------------
  116|      0|		if (ibuf_realloc(buf, len) == -1)
  ------------------
  |  Branch (116:7): [True: 0, False: 0]
  ------------------
  117|      0|			return (NULL);
  118|       |
  119|  21.2k|	b = buf->buf + buf->wpos;
  120|  21.2k|	buf->wpos += len;
  121|  21.2k|	memset(b, 0, len);
  122|  21.2k|	return (b);
  123|  21.2k|}
ibuf_add:
  127|  21.2k|{
  128|  21.2k|	void *b;
  129|       |
  130|  21.2k|	if ((b = ibuf_reserve(buf, len)) == NULL)
  ------------------
  |  Branch (130:6): [True: 0, False: 21.2k]
  ------------------
  131|      0|		return (-1);
  132|       |
  133|  21.2k|	memcpy(b, data, len);
  134|  21.2k|	return (0);
  135|  21.2k|}
ibuf_seek:
  202|   255k|{
  203|       |	/* only allowed to seek in already written parts */
  204|   255k|	if (len > SIZE_MAX - pos || pos + len > buf->wpos) {
  ------------------
  |  Branch (204:6): [True: 0, False: 255k]
  |  Branch (204:30): [True: 3.75k, False: 252k]
  ------------------
  205|  3.75k|		errno = ERANGE;
  206|  3.75k|		return (NULL);
  207|  3.75k|	}
  208|       |
  209|   252k|	return (buf->buf + pos);
  210|   255k|}
ibuf_data:
  272|   805k|{
  273|   805k|	return (buf->buf);
  274|   805k|}
ibuf_size:
  278|  14.7k|{
  279|  14.7k|	return (buf->wpos);
  280|  14.7k|}
ibuf_free:
  296|   198k|{
  297|   198k|	if (buf == NULL)
  ------------------
  |  Branch (297:6): [True: 175k, False: 22.8k]
  ------------------
  298|   175k|		return;
  299|       |#ifdef NOTYET
  300|       |	if (buf->fd != -1)
  301|       |		close(buf->fd);
  302|       |#endif
  303|  22.8k|	freezero(buf->buf, buf->size);
  304|  22.8k|	free(buf);
  305|  22.8k|}

strlcpy:
   29|   513k|{
   30|   513k|	const char *osrc = src;
   31|   513k|	size_t nleft = dsize;
   32|       |
   33|       |	/* Copy as many bytes as will fit. */
   34|   513k|	if (nleft != 0) {
  ------------------
  |  Branch (34:6): [True: 513k, False: 0]
  ------------------
   35|  4.09M|		while (--nleft != 0) {
  ------------------
  |  Branch (35:10): [True: 4.09M, False: 1.45k]
  ------------------
   36|  4.09M|			if ((*dst++ = *src++) == '\0')
  ------------------
  |  Branch (36:8): [True: 511k, False: 3.58M]
  ------------------
   37|   511k|				break;
   38|  4.09M|		}
   39|   513k|	}
   40|       |
   41|       |	/* Not enough room in dst, add NUL and traverse rest of src. */
   42|   513k|	if (nleft == 0) {
  ------------------
  |  Branch (42:6): [True: 1.45k, False: 511k]
  ------------------
   43|  1.45k|		if (dsize != 0)
  ------------------
  |  Branch (43:7): [True: 1.45k, False: 0]
  ------------------
   44|  1.45k|			*dst = '\0';		/* NUL-terminate dst */
   45|  1.45k|		while (*src++)
  ------------------
  |  Branch (45:10): [True: 0, False: 1.45k]
  ------------------
   46|      0|			;
   47|  1.45k|	}
   48|       |
   49|   513k|	return(src - osrc - 1);	/* count does not include NUL */
   50|   513k|}

ikev2_pld_parse:
  118|  14.7k|{
  119|  14.7k|	log_debug("%s: header ispi %s rspi %s"
  120|  14.7k|	    " nextpayload %s version 0x%02x exchange %s flags 0x%02x"
  121|  14.7k|	    " msgid %d length %u response %d", __func__,
  122|  14.7k|	    print_spi(betoh64(hdr->ike_ispi), 8),
  123|  14.7k|	    print_spi(betoh64(hdr->ike_rspi), 8),
  124|  14.7k|	    print_map(hdr->ike_nextpayload, ikev2_payload_map),
  125|  14.7k|	    hdr->ike_version,
  126|  14.7k|	    print_map(hdr->ike_exchange, ikev2_exchange_map),
  127|  14.7k|	    hdr->ike_flags,
  128|  14.7k|	    betoh32(hdr->ike_msgid),
  129|  14.7k|	    betoh32(hdr->ike_length),
  130|  14.7k|	    msg->msg_response);
  131|       |
  132|  14.7k|	if (ibuf_size(msg->msg_data) < betoh32(hdr->ike_length)) {
  ------------------
  |  Branch (132:6): [True: 6, False: 14.7k]
  ------------------
  133|      6|		log_debug("%s: short message", __func__);
  134|      6|		return (-1);
  135|      6|	}
  136|       |
  137|  14.7k|	offset += sizeof(*hdr);
  138|       |
  139|  14.7k|	return (ikev2_pld_payloads(env, msg, offset,
  140|  14.7k|	    betoh32(hdr->ike_length), hdr->ike_nextpayload));
  141|  14.7k|}
ikev2_validate_pld:
  146|   257k|{
  147|   257k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
  148|   257k|	size_t		 pld_length;
  149|       |
  150|       |	/* We need at least the generic header. */
  151|   257k|	if (left < sizeof(*pld)) {
  ------------------
  |  Branch (151:6): [True: 1.84k, False: 256k]
  ------------------
  152|  1.84k|		log_debug("%s: malformed payload: too short for generic "
  153|  1.84k|		    "header (%zu < %zu)", __func__, left, sizeof(*pld));
  154|  1.84k|		return (-1);
  155|  1.84k|	}
  156|   256k|	memcpy(pld, msgbuf + offset, sizeof(*pld));
  157|       |
  158|       |	/*
  159|       |	 * We need at least the specified number of bytes.
  160|       |	 * pld_length is the full size of the payload including
  161|       |	 * the generic payload header.
  162|       |	 */
  163|   256k|	pld_length = betoh16(pld->pld_length);
  164|   256k|	if (left < pld_length) {
  ------------------
  |  Branch (164:6): [True: 6.59k, False: 249k]
  ------------------
  165|  6.59k|		log_debug("%s: malformed payload: shorter than specified "
  166|  6.59k|		    "(%zu < %zu)", __func__, left, pld_length);
  167|  6.59k|		return (-1);
  168|  6.59k|	}
  169|       |	/*
  170|       |	 * Sanity check the specified payload size, it must
  171|       |	 * be at least the size of the generic payload header.
  172|       |	 */
  173|   249k|	if (pld_length < sizeof(*pld)) {
  ------------------
  |  Branch (173:6): [True: 2.73k, False: 246k]
  ------------------
  174|  2.73k|		log_debug("%s: malformed payload: shorter than minimum "
  175|  2.73k|		    "header size (%zu < %zu)", __func__, pld_length,
  176|  2.73k|		    sizeof(*pld));
  177|  2.73k|		return (-1);
  178|  2.73k|	}
  179|       |
  180|   246k|	return (0);
  181|   249k|}
ikev2_pld_payloads:
  186|  14.7k|{
  187|  14.7k|	struct ikev2_payload	 pld;
  188|  14.7k|	unsigned int		 e;
  189|  14.7k|	int			 ret;
  190|  14.7k|	uint8_t			*msgbuf = ibuf_data(msg->msg_data);
  191|  14.7k|	size_t			 total, left;
  192|       |
  193|       |	/* Check if message was decrypted in an E payload */
  194|  14.7k|	e = msg->msg_e ? IKED_E : 0;
  ------------------
  |  |   76|  14.7k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (194:6): [True: 14.7k, False: 0]
  ------------------
  195|       |
  196|       |	/* Bytes left in datagram. */
  197|  14.7k|	total = length - offset;
  198|       |
  199|   260k|	while (payload != 0 && offset < length) {
  ------------------
  |  Branch (199:9): [True: 260k, False: 566]
  |  Branch (199:25): [True: 257k, False: 2.23k]
  ------------------
  200|   257k|		if (ikev2_validate_pld(msg, offset, total, &pld))
  ------------------
  |  Branch (200:7): [True: 11.1k, False: 246k]
  ------------------
  201|  11.1k|			return (-1);
  202|       |
  203|   246k|		log_debug("%s: %spayload %s"
  204|   246k|		    " nextpayload %s critical 0x%02x length %d",
  205|   246k|		    __func__, e ? "decrypted " : "",
  ------------------
  |  Branch (205:17): [True: 246k, False: 0]
  ------------------
  206|   246k|		    print_map(payload, ikev2_payload_map),
  207|   246k|		    print_map(pld.pld_nextpayload, ikev2_payload_map),
  208|   246k|		    pld.pld_reserved & IKEV2_CRITICAL_PAYLOAD,
  ------------------
  |  |   89|   246k|#define IKEV2_CRITICAL_PAYLOAD	0x01	/* First bit in the reserved field */
  ------------------
  209|   246k|		    betoh16(pld.pld_length));
  210|       |
  211|       |		/* Skip over generic payload header. */
  212|   246k|		offset += sizeof(pld);
  213|   246k|		total -= sizeof(pld);
  214|   246k|		left = betoh16(pld.pld_length) - sizeof(pld);
  215|   246k|		ret = 0;
  216|       |
  217|   246k|		switch (payload | e) {
  218|      0|		case IKEV2_PAYLOAD_SA:
  ------------------
  |  |   93|      0|#define IKEV2_PAYLOAD_SA	33	/* Security Association */
  ------------------
  |  Branch (218:3): [True: 0, False: 246k]
  ------------------
  219|  29.5k|		case IKEV2_PAYLOAD_SA | IKED_E:
  ------------------
  |  |   93|  29.5k|#define IKEV2_PAYLOAD_SA	33	/* Security Association */
  ------------------
              		case IKEV2_PAYLOAD_SA | IKED_E:
  ------------------
  |  |   76|  29.5k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (219:3): [True: 29.5k, False: 217k]
  ------------------
  220|  29.5k|			ret = ikev2_pld_sa(env, &pld, msg, offset, left);
  221|  29.5k|			break;
  222|      0|		case IKEV2_PAYLOAD_KE:
  ------------------
  |  |   94|      0|#define IKEV2_PAYLOAD_KE	34	/* Key Exchange */
  ------------------
  |  Branch (222:3): [True: 0, False: 246k]
  ------------------
  223|  8.33k|		case IKEV2_PAYLOAD_KE | IKED_E:
  ------------------
  |  |   94|  8.33k|#define IKEV2_PAYLOAD_KE	34	/* Key Exchange */
  ------------------
              		case IKEV2_PAYLOAD_KE | IKED_E:
  ------------------
  |  |   76|  8.33k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (223:3): [True: 8.33k, False: 238k]
  ------------------
  224|  8.33k|			ret = ikev2_pld_ke(env, &pld, msg, offset, left);
  225|  8.33k|			break;
  226|  13.2k|		case IKEV2_PAYLOAD_IDi | IKED_E:
  ------------------
  |  |   95|  13.2k|#define IKEV2_PAYLOAD_IDi	35	/* Identification - Initiator */
  ------------------
              		case IKEV2_PAYLOAD_IDi | IKED_E:
  ------------------
  |  |   76|  13.2k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (226:3): [True: 13.2k, False: 233k]
  ------------------
  227|  20.6k|		case IKEV2_PAYLOAD_IDr | IKED_E:
  ------------------
  |  |   96|  20.6k|#define IKEV2_PAYLOAD_IDr	36	/* Identification - Responder */
  ------------------
              		case IKEV2_PAYLOAD_IDr | IKED_E:
  ------------------
  |  |   76|  20.6k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (227:3): [True: 7.37k, False: 239k]
  ------------------
  228|  20.6k|			ret = ikev2_pld_id(env, &pld, msg, offset, left,
  229|  20.6k|			    payload);
  230|  20.6k|			break;
  231|  6.50k|		case IKEV2_PAYLOAD_CERT | IKED_E:
  ------------------
  |  |   97|  6.50k|#define IKEV2_PAYLOAD_CERT	37	/* Certificate */
  ------------------
              		case IKEV2_PAYLOAD_CERT | IKED_E:
  ------------------
  |  |   76|  6.50k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (231:3): [True: 6.50k, False: 240k]
  ------------------
  232|  6.50k|			ret = ikev2_pld_cert(env, &pld, msg, offset, left);
  233|  6.50k|			break;
  234|      0|		case IKEV2_PAYLOAD_CERTREQ:
  ------------------
  |  |   98|      0|#define IKEV2_PAYLOAD_CERTREQ	38	/* Certificate Request */
  ------------------
  |  Branch (234:3): [True: 0, False: 246k]
  ------------------
  235|  13.2k|		case IKEV2_PAYLOAD_CERTREQ | IKED_E:
  ------------------
  |  |   98|  13.2k|#define IKEV2_PAYLOAD_CERTREQ	38	/* Certificate Request */
  ------------------
              		case IKEV2_PAYLOAD_CERTREQ | IKED_E:
  ------------------
  |  |   76|  13.2k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (235:3): [True: 13.2k, False: 233k]
  ------------------
  236|  13.2k|			ret = ikev2_pld_certreq(env, &pld, msg, offset, left);
  237|  13.2k|			break;
  238|  8.22k|		case IKEV2_PAYLOAD_AUTH | IKED_E:
  ------------------
  |  |   99|  8.22k|#define IKEV2_PAYLOAD_AUTH	39	/* Authentication */
  ------------------
              		case IKEV2_PAYLOAD_AUTH | IKED_E:
  ------------------
  |  |   76|  8.22k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (238:3): [True: 8.22k, False: 238k]
  ------------------
  239|  8.22k|			ret = ikev2_pld_auth(env, &pld, msg, offset, left);
  240|  8.22k|			break;
  241|      0|		case IKEV2_PAYLOAD_NONCE:
  ------------------
  |  |  100|      0|#define IKEV2_PAYLOAD_NONCE	40	/* Nonce */
  ------------------
  |  Branch (241:3): [True: 0, False: 246k]
  ------------------
  242|    732|		case IKEV2_PAYLOAD_NONCE | IKED_E:
  ------------------
  |  |  100|    732|#define IKEV2_PAYLOAD_NONCE	40	/* Nonce */
  ------------------
              		case IKEV2_PAYLOAD_NONCE | IKED_E:
  ------------------
  |  |   76|    732|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (242:3): [True: 732, False: 246k]
  ------------------
  243|    732|			ret = ikev2_pld_nonce(env, &pld, msg, offset, left);
  244|    732|			break;
  245|      0|		case IKEV2_PAYLOAD_NOTIFY:
  ------------------
  |  |  101|      0|#define IKEV2_PAYLOAD_NOTIFY	41	/* Notify */
  ------------------
  |  Branch (245:3): [True: 0, False: 246k]
  ------------------
  246|  38.4k|		case IKEV2_PAYLOAD_NOTIFY | IKED_E:
  ------------------
  |  |  101|  38.4k|#define IKEV2_PAYLOAD_NOTIFY	41	/* Notify */
  ------------------
              		case IKEV2_PAYLOAD_NOTIFY | IKED_E:
  ------------------
  |  |   76|  38.4k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (246:3): [True: 38.4k, False: 208k]
  ------------------
  247|  38.4k|			ret = ikev2_pld_notify(env, &pld, msg, offset, left);
  248|  38.4k|			break;
  249|  7.19k|		case IKEV2_PAYLOAD_DELETE | IKED_E:
  ------------------
  |  |  102|  7.19k|#define IKEV2_PAYLOAD_DELETE	42	/* Delete */
  ------------------
              		case IKEV2_PAYLOAD_DELETE | IKED_E:
  ------------------
  |  |   76|  7.19k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (249:3): [True: 7.19k, False: 239k]
  ------------------
  250|  7.19k|			ret = ikev2_pld_delete(env, &pld, msg, offset, left);
  251|  7.19k|			break;
  252|  4.95k|		case IKEV2_PAYLOAD_TSi | IKED_E:
  ------------------
  |  |  104|  4.95k|#define IKEV2_PAYLOAD_TSi	44	/* Traffic Selector - Initiator */
  ------------------
              		case IKEV2_PAYLOAD_TSi | IKED_E:
  ------------------
  |  |   76|  4.95k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (252:3): [True: 4.95k, False: 241k]
  ------------------
  253|  19.0k|		case IKEV2_PAYLOAD_TSr | IKED_E:
  ------------------
  |  |  105|  19.0k|#define IKEV2_PAYLOAD_TSr	45	/* Traffic Selector - Responder */
  ------------------
              		case IKEV2_PAYLOAD_TSr | IKED_E:
  ------------------
  |  |   76|  19.0k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (253:3): [True: 14.0k, False: 232k]
  ------------------
  254|  19.0k|			ret = ikev2_pld_tss(env, &pld, msg, offset, left);
  255|  19.0k|			break;
  256|      0|		case IKEV2_PAYLOAD_SK:
  ------------------
  |  |  106|      0|#define IKEV2_PAYLOAD_SK	46	/* Encrypted */
  ------------------
  |  Branch (256:3): [True: 0, False: 246k]
  ------------------
  257|      0|			ret = ikev2_pld_e(env, &pld, msg, offset, left);
  258|      0|			break;
  259|      0|		case IKEV2_PAYLOAD_SKF:
  ------------------
  |  |  110|      0|#define IKEV2_PAYLOAD_SKF	53	/* RFC7383 Encrypted Fragment Payload */
  ------------------
  |  Branch (259:3): [True: 0, False: 246k]
  ------------------
  260|      0|			ret = ikev2_pld_ef(env, &pld, msg, offset, left);
  261|      0|			break;
  262|  10.1k|		case IKEV2_PAYLOAD_CP | IKED_E:
  ------------------
  |  |  107|  10.1k|#define IKEV2_PAYLOAD_CP	47	/* Configuration Payload */
  ------------------
              		case IKEV2_PAYLOAD_CP | IKED_E:
  ------------------
  |  |   76|  10.1k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (262:3): [True: 10.1k, False: 236k]
  ------------------
  263|  10.1k|			ret = ikev2_pld_cp(env, &pld, msg, offset, left);
  264|  10.1k|			break;
  265|  18.6k|		case IKEV2_PAYLOAD_EAP | IKED_E:
  ------------------
  |  |  108|  18.6k|#define IKEV2_PAYLOAD_EAP	48	/* Extensible Authentication */
  ------------------
              		case IKEV2_PAYLOAD_EAP | IKED_E:
  ------------------
  |  |   76|  18.6k|#define IKED_E			0x1000	/* Decrypted flag */
  ------------------
  |  Branch (265:3): [True: 18.6k, False: 228k]
  ------------------
  266|  18.6k|			ret = ikev2_pld_eap(env, &pld, msg, offset, left);
  267|  18.6k|			break;
  268|  66.0k|		default:
  ------------------
  |  Branch (268:3): [True: 66.0k, False: 180k]
  ------------------
  269|  66.0k|			print_hex(msgbuf, offset,
  270|  66.0k|			    betoh16(pld.pld_length) - sizeof(pld));
  271|  66.0k|			break;
  272|   246k|		}
  273|       |
  274|   246k|		if (ret != 0 && ikev2_msg_frompeer(msg)) {
  ------------------
  |  Branch (274:7): [True: 101k, False: 145k]
  |  Branch (274:19): [True: 746, False: 100k]
  ------------------
  275|    746|			(void)ikev2_send_informational(env, msg);
  276|    746|			return (-1);
  277|    746|		}
  278|       |
  279|       |		/* Encrypted payloads must appear last */
  280|   245k|		if ((payload == IKEV2_PAYLOAD_SK) ||
  ------------------
  |  |  106|   245k|#define IKEV2_PAYLOAD_SK	46	/* Encrypted */
  ------------------
  |  Branch (280:7): [True: 2, False: 245k]
  ------------------
  281|   245k|		    (payload == IKEV2_PAYLOAD_SKF))
  ------------------
  |  |  110|   245k|#define IKEV2_PAYLOAD_SKF	53	/* RFC7383 Encrypted Fragment Payload */
  ------------------
  |  Branch (281:7): [True: 2, False: 245k]
  ------------------
  282|      4|			return (0);
  283|       |
  284|   245k|		payload = pld.pld_nextpayload;
  285|   245k|		offset += left;
  286|   245k|		total -= left;
  287|   245k|	}
  288|       |
  289|  2.80k|	return (0);
  290|  14.7k|}
ikev2_validate_sa:
  295|  34.1k|{
  296|  34.1k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
  297|  34.1k|	size_t		 sap_length;
  298|       |
  299|  34.1k|	if (left < sizeof(*sap)) {
  ------------------
  |  Branch (299:6): [True: 14.4k, False: 19.7k]
  ------------------
  300|  14.4k|		log_debug("%s: malformed payload: too short for header "
  301|  14.4k|		    "(%zu < %zu)", __func__, left, sizeof(*sap));
  302|  14.4k|		return (-1);
  303|  14.4k|	}
  304|  19.7k|	memcpy(sap, msgbuf + offset, sizeof(*sap));
  305|       |
  306|  19.7k|	sap_length = betoh16(sap->sap_length);
  307|  19.7k|	if (sap_length < sizeof(*sap)) {
  ------------------
  |  Branch (307:6): [True: 5.32k, False: 14.3k]
  ------------------
  308|  5.32k|		log_debug("%s: malformed payload: shorter than minimum header "
  309|  5.32k|		    "size (%zu < %zu)", __func__, sap_length, sizeof(*sap));
  310|  5.32k|		return (-1);
  311|  5.32k|	}
  312|  14.3k|	if (left < sap_length) {
  ------------------
  |  Branch (312:6): [True: 2.38k, False: 12.0k]
  ------------------
  313|  2.38k|		log_debug("%s: malformed payload: too long for actual payload "
  314|  2.38k|		    "size (%zu < %zu)", __func__, left, sap_length);
  315|  2.38k|		return (-1);
  316|  2.38k|	}
  317|       |	/*
  318|       |	 * If there is only one proposal, sap_length must be the
  319|       |	 * total payload size.
  320|       |	 */
  321|  12.0k|	if (!sap->sap_more && left != sap_length) {
  ------------------
  |  Branch (321:6): [True: 1.75k, False: 10.2k]
  |  Branch (321:24): [True: 30, False: 1.72k]
  ------------------
  322|     30|		log_debug("%s: malformed payload: SA payload length mismatches "
  323|     30|		    "single proposal substructure length (%zu != %zu)",
  324|     30|		    __func__, left, sap_length);
  325|     30|		return (-1);
  326|     30|	}
  327|       |	/*
  328|       |	 * If there are more than one proposal, there must be bytes
  329|       |	 * left in the payload.
  330|       |	 */
  331|  11.9k|	if (sap->sap_more && left <= sap_length) {
  ------------------
  |  Branch (331:6): [True: 10.2k, False: 1.72k]
  |  Branch (331:23): [True: 871, False: 9.37k]
  ------------------
  332|    871|		log_debug("%s: malformed payload: SA payload too small for "
  333|    871|		    "further proposals (%zu <= %zu)", __func__,
  334|    871|		    left, sap_length);
  335|    871|		return (-1);
  336|    871|	}
  337|  11.1k|	return (0);
  338|  11.9k|}
ikev2_pld_sa:
  343|  29.5k|{
  344|  29.5k|	struct ikev2_sa_proposal	 sap;
  345|  29.5k|	struct iked_proposal		*prop = NULL;
  346|  29.5k|	uint32_t			 spi32;
  347|  29.5k|	uint64_t			 spi = 0, spi64;
  348|  29.5k|	uint8_t				*msgbuf = ibuf_data(msg->msg_data);
  349|  29.5k|	int				 r;
  350|  29.5k|	struct iked_proposals		*props;
  351|  29.5k|	size_t				 total;
  352|       |
  353|  34.1k|	do {
  354|  34.1k|		if (ikev2_validate_sa(msg, offset, left, &sap))
  ------------------
  |  Branch (354:7): [True: 23.0k, False: 11.1k]
  ------------------
  355|  23.0k|			return (-1);
  356|       |
  357|       |		/* Assumed size of the first proposals, including SPI if present. */
  358|  11.1k|		total = (betoh16(sap.sap_length) - sizeof(sap));
  359|       |
  360|  11.1k|		props = &msg->msg_parent->msg_proposals;
  361|       |
  362|  11.1k|		offset += sizeof(sap);
  363|  11.1k|		left -= sizeof(sap);
  364|       |
  365|  11.1k|		if (sap.sap_spisize) {
  ------------------
  |  Branch (365:7): [True: 1.55k, False: 9.54k]
  ------------------
  366|  1.55k|			if (left < sap.sap_spisize) {
  ------------------
  |  Branch (366:8): [True: 729, False: 828]
  ------------------
  367|    729|				log_debug("%s: malformed payload: SPI larger than "
  368|    729|				    "actual payload (%zu < %d)", __func__, left,
  369|    729|				    sap.sap_spisize);
  370|    729|				return (-1);
  371|    729|			}
  372|    828|			if (total < sap.sap_spisize) {
  ------------------
  |  Branch (372:8): [True: 136, False: 692]
  ------------------
  373|    136|				log_debug("%s: malformed payload: SPI larger than "
  374|    136|				    "proposal (%zu < %d)", __func__, total,
  375|    136|				    sap.sap_spisize);
  376|    136|				return (-1);
  377|    136|			}
  378|    692|			switch (sap.sap_spisize) {
  379|    354|			case 4:
  ------------------
  |  Branch (379:4): [True: 354, False: 338]
  ------------------
  380|    354|				memcpy(&spi32, msgbuf + offset, 4);
  381|    354|				spi = betoh32(spi32);
  382|    354|				break;
  383|    208|			case 8:
  ------------------
  |  Branch (383:4): [True: 208, False: 484]
  ------------------
  384|    208|				memcpy(&spi64, msgbuf + offset, 8);
  385|    208|				spi = betoh64(spi64);
  386|    208|				break;
  387|    130|			default:
  ------------------
  |  Branch (387:4): [True: 130, False: 562]
  ------------------
  388|    130|				log_debug("%s: unsupported SPI size %d",
  389|    130|				    __func__, sap.sap_spisize);
  390|    130|				return (-1);
  391|    692|			}
  392|       |
  393|    562|			offset += sap.sap_spisize;
  394|    562|			left -= sap.sap_spisize;
  395|       |
  396|       |			/* Assumed size of the proposal, now without SPI. */
  397|    562|			total -= sap.sap_spisize;
  398|    562|		}
  399|       |
  400|       |		/*
  401|       |		 * As we verified sanity of packet headers, this check will
  402|       |		 * be always false, but just to be sure we keep it.
  403|       |		 */
  404|  10.1k|		if (left < total) {
  ------------------
  |  Branch (404:7): [True: 0, False: 10.1k]
  ------------------
  405|      0|			log_debug("%s: malformed payload: too long for payload "
  406|      0|			    "(%zu < %zu)", __func__, left, total);
  407|      0|			return (-1);
  408|      0|		}
  409|       |
  410|  10.1k|		log_debug("%s: more %d reserved %d length %d"
  411|  10.1k|		    " proposal #%d protoid %s spisize %d xforms %d spi %s",
  412|  10.1k|		    __func__, sap.sap_more, sap.sap_reserved,
  413|  10.1k|		    betoh16(sap.sap_length), sap.sap_proposalnr,
  414|  10.1k|		    print_map(sap.sap_protoid, ikev2_saproto_map), sap.sap_spisize,
  415|  10.1k|		    sap.sap_transforms, print_spi(spi, sap.sap_spisize));
  416|       |
  417|  10.1k|		if (ikev2_msg_frompeer(msg)) {
  ------------------
  |  Branch (417:7): [True: 69, False: 10.0k]
  ------------------
  418|     69|			if ((msg->msg_parent->msg_prop = config_add_proposal(props,
  ------------------
  |  Branch (418:8): [True: 69, False: 0]
  ------------------
  419|     69|			    sap.sap_proposalnr, sap.sap_protoid)) == NULL) {
  420|     69|				log_debug("%s: invalid proposal", __func__);
  421|     69|				return (-1);
  422|     69|			}
  423|      0|			prop = msg->msg_parent->msg_prop;
  424|      0|			prop->prop_peerspi.spi = spi;
  425|      0|			prop->prop_peerspi.spi_protoid = sap.sap_protoid;
  426|      0|			prop->prop_peerspi.spi_size = sap.sap_spisize;
  427|       |
  428|      0|			prop->prop_localspi.spi_protoid = sap.sap_protoid;
  429|      0|			prop->prop_localspi.spi_size = sap.sap_spisize;
  430|      0|		}
  431|       |
  432|       |		/*
  433|       |		 * Parse the attached transforms
  434|       |		 */
  435|  10.0k|		if (sap.sap_transforms) {
  ------------------
  |  Branch (435:7): [True: 5.71k, False: 4.32k]
  ------------------
  436|  5.71k|			r = ikev2_pld_xform(env, msg, offset, total);
  437|  5.71k|			if ((r == -2) && ikev2_msg_frompeer(msg)) {
  ------------------
  |  Branch (437:8): [True: 0, False: 5.71k]
  |  Branch (437:21): [True: 0, False: 0]
  ------------------
  438|      0|				log_debug("%s: invalid proposal transform",
  439|      0|				    __func__);
  440|       |
  441|       |				/* cleanup and ignore proposal */
  442|      0|				config_free_proposal(props, prop);
  443|      0|				prop = msg->msg_parent->msg_prop = NULL;
  444|  5.71k|			} else if (r != 0) {
  ------------------
  |  Branch (444:15): [True: 4.57k, False: 1.14k]
  ------------------
  445|  4.57k|				log_debug("%s: invalid proposal transforms",
  446|  4.57k|				    __func__);
  447|  4.57k|				return (-1);
  448|  4.57k|			}
  449|  5.71k|		}
  450|       |
  451|  5.46k|		offset += total;
  452|  5.46k|		left -= total;
  453|  5.46k|	} while (sap.sap_more);
  ------------------
  |  Branch (453:11): [True: 4.65k, False: 807]
  ------------------
  454|       |
  455|    807|	return (0);
  456|  29.5k|}
ikev2_validate_xform:
  461|  7.56k|{
  462|  7.56k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
  463|  7.56k|	size_t		 xfrm_length;
  464|       |
  465|  7.56k|	if (total < sizeof(*xfrm)) {
  ------------------
  |  Branch (465:6): [True: 673, False: 6.89k]
  ------------------
  466|    673|		log_debug("%s: malformed payload: too short for header "
  467|    673|		    "(%zu < %zu)", __func__, total, sizeof(*xfrm));
  468|    673|		return (-1);
  469|    673|	}
  470|  6.89k|	memcpy(xfrm, msgbuf + offset, sizeof(*xfrm));
  471|       |
  472|  6.89k|	xfrm_length = betoh16(xfrm->xfrm_length);
  473|  6.89k|	if (xfrm_length < sizeof(*xfrm)) {
  ------------------
  |  Branch (473:6): [True: 1.13k, False: 5.75k]
  ------------------
  474|  1.13k|		log_debug("%s: malformed payload: shorter than minimum header "
  475|  1.13k|		    "size (%zu < %zu)", __func__, xfrm_length, sizeof(*xfrm));
  476|  1.13k|		return (-1);
  477|  1.13k|	}
  478|  5.75k|	if (total < xfrm_length) {
  ------------------
  |  Branch (478:6): [True: 644, False: 5.11k]
  ------------------
  479|    644|		log_debug("%s: malformed payload: too long for payload size "
  480|    644|		    "(%zu < %zu)", __func__, total, xfrm_length);
  481|    644|		return (-1);
  482|    644|	}
  483|       |
  484|  5.11k|	return (0);
  485|  5.75k|}
ikev2_pld_xform:
  490|  7.56k|{
  491|  7.56k|	struct ikev2_transform		 xfrm;
  492|  7.56k|	char				 id[BUFSIZ];
  493|  7.56k|	int				 ret = 0;
  494|  7.56k|	int				 r;
  495|  7.56k|	size_t				 xfrm_length;
  496|       |
  497|  7.56k|	if (ikev2_validate_xform(msg, offset, total, &xfrm))
  ------------------
  |  Branch (497:6): [True: 2.45k, False: 5.11k]
  ------------------
  498|  2.45k|		return (-1);
  499|       |
  500|  5.11k|	xfrm_length = betoh16(xfrm.xfrm_length);
  501|       |
  502|  5.11k|	switch (xfrm.xfrm_type) {
  503|  1.19k|	case IKEV2_XFORMTYPE_ENCR:
  ------------------
  |  |  156|  1.19k|#define IKEV2_XFORMTYPE_ENCR		1	/* Encryption */
  ------------------
  |  Branch (503:2): [True: 1.19k, False: 3.91k]
  ------------------
  504|  1.19k|		strlcpy(id, print_map(betoh16(xfrm.xfrm_id),
  505|  1.19k|		    ikev2_xformencr_map), sizeof(id));
  506|  1.19k|		break;
  507|    777|	case IKEV2_XFORMTYPE_PRF:
  ------------------
  |  |  157|    777|#define IKEV2_XFORMTYPE_PRF		2	/* Pseudo-Random Function */
  ------------------
  |  Branch (507:2): [True: 777, False: 4.33k]
  ------------------
  508|    777|		strlcpy(id, print_map(betoh16(xfrm.xfrm_id),
  509|    777|		    ikev2_xformprf_map), sizeof(id));
  510|    777|		break;
  511|    156|	case IKEV2_XFORMTYPE_INTEGR:
  ------------------
  |  |  158|    156|#define IKEV2_XFORMTYPE_INTEGR		3	/* Integrity Algorithm */
  ------------------
  |  Branch (511:2): [True: 156, False: 4.95k]
  ------------------
  512|    156|		strlcpy(id, print_map(betoh16(xfrm.xfrm_id),
  513|    156|		    ikev2_xformauth_map), sizeof(id));
  514|    156|		break;
  515|    567|	case IKEV2_XFORMTYPE_DH:
  ------------------
  |  |  159|    567|#define IKEV2_XFORMTYPE_DH		4	/* Diffie-Hellman Group */
  ------------------
  |  Branch (515:2): [True: 567, False: 4.54k]
  ------------------
  516|    567|		strlcpy(id, print_map(betoh16(xfrm.xfrm_id),
  517|    567|		    ikev2_xformdh_map), sizeof(id));
  518|    567|		break;
  519|  1.00k|	case IKEV2_XFORMTYPE_ESN:
  ------------------
  |  |  160|  1.00k|#define IKEV2_XFORMTYPE_ESN		5	/* Extended Sequence Numbers */
  ------------------
  |  Branch (519:2): [True: 1.00k, False: 4.11k]
  ------------------
  520|  1.00k|		strlcpy(id, print_map(betoh16(xfrm.xfrm_id),
  521|  1.00k|		    ikev2_xformesn_map), sizeof(id));
  522|  1.00k|		break;
  523|  1.41k|	default:
  ------------------
  |  Branch (523:2): [True: 1.41k, False: 3.70k]
  ------------------
  524|  1.41k|		snprintf(id, sizeof(id), "<%d>", betoh16(xfrm.xfrm_id));
  525|  1.41k|		break;
  526|  5.11k|	}
  527|       |
  528|  5.11k|	log_debug("%s: more %d reserved %d length %zu"
  529|  5.11k|	    " type %s id %s",
  530|  5.11k|	    __func__, xfrm.xfrm_more, xfrm.xfrm_reserved, xfrm_length,
  531|  5.11k|	    print_map(xfrm.xfrm_type, ikev2_xformtype_map), id);
  532|       |
  533|       |	/*
  534|       |	 * Parse transform attributes, if available
  535|       |	 */
  536|  5.11k|	msg->msg_attrlength = 0;
  537|  5.11k|	if (xfrm_length > sizeof(xfrm)) {
  ------------------
  |  Branch (537:6): [True: 2.48k, False: 2.62k]
  ------------------
  538|  2.48k|		if (ikev2_pld_attr(env, &xfrm, msg, offset + sizeof(xfrm),
  ------------------
  |  Branch (538:7): [True: 1.90k, False: 584]
  ------------------
  539|  2.48k|		    xfrm_length - sizeof(xfrm)) != 0) {
  540|  1.90k|			return (-1);
  541|  1.90k|		}
  542|  2.48k|	}
  543|       |
  544|  3.21k|	if (ikev2_msg_frompeer(msg)) {
  ------------------
  |  Branch (544:6): [True: 0, False: 3.21k]
  ------------------
  545|      0|		r = config_add_transform(msg->msg_parent->msg_prop,
  546|      0|		    xfrm.xfrm_type, betoh16(xfrm.xfrm_id),
  547|      0|		    msg->msg_attrlength, msg->msg_attrlength);
  548|      0|		if (r == -1) {
  ------------------
  |  Branch (548:7): [True: 0, False: 0]
  ------------------
  549|      0|			log_debug("%s: failed to add transform: alloc error",
  550|      0|			    __func__);
  551|      0|			return (r);
  552|      0|		} else if (r == -2) {
  ------------------
  |  Branch (552:14): [True: 0, False: 0]
  ------------------
  553|      0|			log_debug("%s: failed to add transform: unknown type",
  554|      0|			    __func__);
  555|      0|			return (r);
  556|      0|		}
  557|      0|	}
  558|       |
  559|       |	/* Next transform */
  560|  3.21k|	offset += xfrm_length;
  561|  3.21k|	total -= xfrm_length;
  562|  3.21k|	if (xfrm.xfrm_more == IKEV2_XFORM_MORE)
  ------------------
  |  |  154|  3.21k|#define IKEV2_XFORM_MORE		3
  ------------------
  |  Branch (562:6): [True: 1.85k, False: 1.36k]
  ------------------
  563|  1.85k|		ret = ikev2_pld_xform(env, msg, offset, total);
  564|  1.36k|	else if (total != 0) {
  ------------------
  |  Branch (564:11): [True: 222, False: 1.14k]
  ------------------
  565|       |		/* No more transforms but still some data left. */
  566|    222|		log_debug("%s: less data than specified, %zu bytes left",
  567|    222|		    __func__, total);
  568|    222|		ret = -1;
  569|    222|	}
  570|       |
  571|  3.21k|	return (ret);
  572|  3.21k|}
ikev2_validate_attr:
  577|  49.6k|{
  578|  49.6k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
  579|       |
  580|  49.6k|	if (total < sizeof(*attr)) {
  ------------------
  |  Branch (580:6): [True: 827, False: 48.7k]
  ------------------
  581|    827|		log_debug("%s: malformed payload: too short for header "
  582|    827|		    "(%zu < %zu)", __func__, total, sizeof(*attr));
  583|    827|		return (-1);
  584|    827|	}
  585|  48.7k|	memcpy(attr, msgbuf + offset, sizeof(*attr));
  586|       |
  587|  48.7k|	return (0);
  588|  49.6k|}
ikev2_pld_attr:
  593|  49.6k|{
  594|  49.6k|	struct ikev2_attribute		 attr;
  595|  49.6k|	unsigned int			 type;
  596|  49.6k|	uint8_t				*msgbuf = ibuf_data(msg->msg_data);
  597|  49.6k|	int				 ret = 0;
  598|  49.6k|	size_t				 attr_length;
  599|       |
  600|  49.6k|	if (ikev2_validate_attr(msg, offset, total, &attr))
  ------------------
  |  Branch (600:6): [True: 827, False: 48.7k]
  ------------------
  601|    827|		return (-1);
  602|       |
  603|  48.7k|	type = betoh16(attr.attr_type) & ~IKEV2_ATTRAF_TV;
  ------------------
  |  |  279|  48.7k|#define IKEV2_ATTRAF_TV			0x8000	/* Type-Value format */
  ------------------
  604|       |
  605|  48.7k|	log_debug("%s: attribute type %s length %d total %zu",
  606|  48.7k|	    __func__, print_map(type, ikev2_attrtype_map),
  607|  48.7k|	    betoh16(attr.attr_length), total);
  608|       |
  609|  48.7k|	if (betoh16(attr.attr_type) & IKEV2_ATTRAF_TV) {
  ------------------
  |  |  279|  48.7k|#define IKEV2_ATTRAF_TV			0x8000	/* Type-Value format */
  ------------------
  |  Branch (609:6): [True: 39.9k, False: 8.86k]
  ------------------
  610|       |		/* Type-Value attribute */
  611|  39.9k|		offset += sizeof(attr);
  612|  39.9k|		total -= sizeof(attr);
  613|       |
  614|  39.9k|		if (type == IKEV2_ATTRTYPE_KEY_LENGTH)
  ------------------
  |  |  281|  39.9k|#define IKEV2_ATTRTYPE_KEY_LENGTH	14	/* Key length */
  ------------------
  |  Branch (614:7): [True: 47, False: 39.8k]
  ------------------
  615|     47|			msg->msg_attrlength = betoh16(attr.attr_length);
  616|  39.9k|	} else {
  617|       |		/* Type-Length-Value attribute */
  618|  8.86k|		attr_length = betoh16(attr.attr_length);
  619|  8.86k|		if (attr_length < sizeof(attr)) {
  ------------------
  |  Branch (619:7): [True: 579, False: 8.28k]
  ------------------
  620|    579|			log_debug("%s: malformed payload: shorter than "
  621|    579|			    "minimum header size (%zu < %zu)", __func__,
  622|    579|			    attr_length, sizeof(attr));
  623|    579|			return (-1);
  624|    579|		}
  625|  8.28k|		if (total < attr_length) {
  ------------------
  |  Branch (625:7): [True: 494, False: 7.79k]
  ------------------
  626|    494|			log_debug("%s: malformed payload: attribute larger "
  627|    494|			    "than actual payload (%zu < %zu)", __func__,
  628|    494|			    total, attr_length);
  629|    494|			return (-1);
  630|    494|		}
  631|  7.79k|		print_hex(msgbuf, offset + sizeof(attr),
  632|  7.79k|		    attr_length - sizeof(attr));
  633|  7.79k|		offset += attr_length;
  634|  7.79k|		total -= attr_length;
  635|  7.79k|	}
  636|       |
  637|  47.7k|	if (total > 0) {
  ------------------
  |  Branch (637:6): [True: 47.1k, False: 584]
  ------------------
  638|       |		/* Next attribute */
  639|  47.1k|		ret = ikev2_pld_attr(env, xfrm, msg, offset, total);
  640|  47.1k|	}
  641|       |
  642|  47.7k|	return (ret);
  643|  48.7k|}
ikev2_validate_ke:
  648|  8.33k|{
  649|  8.33k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
  650|       |
  651|  8.33k|	if (left < sizeof(*kex)) {
  ------------------
  |  Branch (651:6): [True: 5.14k, False: 3.19k]
  ------------------
  652|  5.14k|		log_debug("%s: malformed payload: too short for header "
  653|  5.14k|		    "(%zu < %zu)", __func__, left, sizeof(*kex));
  654|  5.14k|		return (-1);
  655|  5.14k|	}
  656|  3.19k|	memcpy(kex, msgbuf + offset, sizeof(*kex));
  657|       |
  658|  3.19k|	return (0);
  659|  8.33k|}
ikev2_pld_ke:
  664|  8.33k|{
  665|  8.33k|	struct ikev2_keyexchange	 kex;
  666|  8.33k|	uint8_t				*buf;
  667|  8.33k|	size_t				 len;
  668|  8.33k|	uint8_t				*msgbuf = ibuf_data(msg->msg_data);
  669|       |
  670|  8.33k|	if (ikev2_validate_ke(msg, offset, left, &kex))
  ------------------
  |  Branch (670:6): [True: 5.14k, False: 3.19k]
  ------------------
  671|  5.14k|		return (-1);
  672|       |
  673|  3.19k|	log_debug("%s: dh group %s reserved %d", __func__,
  674|  3.19k|	    print_map(betoh16(kex.kex_dhgroup), ikev2_xformdh_map),
  675|  3.19k|	    betoh16(kex.kex_reserved));
  676|       |
  677|  3.19k|	buf = msgbuf + offset + sizeof(kex);
  678|  3.19k|	len = left - sizeof(kex);
  679|       |
  680|  3.19k|	if (len == 0) {
  ------------------
  |  Branch (680:6): [True: 1.41k, False: 1.78k]
  ------------------
  681|  1.41k|		log_debug("%s: malformed payload: no KE data given", __func__);
  682|  1.41k|		return (-1);
  683|  1.41k|	}
  684|       |
  685|  1.78k|	print_hex(buf, 0, len);
  686|       |
  687|  1.78k|	if (ikev2_msg_frompeer(msg)) {
  ------------------
  |  Branch (687:6): [True: 27, False: 1.75k]
  ------------------
  688|     27|		if (msg->msg_parent->msg_ke != NULL) {
  ------------------
  |  Branch (688:7): [True: 4, False: 23]
  ------------------
  689|      4|			log_info("%s: duplicate KE payload", __func__);
  690|      4|			return (-1);
  691|      4|		}
  692|     23|		if ((msg->msg_parent->msg_ke = ibuf_new(buf, len)) == NULL) {
  ------------------
  |  Branch (692:7): [True: 0, False: 23]
  ------------------
  693|      0|			log_debug("%s: failed to get exchange", __func__);
  694|      0|			return (-1);
  695|      0|		}
  696|     23|		msg->msg_parent->msg_dhgroup = betoh16(kex.kex_dhgroup);
  697|     23|	}
  698|       |
  699|  1.77k|	return (0);
  700|  1.78k|}
ikev2_validate_id:
  705|  20.6k|{
  706|  20.6k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
  707|       |
  708|  20.6k|	if (left < sizeof(*id)) {
  ------------------
  |  Branch (708:6): [True: 8.06k, False: 12.5k]
  ------------------
  709|  8.06k|		log_debug("%s: malformed payload: too short for header "
  710|  8.06k|		    "(%zu < %zu)", __func__, left, sizeof(*id));
  711|  8.06k|		return (-1);
  712|  8.06k|	}
  713|  12.5k|	memcpy(id, msgbuf + offset, sizeof(*id));
  714|       |
  715|  12.5k|	if (id->id_type == IKEV2_ID_NONE) {
  ------------------
  |  |  397|  12.5k|#define IKEV2_ID_NONE		0	/* No ID */
  ------------------
  |  Branch (715:6): [True: 6.59k, False: 5.99k]
  ------------------
  716|  6.59k|		log_debug("%s: malformed payload: invalid ID type.",
  717|  6.59k|		    __func__);
  718|  6.59k|		return (-1);
  719|  6.59k|	}
  720|       |
  721|  5.99k|	return (0);
  722|  12.5k|}
ikev2_pld_id:
  727|  20.6k|{
  728|  20.6k|	uint8_t				*ptr;
  729|  20.6k|	struct ikev2_id			 id;
  730|  20.6k|	size_t				 len;
  731|  20.6k|	struct iked_id			*idp, idb;
  732|  20.6k|	const struct iked_sa		*sa = msg->msg_sa;
  733|  20.6k|	uint8_t				*msgbuf = ibuf_data(msg->msg_data);
  734|  20.6k|	char				 idstr[IKED_ID_SIZE];
  735|       |
  736|  20.6k|	if (ikev2_validate_id(msg, offset, left, &id))
  ------------------
  |  Branch (736:6): [True: 14.6k, False: 5.99k]
  ------------------
  737|  14.6k|		return (-1);
  738|       |
  739|  5.99k|	bzero(&idb, sizeof(idb));
  740|       |
  741|       |	/* Don't strip the Id payload header */
  742|  5.99k|	ptr = msgbuf + offset;
  743|  5.99k|	len = left;
  744|       |
  745|  5.99k|	idb.id_type = id.id_type;
  746|  5.99k|	idb.id_offset = sizeof(id);
  747|  5.99k|	if ((idb.id_buf = ibuf_new(ptr, len)) == NULL)
  ------------------
  |  Branch (747:6): [True: 0, False: 5.99k]
  ------------------
  748|      0|		return (-1);
  749|       |
  750|  5.99k|	if (ikev2_print_id(&idb, idstr, sizeof(idstr)) == -1) {
  ------------------
  |  Branch (750:6): [True: 0, False: 5.99k]
  ------------------
  751|      0|		ibuf_free(idb.id_buf);
  752|      0|		log_debug("%s: malformed id", __func__);
  753|      0|		return (-1);
  754|      0|	}
  755|       |
  756|  5.99k|	log_debug("%s: id %s length %zu", __func__, idstr, len);
  757|       |
  758|  5.99k|	if (!ikev2_msg_frompeer(msg)) {
  ------------------
  |  Branch (758:6): [True: 5.84k, False: 149]
  ------------------
  759|  5.84k|		ibuf_free(idb.id_buf);
  760|  5.84k|		return (0);
  761|  5.84k|	}
  762|       |
  763|    149|	if (((sa->sa_hdr.sh_initiator && payload == IKEV2_PAYLOAD_IDr) ||
  ------------------
  |  |   96|      0|#define IKEV2_PAYLOAD_IDr	36	/* Identification - Responder */
  ------------------
  |  Branch (763:8): [True: 0, False: 149]
  |  Branch (763:35): [True: 0, False: 0]
  ------------------
  764|    149|	    (!sa->sa_hdr.sh_initiator && payload == IKEV2_PAYLOAD_IDi)))
  ------------------
  |  |   95|    149|#define IKEV2_PAYLOAD_IDi	35	/* Identification - Initiator */
  ------------------
  |  Branch (764:7): [True: 149, False: 0]
  |  Branch (764:35): [True: 74, False: 75]
  ------------------
  765|     74|		idp = &msg->msg_parent->msg_peerid;
  766|     75|	else if (!sa->sa_hdr.sh_initiator && payload == IKEV2_PAYLOAD_IDr)
  ------------------
  |  |   96|     75|#define IKEV2_PAYLOAD_IDr	36	/* Identification - Responder */
  ------------------
  |  Branch (766:11): [True: 75, False: 0]
  |  Branch (766:39): [True: 75, False: 0]
  ------------------
  767|     75|		idp = &msg->msg_parent->msg_localid;
  768|      0|	else {
  769|      0|		ibuf_free(idb.id_buf);
  770|      0|		log_debug("%s: unexpected id payload", __func__);
  771|      0|		return (0);
  772|      0|	}
  773|       |
  774|    149|	if (idp->id_type) {
  ------------------
  |  Branch (774:6): [True: 31, False: 118]
  ------------------
  775|     31|		ibuf_free(idb.id_buf);
  776|     31|		log_debug("%s: duplicate id payload", __func__);
  777|     31|		return (-1);
  778|     31|	}
  779|       |
  780|    118|	idp->id_buf = idb.id_buf;
  781|    118|	idp->id_offset = idb.id_offset;
  782|    118|	idp->id_type = idb.id_type;
  783|       |
  784|    118|	return (0);
  785|    149|}
ikev2_validate_cert:
  790|  6.50k|{
  791|  6.50k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
  792|       |
  793|  6.50k|	if (left < sizeof(*cert)) {
  ------------------
  |  Branch (793:6): [True: 1.50k, False: 5.00k]
  ------------------
  794|  1.50k|		log_debug("%s: malformed payload: too short for header "
  795|  1.50k|		    "(%zu < %zu)", __func__, left, sizeof(*cert));
  796|  1.50k|		return (-1);
  797|  1.50k|	}
  798|  5.00k|	memcpy(cert, msgbuf + offset, sizeof(*cert));
  799|  5.00k|	if (cert->cert_type == IKEV2_CERT_NONE) {
  ------------------
  |  |  418|  5.00k|#define IKEV2_CERT_NONE			0	/* None */
  ------------------
  |  Branch (799:6): [True: 995, False: 4.00k]
  ------------------
  800|    995|		log_debug("%s: malformed payload: invalid cert type", __func__);
  801|    995|		return (-1);
  802|    995|	}
  803|       |
  804|  4.00k|	return (0);
  805|  5.00k|}
ikev2_pld_cert:
  810|  6.50k|{
  811|  6.50k|	struct ikev2_cert		 cert;
  812|  6.50k|	uint8_t				*buf;
  813|  6.50k|	size_t				 len;
  814|  6.50k|	struct iked_id			*certid;
  815|  6.50k|	uint8_t				*msgbuf = ibuf_data(msg->msg_data);
  816|  6.50k|	const struct iked_sa		*sa = msg->msg_sa;
  817|  6.50k|	int				 i;
  818|       |
  819|  6.50k|	if (ikev2_validate_cert(msg, offset, left, &cert))
  ------------------
  |  Branch (819:6): [True: 2.49k, False: 4.00k]
  ------------------
  820|  2.49k|		return (-1);
  821|  4.00k|	offset += sizeof(cert);
  822|       |
  823|  4.00k|	buf = msgbuf + offset;
  824|  4.00k|	len = left - sizeof(cert);
  825|       |
  826|  4.00k|	log_debug("%s: type %s length %zu",
  827|  4.00k|	    __func__, print_map(cert.cert_type, ikev2_cert_map), len);
  828|       |
  829|  4.00k|	print_hex(buf, 0, len);
  830|       |
  831|  4.00k|	if (!ikev2_msg_frompeer(msg))
  ------------------
  |  Branch (831:6): [True: 1.45k, False: 2.55k]
  ------------------
  832|  1.45k|		return (0);
  833|       |
  834|       |	/* do not accept internal encoding in the wire */
  835|  2.55k|	if (cert.cert_type == IKEV2_CERT_BUNDLE) {
  ------------------
  |  |  438|  2.55k|#define IKEV2_CERT_BUNDLE		254	/* Private */
  ------------------
  |  Branch (835:6): [True: 290, False: 2.26k]
  ------------------
  836|    290|		log_debug("%s: ignoring IKEV2_CERT_BUNDLE",
  837|    290|		   SPI_SA(sa, __func__));
  ------------------
  |  | 1105|    290|#define SPI_SA(sa, f)    SPI_SH(&(sa)->sa_hdr, (f))
  |  |  ------------------
  |  |  |  | 1104|    290|#define SPI_SH(sh, f)    ikev2_ikesa_info((sh)->sh_ispi, (f))
  |  |  ------------------
  ------------------
  838|    290|		return (0);
  839|    290|	}
  840|       |
  841|  2.26k|	certid = &msg->msg_parent->msg_cert;
  842|  2.26k|	if (certid->id_type) {
  ------------------
  |  Branch (842:6): [True: 1.94k, False: 325]
  ------------------
  843|       |		/* try to set supplemental certs */
  844|  6.34k|		for (i = 0; i < IKED_SCERT_MAX; i++) {
  ------------------
  |  |  477|  6.34k|#define IKED_SCERT_MAX	3 /* max # of supplemental cert payloads */
  ------------------
  |  Branch (844:15): [True: 5.06k, False: 1.28k]
  ------------------
  845|  5.06k|			certid = &msg->msg_parent->msg_scert[i];
  846|  5.06k|			if (!certid->id_type)
  ------------------
  |  Branch (846:8): [True: 658, False: 4.40k]
  ------------------
  847|    658|				break;
  848|  5.06k|		}
  849|  1.94k|		if (certid->id_type) {
  ------------------
  |  Branch (849:7): [True: 1.28k, False: 658]
  ------------------
  850|  1.28k|			log_debug("%s: too many cert payloads, ignoring",
  851|  1.28k|			   SPI_SA(sa, __func__));
  ------------------
  |  | 1105|  1.28k|#define SPI_SA(sa, f)    SPI_SH(&(sa)->sa_hdr, (f))
  |  |  ------------------
  |  |  |  | 1104|  1.28k|#define SPI_SH(sh, f)    ikev2_ikesa_info((sh)->sh_ispi, (f))
  |  |  ------------------
  ------------------
  852|  1.28k|			return (0);
  853|  1.28k|		}
  854|  1.94k|	}
  855|       |
  856|    983|	if ((certid->id_buf = ibuf_new(buf, len)) == NULL) {
  ------------------
  |  Branch (856:6): [True: 0, False: 983]
  ------------------
  857|      0|		log_debug("%s: failed to save cert", __func__);
  858|      0|		return (-1);
  859|      0|	}
  860|    983|	certid->id_type = cert.cert_type;
  861|    983|	certid->id_offset = 0;
  862|       |
  863|    983|	return (0);
  864|    983|}
ikev2_validate_certreq:
  869|  13.2k|{
  870|  13.2k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
  871|       |
  872|  13.2k|	if (left < sizeof(*cert)) {
  ------------------
  |  Branch (872:6): [True: 2.91k, False: 10.3k]
  ------------------
  873|  2.91k|		log_debug("%s: malformed payload: too short for header "
  874|  2.91k|		    "(%zu < %zu)", __func__, left, sizeof(*cert));
  875|  2.91k|		return (-1);
  876|  2.91k|	}
  877|  10.3k|	memcpy(cert, msgbuf + offset, sizeof(*cert));
  878|       |
  879|  10.3k|	return (0);
  880|  13.2k|}
ikev2_pld_certreq:
  885|  13.2k|{
  886|  13.2k|	struct ikev2_cert		 cert;
  887|  13.2k|	struct iked_certreq		*cr;
  888|  13.2k|	uint8_t				*buf;
  889|  13.2k|	ssize_t				 len;
  890|  13.2k|	uint8_t				*msgbuf = ibuf_data(msg->msg_data);
  891|       |
  892|  13.2k|	if (ikev2_validate_certreq(msg, offset, left, &cert))
  ------------------
  |  Branch (892:6): [True: 2.91k, False: 10.3k]
  ------------------
  893|  2.91k|		return (-1);
  894|  10.3k|	offset += sizeof(cert);
  895|       |
  896|  10.3k|	buf = msgbuf + offset;
  897|  10.3k|	len = left - sizeof(cert);
  898|       |
  899|  10.3k|	log_debug("%s: type %s length %zd",
  900|  10.3k|	    __func__, print_map(cert.cert_type, ikev2_cert_map), len);
  901|       |
  902|  10.3k|	print_hex(buf, 0, len);
  903|       |
  904|  10.3k|	if (!ikev2_msg_frompeer(msg))
  ------------------
  |  Branch (904:6): [True: 9.00k, False: 1.33k]
  ------------------
  905|  9.00k|		return (0);
  906|       |
  907|  1.33k|	if (cert.cert_type == IKEV2_CERT_X509_CERT) {
  ------------------
  |  |  422|  1.33k|#define IKEV2_CERT_X509_CERT		4	/* RFC7296 */
  ------------------
  |  Branch (907:6): [True: 321, False: 1.01k]
  ------------------
  908|    321|		if (len == 0) {
  ------------------
  |  Branch (908:7): [True: 279, False: 42]
  ------------------
  909|    279|			log_info("%s: invalid length 0", __func__);
  910|    279|			return (0);
  911|    279|		}
  912|     42|		if ((len % SHA_DIGEST_LENGTH) != 0) {
  ------------------
  |  Branch (912:7): [True: 9, False: 33]
  ------------------
  913|      9|			log_info("%s: invalid certificate request",
  914|      9|			    __func__);
  915|      9|			return (-1);
  916|      9|		}
  917|     42|	}
  918|       |
  919|  1.04k|	if ((cr = calloc(1, sizeof(struct iked_certreq))) == NULL) {
  ------------------
  |  Branch (919:6): [True: 0, False: 1.04k]
  ------------------
  920|      0|		log_info("%s: failed to allocate certreq.", __func__);
  921|      0|		return (-1);
  922|      0|	}
  923|  1.04k|	if ((cr->cr_data = ibuf_new(buf, len)) == NULL) {
  ------------------
  |  Branch (923:6): [True: 0, False: 1.04k]
  ------------------
  924|      0|		log_info("%s: failed to allocate buffer.", __func__);
  925|      0|		free(cr);
  926|      0|		return (-1);
  927|      0|	}
  928|  1.04k|	cr->cr_type = cert.cert_type;
  929|  1.04k|	SIMPLEQ_INSERT_TAIL(&msg->msg_parent->msg_certreqs, cr, cr_entry);
  ------------------
  |  |  296|  1.04k|#define SIMPLEQ_INSERT_TAIL(head, elm, field) do {			\
  |  |  297|  1.04k|	(elm)->field.sqe_next = NULL;					\
  |  |  298|  1.04k|	*(head)->sqh_last = (elm);					\
  |  |  299|  1.04k|	(head)->sqh_last = &(elm)->field.sqe_next;			\
  |  |  300|  1.04k|} while (0)
  |  |  ------------------
  |  |  |  Branch (300:10): [Folded - Ignored]
  |  |  ------------------
  ------------------
  930|       |
  931|  1.04k|	return (0);
  932|  1.04k|}
ikev2_validate_auth:
  937|  8.22k|{
  938|  8.22k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
  939|       |
  940|  8.22k|	if (left < sizeof(*auth)) {
  ------------------
  |  Branch (940:6): [True: 1.86k, False: 6.35k]
  ------------------
  941|  1.86k|		log_debug("%s: malformed payload: too short for header "
  942|  1.86k|		    "(%zu < %zu)", __func__, left, sizeof(*auth));
  943|  1.86k|		return (-1);
  944|  1.86k|	}
  945|  6.35k|	memcpy(auth, msgbuf + offset, sizeof(*auth));
  946|       |
  947|  6.35k|	if (auth->auth_method == 0) {
  ------------------
  |  Branch (947:6): [True: 3.39k, False: 2.96k]
  ------------------
  948|  3.39k|		log_info("%s: malformed payload: invalid auth method",
  949|  3.39k|		    __func__);
  950|  3.39k|		return (-1);
  951|  3.39k|	}
  952|       |
  953|  2.96k|	return (0);
  954|  6.35k|}
ikev2_pld_auth:
  959|  8.22k|{
  960|  8.22k|	struct ikev2_auth		 auth;
  961|  8.22k|	struct iked_id			*idp;
  962|  8.22k|	uint8_t				*buf;
  963|  8.22k|	size_t				 len;
  964|  8.22k|	uint8_t				*msgbuf = ibuf_data(msg->msg_data);
  965|       |
  966|  8.22k|	if (ikev2_validate_auth(msg, offset, left, &auth))
  ------------------
  |  Branch (966:6): [True: 5.26k, False: 2.96k]
  ------------------
  967|  5.26k|		return (-1);
  968|  2.96k|	offset += sizeof(auth);
  969|       |
  970|  2.96k|	buf = msgbuf + offset;
  971|  2.96k|	len = left - sizeof(auth);
  972|       |
  973|  2.96k|	log_debug("%s: method %s length %zu",
  974|  2.96k|	    __func__, print_map(auth.auth_method, ikev2_auth_map), len);
  975|       |
  976|  2.96k|	print_hex(buf, 0, len);
  977|       |
  978|  2.96k|	if (!ikev2_msg_frompeer(msg))
  ------------------
  |  Branch (978:6): [True: 2.91k, False: 42]
  ------------------
  979|  2.91k|		return (0);
  980|       |
  981|     42|	idp = &msg->msg_parent->msg_auth;
  982|     42|	if (idp->id_type) {
  ------------------
  |  Branch (982:6): [True: 1, False: 41]
  ------------------
  983|      1|		log_debug("%s: duplicate auth payload", __func__);
  984|      1|		return (-1);
  985|      1|	}
  986|       |
  987|     41|	ibuf_free(idp->id_buf);
  988|     41|	idp->id_type = auth.auth_method;
  989|     41|	idp->id_offset = 0;
  990|     41|	if ((idp->id_buf = ibuf_new(buf, len)) == NULL)
  ------------------
  |  Branch (990:6): [True: 0, False: 41]
  ------------------
  991|      0|		return (-1);
  992|       |
  993|     41|	return (0);
  994|     41|}
ikev2_pld_nonce:
  999|    732|{
 1000|    732|	size_t		 len;
 1001|    732|	uint8_t		*buf;
 1002|    732|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
 1003|       |
 1004|    732|	buf = msgbuf + offset;
 1005|    732|	len = left;
 1006|       |
 1007|    732|	if (len == 0) {
  ------------------
  |  Branch (1007:6): [True: 556, False: 176]
  ------------------
 1008|    556|		log_debug("%s: malformed payload: no NONCE given", __func__);
 1009|    556|		return (-1);
 1010|    556|	}
 1011|       |
 1012|    176|	print_hex(buf, 0, len);
 1013|       |
 1014|    176|	if (ikev2_msg_frompeer(msg)) {
  ------------------
  |  Branch (1014:6): [True: 62, False: 114]
  ------------------
 1015|     62|		if (msg->msg_parent->msg_nonce != NULL) {
  ------------------
  |  Branch (1015:7): [True: 19, False: 43]
  ------------------
 1016|     19|			log_info("%s: duplicate NONCE payload", __func__);
 1017|     19|			return (-1);
 1018|     19|		}
 1019|     43|		if ((msg->msg_nonce = ibuf_new(buf, len)) == NULL) {
  ------------------
  |  Branch (1019:7): [True: 0, False: 43]
  ------------------
 1020|      0|			log_debug("%s: failed to get peer nonce", __func__);
 1021|      0|			return (-1);
 1022|      0|		}
 1023|     43|		msg->msg_parent->msg_nonce = msg->msg_nonce;
 1024|     43|	}
 1025|       |
 1026|    157|	return (0);
 1027|    176|}
ikev2_validate_notify:
 1032|  38.4k|{
 1033|  38.4k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
 1034|       |
 1035|  38.4k|	if (left < sizeof(*n)) {
  ------------------
  |  Branch (1035:6): [True: 4.89k, False: 33.5k]
  ------------------
 1036|  4.89k|		log_debug("%s: malformed payload: too short for header "
 1037|  4.89k|		    "(%zu < %zu)", __func__, left, sizeof(*n));
 1038|  4.89k|		return (-1);
 1039|  4.89k|	}
 1040|  33.5k|	memcpy(n, msgbuf + offset, sizeof(*n));
 1041|       |
 1042|  33.5k|	return (0);
 1043|  38.4k|}
ikev2_pld_notify:
 1048|  38.4k|{
 1049|  38.4k|	struct ikev2_notify	 n;
 1050|  38.4k|	const struct iked_sa	*sa = msg->msg_sa;
 1051|  38.4k|	uint8_t			*buf, md[SHA_DIGEST_LENGTH];
 1052|  38.4k|	uint32_t		 spi32;
 1053|  38.4k|	uint64_t		 spi64;
 1054|  38.4k|	struct iked_spi		*rekey;
 1055|  38.4k|	uint16_t		 type;
 1056|  38.4k|	uint16_t		 signature_hash;
 1057|       |
 1058|  38.4k|	if (ikev2_validate_notify(msg, offset, left, &n))
  ------------------
  |  Branch (1058:6): [True: 4.89k, False: 33.5k]
  ------------------
 1059|  4.89k|		return (-1);
 1060|  33.5k|	type = betoh16(n.n_type);
 1061|       |
 1062|  33.5k|	log_debug("%s: protoid %s spisize %d type %s",
 1063|  33.5k|	    __func__,
 1064|  33.5k|	    print_map(n.n_protoid, ikev2_saproto_map), n.n_spisize,
 1065|  33.5k|	    print_map(type, ikev2_n_map));
 1066|       |
 1067|  33.5k|	left -= sizeof(n);
 1068|  33.5k|	if ((buf = ibuf_seek(msg->msg_data, offset + sizeof(n), left)) == NULL)
  ------------------
  |  Branch (1068:6): [True: 0, False: 33.5k]
  ------------------
 1069|      0|		return (-1);
 1070|       |
 1071|  33.5k|	print_hex(buf, 0, left);
 1072|       |
 1073|  33.5k|	if (!ikev2_msg_frompeer(msg))
  ------------------
  |  Branch (1073:6): [True: 1.88k, False: 31.6k]
  ------------------
 1074|  1.88k|		return (0);
 1075|       |
 1076|  31.6k|	switch (type) {
  ------------------
  |  Branch (1076:10): [True: 2.29k, False: 29.3k]
  ------------------
 1077|  3.34k|	case IKEV2_N_NAT_DETECTION_SOURCE_IP:
  ------------------
  |  |  330|  3.34k|#define IKEV2_N_NAT_DETECTION_SOURCE_IP		16388	/* RFC7296 */
  ------------------
  |  Branch (1077:2): [True: 3.34k, False: 28.2k]
  ------------------
 1078|  25.9k|	case IKEV2_N_NAT_DETECTION_DESTINATION_IP:
  ------------------
  |  |  331|  25.9k|#define IKEV2_N_NAT_DETECTION_DESTINATION_IP	16389	/* RFC7296 */
  ------------------
  |  Branch (1078:2): [True: 22.6k, False: 8.97k]
  ------------------
 1079|  25.9k|		if (left != sizeof(md)) {
  ------------------
  |  Branch (1079:7): [True: 17, False: 25.9k]
  ------------------
 1080|     17|			log_debug("%s: malformed payload: hash size mismatch"
 1081|     17|			    " (%zu != %zu)", __func__, left, sizeof(md));
 1082|     17|			return (-1);
 1083|     17|		}
 1084|  25.9k|		if (ikev2_nat_detection(env, msg, md, sizeof(md), type,
  ------------------
  |  Branch (1084:7): [True: 0, False: 25.9k]
  ------------------
 1085|  25.9k|		    ikev2_msg_frompeer(msg)) == -1)
 1086|      0|			return (-1);
 1087|  25.9k|		if (memcmp(buf, md, left) != 0) {
  ------------------
  |  Branch (1087:7): [True: 25.8k, False: 147]
  ------------------
 1088|  25.8k|			log_debug("%s: %s detected NAT", __func__,
 1089|  25.8k|			    print_map(type, ikev2_n_map));
 1090|  25.8k|			if (type == IKEV2_N_NAT_DETECTION_SOURCE_IP)
  ------------------
  |  |  330|  25.8k|#define IKEV2_N_NAT_DETECTION_SOURCE_IP		16388	/* RFC7296 */
  ------------------
  |  Branch (1090:8): [True: 3.34k, False: 22.4k]
  ------------------
 1091|  3.34k|				msg->msg_parent->msg_nat_detected
 1092|  3.34k|				    |= IKED_MSG_NAT_SRC_IP;
  ------------------
  |  |  687|  3.34k|#define IKED_MSG_NAT_SRC_IP				0x01
  ------------------
 1093|  22.4k|			else
 1094|  22.4k|				msg->msg_parent->msg_nat_detected
 1095|  22.4k|				    |= IKED_MSG_NAT_DST_IP;
  ------------------
  |  |  688|  22.4k|#define IKED_MSG_NAT_DST_IP				0x02
  ------------------
 1096|  25.8k|		}
 1097|  25.9k|		print_hex(md, 0, sizeof(md));
 1098|       |		/* remember for MOBIKE */
 1099|  25.9k|		msg->msg_parent->msg_natt_rcvd = 1;
 1100|  25.9k|		break;
 1101|      6|	case IKEV2_N_AUTHENTICATION_FAILED:
  ------------------
  |  |  314|      6|#define IKEV2_N_AUTHENTICATION_FAILED		24	/* RFC7296 */
  ------------------
  |  Branch (1101:2): [True: 6, False: 31.6k]
  ------------------
 1102|      6|		if (!msg->msg_e) {
  ------------------
  |  Branch (1102:7): [True: 0, False: 6]
  ------------------
 1103|      0|			log_debug("%s: AUTHENTICATION_FAILED not encrypted",
 1104|      0|			    __func__);
 1105|      0|			return (-1);
 1106|      0|		}
 1107|       |		/*
 1108|       |		 * If we are the responder, then we only accept
 1109|       |		 * AUTHENTICATION_FAILED from authenticated peers.
 1110|       |		 * If we are the initiator, the peer cannot be authenticated.
 1111|       |		 */
 1112|      6|		if (!sa->sa_hdr.sh_initiator) {
  ------------------
  |  Branch (1112:7): [True: 6, False: 0]
  ------------------
 1113|      6|			if (!sa_stateok(sa, IKEV2_STATE_VALID)) {
  ------------------
  |  |   41|      6|#define IKEV2_STATE_VALID		7	/* authenticated AND validated certs */
  ------------------
  |  Branch (1113:8): [True: 6, False: 0]
  ------------------
 1114|      6|				log_debug("%s: ignoring AUTHENTICATION_FAILED"
 1115|      6|				    " from unauthenticated initiator",
 1116|      6|				    __func__);
 1117|      6|				return (-1);
 1118|      6|			}
 1119|      6|		} else {
 1120|      0|			if (sa_stateok(sa, IKEV2_STATE_VALID)) {
  ------------------
  |  |   41|      0|#define IKEV2_STATE_VALID		7	/* authenticated AND validated certs */
  ------------------
  |  Branch (1120:8): [True: 0, False: 0]
  ------------------
 1121|      0|				log_debug("%s: ignoring AUTHENTICATION_FAILED"
 1122|      0|				    " from authenticated responder",
 1123|      0|				    __func__);
 1124|      0|				return (-1);
 1125|      0|			}
 1126|      0|		}
 1127|      0|		msg->msg_parent->msg_flags
 1128|      0|		    |= IKED_MSG_FLAGS_AUTHENTICATION_FAILED;
  ------------------
  |  |  695|      0|#define IKED_MSG_FLAGS_AUTHENTICATION_FAILED		0x0020
  ------------------
 1129|      0|		break;
 1130|    143|	case IKEV2_N_INVALID_KE_PAYLOAD:
  ------------------
  |  |  313|    143|#define IKEV2_N_INVALID_KE_PAYLOAD		17	/* RFC7296 */
  ------------------
  |  Branch (1130:2): [True: 143, False: 31.4k]
  ------------------
 1131|    143|		if (sa_stateok(sa, IKEV2_STATE_VALID) &&
  ------------------
  |  |   41|    143|#define IKEV2_STATE_VALID		7	/* authenticated AND validated certs */
  ------------------
  |  Branch (1131:7): [True: 0, False: 143]
  ------------------
 1132|    143|		    !msg->msg_e) {
  ------------------
  |  Branch (1132:7): [True: 0, False: 0]
  ------------------
 1133|      0|			log_debug("%s: INVALID_KE_PAYLOAD not encrypted",
 1134|      0|			    __func__);
 1135|      0|			return (-1);
 1136|      0|		}
 1137|    143|		if (left != sizeof(msg->msg_parent->msg_group)) {
  ------------------
  |  Branch (1137:7): [True: 4, False: 139]
  ------------------
 1138|      4|			log_debug("%s: malformed payload: group size mismatch"
 1139|      4|			    " (%zu != %zu)", __func__, left,
 1140|      4|			    sizeof(msg->msg_parent->msg_group));
 1141|      4|			return (-1);
 1142|      4|		}
 1143|    139|		memcpy(&msg->msg_parent->msg_group, buf, left);
 1144|    139|		msg->msg_parent->msg_flags |= IKED_MSG_FLAGS_INVALID_KE;
  ------------------
  |  |  696|    139|#define IKED_MSG_FLAGS_INVALID_KE			0x0040
  ------------------
 1145|    139|		break;
 1146|    251|	case IKEV2_N_NO_ADDITIONAL_SAS:
  ------------------
  |  |  316|    251|#define IKEV2_N_NO_ADDITIONAL_SAS		35	/* RFC7296 */
  ------------------
  |  Branch (1146:2): [True: 251, False: 31.3k]
  ------------------
 1147|    251|		if (!msg->msg_e) {
  ------------------
  |  Branch (1147:7): [True: 0, False: 251]
  ------------------
 1148|      0|			log_debug("%s: NO_ADDITIONAL_SAS not encrypted",
 1149|      0|			    __func__);
 1150|      0|			return (-1);
 1151|      0|		}
 1152|    251|		msg->msg_parent->msg_flags |= IKED_MSG_FLAGS_NO_ADDITIONAL_SAS;
  ------------------
  |  |  694|    251|#define IKED_MSG_FLAGS_NO_ADDITIONAL_SAS		0x0010
  ------------------
 1153|    251|		break;
 1154|     77|	case IKEV2_N_REKEY_SA:
  ------------------
  |  |  335|     77|#define IKEV2_N_REKEY_SA			16393	/* RFC7296 */
  ------------------
  |  Branch (1154:2): [True: 77, False: 31.5k]
  ------------------
 1155|     77|		if (!msg->msg_e) {
  ------------------
  |  Branch (1155:7): [True: 0, False: 77]
  ------------------
 1156|      0|			log_debug("%s: N_REKEY_SA not encrypted", __func__);
 1157|      0|			return (-1);
 1158|      0|		}
 1159|     77|		if (left != n.n_spisize) {
  ------------------
  |  Branch (1159:7): [True: 5, False: 72]
  ------------------
 1160|      5|			log_debug("%s: malformed notification", __func__);
 1161|      5|			return (-1);
 1162|      5|		}
 1163|     72|		rekey = &msg->msg_parent->msg_rekey;
 1164|     72|		if (rekey->spi != 0) {
  ------------------
  |  Branch (1164:7): [True: 5, False: 67]
  ------------------
 1165|      5|			log_debug("%s: rekeying of multiple SAs not supported",
 1166|      5|			    __func__);
 1167|      5|			return (-1);
 1168|      5|		}
 1169|     67|		switch (n.n_spisize) {
 1170|     61|		case 4:
  ------------------
  |  Branch (1170:3): [True: 61, False: 6]
  ------------------
 1171|     61|			memcpy(&spi32, buf, left);
 1172|     61|			rekey->spi = betoh32(spi32);
 1173|     61|			break;
 1174|      3|		case 8:
  ------------------
  |  Branch (1174:3): [True: 3, False: 64]
  ------------------
 1175|      3|			memcpy(&spi64, buf, left);
 1176|      3|			rekey->spi = betoh64(spi64);
 1177|      3|			break;
 1178|      3|		default:
  ------------------
  |  Branch (1178:3): [True: 3, False: 64]
  ------------------
 1179|      3|			log_debug("%s: invalid spi size %d", __func__,
 1180|      3|			    n.n_spisize);
 1181|      3|			return (-1);
 1182|     67|		}
 1183|     64|		rekey->spi_size = n.n_spisize;
 1184|     64|		rekey->spi_protoid = n.n_protoid;
 1185|       |
 1186|     64|		log_debug("%s: rekey %s spi %s", __func__,
 1187|     64|		    print_map(n.n_protoid, ikev2_saproto_map),
 1188|     64|		    print_spi(rekey->spi, n.n_spisize));
 1189|     64|		break;
 1190|    351|	case IKEV2_N_TEMPORARY_FAILURE:
  ------------------
  |  |  324|    351|#define IKEV2_N_TEMPORARY_FAILURE		43	/* RFC7296 */
  ------------------
  |  Branch (1190:2): [True: 351, False: 31.2k]
  ------------------
 1191|    351|		if (!msg->msg_e) {
  ------------------
  |  Branch (1191:7): [True: 0, False: 351]
  ------------------
 1192|      0|			log_debug("%s: IKEV2_N_TEMPORARY_FAILURE not encrypted",
 1193|      0|			    __func__);
 1194|      0|			return (-1);
 1195|      0|		}
 1196|    351|		msg->msg_parent->msg_flags |= IKED_MSG_FLAGS_TEMPORARY_FAILURE;
  ------------------
  |  |  699|    351|#define IKED_MSG_FLAGS_TEMPORARY_FAILURE		0x0200
  ------------------
 1197|    351|		break;
 1198|    255|	case IKEV2_N_IPCOMP_SUPPORTED:
  ------------------
  |  |  329|    255|#define IKEV2_N_IPCOMP_SUPPORTED		16387	/* RFC7296 */
  ------------------
  |  Branch (1198:2): [True: 255, False: 31.3k]
  ------------------
 1199|    255|		if (!msg->msg_e) {
  ------------------
  |  Branch (1199:7): [True: 0, False: 255]
  ------------------
 1200|      0|			log_debug("%s: N_IPCOMP_SUPPORTED not encrypted",
 1201|      0|			    __func__);
 1202|      0|			return (-1);
 1203|      0|		}
 1204|    255|		if (left < sizeof(msg->msg_parent->msg_cpi) +
  ------------------
  |  Branch (1204:7): [True: 127, False: 128]
  ------------------
 1205|    255|		    sizeof(msg->msg_parent->msg_transform)) {
 1206|    127|			log_debug("%s: ignoring malformed ipcomp notification",
 1207|    127|			    __func__);
 1208|    127|			return (0);
 1209|    127|		}
 1210|    128|		memcpy(&msg->msg_parent->msg_cpi, buf,
 1211|    128|		    sizeof(msg->msg_parent->msg_cpi));
 1212|    128|		memcpy(&msg->msg_parent->msg_transform,
 1213|    128|		    buf + sizeof(msg->msg_parent->msg_cpi),
 1214|    128|		    sizeof(msg->msg_parent->msg_transform));
 1215|       |
 1216|    128|		log_debug("%s: %s cpi 0x%x, transform %s, length %zu", __func__,
 1217|    128|		    msg->msg_parent->msg_response ? "res" : "req",
  ------------------
  |  Branch (1217:7): [True: 0, False: 128]
  ------------------
 1218|    128|		    betoh16(msg->msg_parent->msg_cpi),
 1219|    128|		    print_map(msg->msg_parent->msg_transform,
 1220|    128|		    ikev2_ipcomp_map), left);
 1221|       |
 1222|    128|		msg->msg_parent->msg_flags |= IKED_MSG_FLAGS_IPCOMP_SUPPORTED;
  ------------------
  |  |  697|    128|#define IKED_MSG_FLAGS_IPCOMP_SUPPORTED			0x0080
  ------------------
 1223|    128|		break;
 1224|     73|	case IKEV2_N_CHILD_SA_NOT_FOUND:
  ------------------
  |  |  325|     73|#define IKEV2_N_CHILD_SA_NOT_FOUND		44	/* RFC7296 */
  ------------------
  |  Branch (1224:2): [True: 73, False: 31.5k]
  ------------------
 1225|     73|		if (!msg->msg_e) {
  ------------------
  |  Branch (1225:7): [True: 0, False: 73]
  ------------------
 1226|      0|			log_debug("%s: N_CHILD_SA_NOT_FOUND not encrypted",
 1227|      0|			    __func__);
 1228|      0|			return (-1);
 1229|      0|		}
 1230|     73|		msg->msg_parent->msg_flags |= IKED_MSG_FLAGS_CHILD_SA_NOT_FOUND;
  ------------------
  |  |  693|     73|#define IKED_MSG_FLAGS_CHILD_SA_NOT_FOUND		0x0008
  ------------------
 1231|     73|		break;
 1232|     36|	case IKEV2_N_NO_PROPOSAL_CHOSEN:
  ------------------
  |  |  312|     36|#define IKEV2_N_NO_PROPOSAL_CHOSEN		14	/* RFC7296 */
  ------------------
  |  Branch (1232:2): [True: 36, False: 31.5k]
  ------------------
 1233|     36|		msg->msg_parent->msg_flags |= IKED_MSG_FLAGS_NO_PROPOSAL_CHOSEN;
  ------------------
  |  |  700|     36|#define IKED_MSG_FLAGS_NO_PROPOSAL_CHOSEN		0x0400
  ------------------
 1234|     36|		break;
 1235|  1.15k|	case IKEV2_N_MOBIKE_SUPPORTED:
  ------------------
  |  |  338|  1.15k|#define IKEV2_N_MOBIKE_SUPPORTED		16396	/* RFC4555 */
  ------------------
  |  Branch (1235:2): [True: 1.15k, False: 30.4k]
  ------------------
 1236|  1.15k|		if (!msg->msg_e) {
  ------------------
  |  Branch (1236:7): [True: 0, False: 1.15k]
  ------------------
 1237|      0|			log_debug("%s: N_MOBIKE_SUPPORTED not encrypted",
 1238|      0|			    __func__);
 1239|      0|			return (-1);
 1240|      0|		}
 1241|  1.15k|		if (left != 0) {
  ------------------
  |  Branch (1241:7): [True: 1.01k, False: 142]
  ------------------
 1242|  1.01k|			log_debug("%s: ignoring malformed mobike"
 1243|  1.01k|			    " notification: %zu", __func__, left);
 1244|  1.01k|			return (0);
 1245|  1.01k|		}
 1246|    142|		msg->msg_parent->msg_flags |= IKED_MSG_FLAGS_MOBIKE;
  ------------------
  |  |  691|    142|#define IKED_MSG_FLAGS_MOBIKE				0x0002
  ------------------
 1247|    142|		break;
 1248|    356|	case IKEV2_N_USE_TRANSPORT_MODE:
  ------------------
  |  |  333|    356|#define IKEV2_N_USE_TRANSPORT_MODE		16391	/* RFC7296 */
  ------------------
  |  Branch (1248:2): [True: 356, False: 31.2k]
  ------------------
 1249|    356|		if (!msg->msg_e) {
  ------------------
  |  Branch (1249:7): [True: 0, False: 356]
  ------------------
 1250|      0|			log_debug("%s: N_USE_TRANSPORT_MODE not encrypted",
 1251|      0|			    __func__);
 1252|      0|			return (-1);
 1253|      0|		}
 1254|    356|		if (left != 0) {
  ------------------
  |  Branch (1254:7): [True: 77, False: 279]
  ------------------
 1255|     77|			log_debug("%s: ignoring malformed transport mode"
 1256|     77|			    " notification: %zu", __func__, left);
 1257|     77|			return (0);
 1258|     77|		}
 1259|    279|		if (msg->msg_parent->msg_response) {
  ------------------
  |  Branch (1259:7): [True: 0, False: 279]
  ------------------
 1260|      0|			if (!(msg->msg_policy->pol_flags & IKED_POLICY_TRANSPORT)) {
  ------------------
  |  |  266|      0|#define IKED_POLICY_TRANSPORT		 0x40
  ------------------
  |  Branch (1260:8): [True: 0, False: 0]
  ------------------
 1261|      0|				log_debug("%s: ignoring transport mode"
 1262|      0|				    " notification (policy)", __func__);
 1263|      0|				return (0);
 1264|      0|			}
 1265|      0|		}
 1266|    279|		msg->msg_parent->msg_flags |= IKED_MSG_FLAGS_USE_TRANSPORT;
  ------------------
  |  |  698|    279|#define IKED_MSG_FLAGS_USE_TRANSPORT			0x0100
  ------------------
 1267|    279|		break;
 1268|    388|	case IKEV2_N_UPDATE_SA_ADDRESSES:
  ------------------
  |  |  342|    388|#define IKEV2_N_UPDATE_SA_ADDRESSES		16400	/* RFC4555 */
  ------------------
  |  Branch (1268:2): [True: 388, False: 31.2k]
  ------------------
 1269|    388|		if (!msg->msg_e) {
  ------------------
  |  Branch (1269:7): [True: 0, False: 388]
  ------------------
 1270|      0|			log_debug("%s: N_UPDATE_SA_ADDRESSES not encrypted",
 1271|      0|			    __func__);
 1272|      0|			return (-1);
 1273|      0|		}
 1274|    388|		if (!sa->sa_mobike) {
  ------------------
  |  Branch (1274:7): [True: 388, False: 0]
  ------------------
 1275|    388|			log_debug("%s: ignoring update sa addresses"
 1276|    388|			    " notification w/o mobike: %zu", __func__, left);
 1277|    388|			return (0);
 1278|    388|		}
 1279|      0|		if (left != 0) {
  ------------------
  |  Branch (1279:7): [True: 0, False: 0]
  ------------------
 1280|      0|			log_debug("%s: ignoring malformed update sa addresses"
 1281|      0|			    " notification: %zu", __func__, left);
 1282|      0|			return (0);
 1283|      0|		}
 1284|      0|		msg->msg_parent->msg_update_sa_addresses = 1;
 1285|      0|		break;
 1286|    218|	case IKEV2_N_COOKIE2:
  ------------------
  |  |  343|    218|#define IKEV2_N_COOKIE2				16401	/* RFC4555 */
  ------------------
  |  Branch (1286:2): [True: 218, False: 31.4k]
  ------------------
 1287|    218|		if (!msg->msg_e) {
  ------------------
  |  Branch (1287:7): [True: 0, False: 218]
  ------------------
 1288|      0|			log_debug("%s: N_COOKIE2 not encrypted",
 1289|      0|			    __func__);
 1290|      0|			return (-1);
 1291|      0|		}
 1292|    218|		if (!sa->sa_mobike) {
  ------------------
  |  Branch (1292:7): [True: 218, False: 0]
  ------------------
 1293|    218|			log_debug("%s: ignoring cookie2 notification"
 1294|    218|			    " w/o mobike: %zu", __func__, left);
 1295|    218|			return (0);
 1296|    218|		}
 1297|      0|		if (left < IKED_COOKIE2_MIN || left > IKED_COOKIE2_MAX) {
  ------------------
  |  |   61|      0|#define IKED_COOKIE2_MIN	8	/* min 8 bytes */
  ------------------
              		if (left < IKED_COOKIE2_MIN || left > IKED_COOKIE2_MAX) {
  ------------------
  |  |   62|      0|#define IKED_COOKIE2_MAX	64	/* max 64 bytes */
  ------------------
  |  Branch (1297:7): [True: 0, False: 0]
  |  Branch (1297:34): [True: 0, False: 0]
  ------------------
 1298|      0|			log_debug("%s: ignoring malformed cookie2"
 1299|      0|			    " notification: %zu", __func__, left);
 1300|      0|			return (0);
 1301|      0|		}
 1302|      0|		ibuf_free(msg->msg_cookie2);	/* should not happen */
 1303|      0|		if ((msg->msg_cookie2 = ibuf_new(buf, left)) == NULL) {
  ------------------
  |  Branch (1303:7): [True: 0, False: 0]
  ------------------
 1304|      0|			log_debug("%s: failed to get peer cookie2", __func__);
 1305|      0|			return (-1);
 1306|      0|		}
 1307|      0|		msg->msg_parent->msg_cookie2 = msg->msg_cookie2;
 1308|      0|		break;
 1309|      2|	case IKEV2_N_COOKIE:
  ------------------
  |  |  332|      2|#define IKEV2_N_COOKIE				16390	/* RFC7296 */
  ------------------
  |  Branch (1309:2): [True: 2, False: 31.6k]
  ------------------
 1310|      2|		if (msg->msg_e) {
  ------------------
  |  Branch (1310:7): [True: 2, False: 0]
  ------------------
 1311|      2|			log_debug("%s: N_COOKIE encrypted",
 1312|      2|			    __func__);
 1313|      2|			return (-1);
 1314|      2|		}
 1315|      0|		if (left < IKED_COOKIE_MIN || left > IKED_COOKIE_MAX) {
  ------------------
  |  |   58|      0|#define IKED_COOKIE_MIN		1	/* min 1 bytes */
  ------------------
              		if (left < IKED_COOKIE_MIN || left > IKED_COOKIE_MAX) {
  ------------------
  |  |   59|      0|#define IKED_COOKIE_MAX		64	/* max 64 bytes */
  ------------------
  |  Branch (1315:7): [True: 0, False: 0]
  |  Branch (1315:33): [True: 0, False: 0]
  ------------------
 1316|      0|			log_debug("%s: ignoring malformed cookie"
 1317|      0|			    " notification: %zu", __func__, left);
 1318|      0|			return (0);
 1319|      0|		}
 1320|      0|		log_debug("%s: received cookie, len %zu", __func__, left);
 1321|      0|		print_hex(buf, 0, left);
 1322|       |
 1323|      0|		ibuf_free(msg->msg_cookie);
 1324|      0|		if ((msg->msg_cookie = ibuf_new(buf, left)) == NULL) {
  ------------------
  |  Branch (1324:7): [True: 0, False: 0]
  ------------------
 1325|      0|			log_debug("%s: failed to get peer cookie", __func__);
 1326|      0|			return (-1);
 1327|      0|		}
 1328|      0|		msg->msg_parent->msg_cookie = msg->msg_cookie;
 1329|      0|		break;
 1330|     14|	case IKEV2_N_FRAGMENTATION_SUPPORTED:
  ------------------
  |  |  371|     14|#define IKEV2_N_FRAGMENTATION_SUPPORTED		16430	/* RFC7383 */
  ------------------
  |  Branch (1330:2): [True: 14, False: 31.6k]
  ------------------
 1331|     14|		if (msg->msg_e) {
  ------------------
  |  Branch (1331:7): [True: 14, False: 0]
  ------------------
 1332|     14|			log_debug("%s: N_FRAGMENTATION_SUPPORTED encrypted",
 1333|     14|			    __func__);
 1334|     14|			return (-1);
 1335|     14|		}
 1336|      0|		if (left != 0) {
  ------------------
  |  Branch (1336:7): [True: 0, False: 0]
  ------------------
 1337|      0|			log_debug("%s: ignoring malformed fragmentation"
 1338|      0|			    " notification: %zu", __func__, left);
 1339|      0|			return (0);
 1340|      0|		}
 1341|      0|		msg->msg_parent->msg_flags |= IKED_MSG_FLAGS_FRAGMENTATION;
  ------------------
  |  |  690|      0|#define IKED_MSG_FLAGS_FRAGMENTATION			0x0001
  ------------------
 1342|      0|		break;
 1343|      7|	case IKEV2_N_SIGNATURE_HASH_ALGORITHMS:
  ------------------
  |  |  372|      7|#define IKEV2_N_SIGNATURE_HASH_ALGORITHMS	16431	/* RFC7427 */
  ------------------
  |  Branch (1343:2): [True: 7, False: 31.6k]
  ------------------
 1344|      7|		if (msg->msg_e) {
  ------------------
  |  Branch (1344:7): [True: 7, False: 0]
  ------------------
 1345|      7|			log_debug("%s: SIGNATURE_HASH_ALGORITHMS: encrypted",
 1346|      7|			    __func__);
 1347|      7|			return (-1);
 1348|      7|		}
 1349|      0|		if (sa == NULL) {
  ------------------
  |  Branch (1349:7): [True: 0, False: 0]
  ------------------
 1350|      0|			log_debug("%s: SIGNATURE_HASH_ALGORITHMS: no SA",
 1351|      0|			    __func__);
 1352|      0|			return (-1);
 1353|      0|		}
 1354|      0|		if (sa->sa_sigsha2) {
  ------------------
  |  Branch (1354:7): [True: 0, False: 0]
  ------------------
 1355|      0|			log_debug("%s: SIGNATURE_HASH_ALGORITHMS: "
 1356|      0|			    "duplicate notify", __func__);
 1357|      0|			return (0);
 1358|      0|		}
 1359|      0|		if (left < sizeof(signature_hash) ||
  ------------------
  |  Branch (1359:7): [True: 0, False: 0]
  ------------------
 1360|      0|		    left % sizeof(signature_hash)) {
  ------------------
  |  Branch (1360:7): [True: 0, False: 0]
  ------------------
 1361|      0|			log_debug("%s: malformed signature hash notification"
 1362|      0|			    "(%zu bytes)", __func__, left);
 1363|      0|			return (0);
 1364|      0|		}
 1365|      0|		while (left >= sizeof(signature_hash)) {
  ------------------
  |  Branch (1365:10): [True: 0, False: 0]
  ------------------
 1366|      0|			memcpy(&signature_hash, buf, sizeof(signature_hash));
 1367|      0|			signature_hash = betoh16(signature_hash);
 1368|      0|			log_debug("%s: signature hash %s (%x)", __func__,
 1369|      0|			    print_map(signature_hash, ikev2_sighash_map),
 1370|      0|			    signature_hash);
 1371|      0|			left -= sizeof(signature_hash);
 1372|      0|			buf += sizeof(signature_hash);
 1373|      0|			if (signature_hash == IKEV2_SIGHASH_SHA2_256)
  ------------------
  |  |  499|      0|#define IKEV2_SIGHASH_SHA2_256		2	/* RFC7427 */
  ------------------
  |  Branch (1373:8): [True: 0, False: 0]
  ------------------
 1374|      0|				msg->msg_parent->msg_flags
 1375|      0|				    |= IKED_MSG_FLAGS_SIGSHA2;
  ------------------
  |  |  692|      0|#define IKED_MSG_FLAGS_SIGSHA2				0x0004
  ------------------
 1376|      0|		}
 1377|      0|		break;
 1378|  31.6k|	}
 1379|       |
 1380|  29.7k|	return (0);
 1381|  31.6k|}
ikev2_validate_delete:
 1386|  7.19k|{
 1387|  7.19k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
 1388|       |
 1389|  7.19k|	if (left < sizeof(*del)) {
  ------------------
  |  Branch (1389:6): [True: 1.40k, False: 5.79k]
  ------------------
 1390|  1.40k|		log_debug("%s: malformed payload: too short for header "
 1391|  1.40k|		    "(%zu < %zu)", __func__, left, sizeof(*del));
 1392|  1.40k|		return (-1);
 1393|  1.40k|	}
 1394|  5.79k|	memcpy(del, msgbuf + offset, sizeof(*del));
 1395|       |
 1396|  5.79k|	if (del->del_protoid == 0) {
  ------------------
  |  Branch (1396:6): [True: 84, False: 5.70k]
  ------------------
 1397|     84|		log_info("%s: malformed payload: invalid protoid", __func__);
 1398|     84|		return (-1);
 1399|     84|	}
 1400|       |
 1401|  5.70k|	return (0);
 1402|  5.79k|}
ikev2_pld_delete:
 1407|  7.19k|{
 1408|  7.19k|	struct ikev2_delete	 del;
 1409|  7.19k|	uint8_t			*buf, *msgbuf = ibuf_data(msg->msg_data);
 1410|  7.19k|	size_t			 cnt, sz, len;
 1411|       |
 1412|  7.19k|	if (ikev2_validate_delete(msg, offset, left, &del))
  ------------------
  |  Branch (1412:6): [True: 1.48k, False: 5.70k]
  ------------------
 1413|  1.48k|		return (-1);
 1414|       |
 1415|       |	/* Skip if it's a response, then we don't have to deal with it */
 1416|  5.70k|	if (ikev2_msg_frompeer(msg) &&
  ------------------
  |  Branch (1416:6): [True: 168, False: 5.53k]
  ------------------
 1417|  5.70k|	    msg->msg_parent->msg_response)
  ------------------
  |  Branch (1417:6): [True: 0, False: 168]
  ------------------
 1418|      0|		return (0);
 1419|       |
 1420|  5.70k|	cnt = betoh16(del.del_nspi);
 1421|  5.70k|	sz = del.del_spisize;
 1422|       |
 1423|  5.70k|	log_debug("%s: proto %s spisize %zu nspi %zu",
 1424|  5.70k|	    __func__, print_map(del.del_protoid, ikev2_saproto_map),
 1425|  5.70k|	    sz, cnt);
 1426|       |
 1427|  5.70k|	if (msg->msg_parent->msg_del_protoid) {
  ------------------
  |  Branch (1427:6): [True: 5.36k, False: 341]
  ------------------
 1428|  5.36k|		log_debug("%s: duplicate delete payload", __func__);
 1429|  5.36k|		return (0);
 1430|  5.36k|	}
 1431|       |
 1432|    341|	msg->msg_parent->msg_del_protoid = del.del_protoid;
 1433|    341|	msg->msg_parent->msg_del_cnt = cnt;
 1434|    341|	msg->msg_parent->msg_del_spisize = sz;
 1435|       |
 1436|    341|	buf = msgbuf + offset + sizeof(del);
 1437|    341|	len = left - sizeof(del);
 1438|    341|	if (len == 0 || sz == 0 || cnt == 0)
  ------------------
  |  Branch (1438:6): [True: 17, False: 324]
  |  Branch (1438:18): [True: 250, False: 74]
  |  Branch (1438:29): [True: 51, False: 23]
  ------------------
 1439|    318|		return (0);
 1440|       |
 1441|     23|	if ((len / sz) != cnt) {
  ------------------
  |  Branch (1441:6): [True: 21, False: 2]
  ------------------
 1442|     21|		log_debug("%s: invalid payload length %zu/%zu != %zu",
 1443|     21|		    __func__, len, sz, cnt);
 1444|     21|		return (-1);
 1445|     21|	}
 1446|       |
 1447|      2|	print_hex(buf, 0, len);
 1448|       |
 1449|      2|	msg->msg_parent->msg_del_buf = ibuf_new(buf, len);
 1450|       |
 1451|      2|	return (0);
 1452|     23|}
ikev2_validate_tss:
 1457|  19.0k|{
 1458|  19.0k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
 1459|       |
 1460|  19.0k|	if (left < sizeof(*tsp)) {
  ------------------
  |  Branch (1460:6): [True: 2.56k, False: 16.4k]
  ------------------
 1461|  2.56k|		log_debug("%s: malformed payload: too short for header "
 1462|  2.56k|		    "(%zu < %zu)", __func__, left, sizeof(*tsp));
 1463|  2.56k|		return (-1);
 1464|  2.56k|	}
 1465|  16.4k|	memcpy(tsp, msgbuf + offset, sizeof(*tsp));
 1466|       |
 1467|  16.4k|	return (0);
 1468|  19.0k|}
ikev2_pld_tss:
 1473|  19.0k|{
 1474|  19.0k|	struct ikev2_tsp		 tsp;
 1475|  19.0k|	struct ikev2_ts			 ts;
 1476|  19.0k|	size_t				 ts_len, i;
 1477|       |
 1478|  19.0k|	if (ikev2_validate_tss(msg, offset, left, &tsp))
  ------------------
  |  Branch (1478:6): [True: 2.56k, False: 16.4k]
  ------------------
 1479|  2.56k|		return (-1);
 1480|       |
 1481|  16.4k|	offset += sizeof(tsp);
 1482|  16.4k|	left -= sizeof(tsp);
 1483|       |
 1484|  16.4k|	log_debug("%s: count %d length %zu", __func__,
 1485|  16.4k|	    tsp.tsp_count, left);
 1486|       |
 1487|  32.1k|	for (i = 0; i < tsp.tsp_count; i++) {
  ------------------
  |  Branch (1487:14): [True: 30.5k, False: 1.66k]
  ------------------
 1488|  30.5k|		if (ikev2_validate_ts(msg, offset, left, &ts))
  ------------------
  |  Branch (1488:7): [True: 13.1k, False: 17.4k]
  ------------------
 1489|  13.1k|			return (-1);
 1490|       |
 1491|  17.4k|		log_debug("%s: type %s protoid %u length %d "
 1492|  17.4k|		    "startport %u endport %u", __func__,
 1493|  17.4k|		    print_map(ts.ts_type, ikev2_ts_map),
 1494|  17.4k|		    ts.ts_protoid, betoh16(ts.ts_length),
 1495|  17.4k|		    betoh16(ts.ts_startport),
 1496|  17.4k|		    betoh16(ts.ts_endport));
 1497|       |
 1498|  17.4k|		offset += sizeof(ts);
 1499|  17.4k|		left -= sizeof(ts);
 1500|       |
 1501|  17.4k|		ts_len = betoh16(ts.ts_length) - sizeof(ts);
 1502|  17.4k|		if (ikev2_pld_ts(env, pld, msg, offset, ts_len, ts.ts_type))
  ------------------
  |  Branch (1502:7): [True: 1.70k, False: 15.7k]
  ------------------
 1503|  1.70k|			return (-1);
 1504|       |
 1505|  15.7k|		offset += ts_len;
 1506|  15.7k|		left -= ts_len;
 1507|  15.7k|	}
 1508|       |
 1509|  1.66k|	return (0);
 1510|  16.4k|}
ikev2_validate_ts:
 1515|  30.5k|{
 1516|  30.5k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
 1517|  30.5k|	size_t		 ts_length;
 1518|       |
 1519|  30.5k|	if (left < sizeof(*ts)) {
  ------------------
  |  Branch (1519:6): [True: 11.8k, False: 18.6k]
  ------------------
 1520|  11.8k|		log_debug("%s: malformed payload: too short for header "
 1521|  11.8k|		    "(%zu < %zu)", __func__, left, sizeof(*ts));
 1522|  11.8k|		return (-1);
 1523|  11.8k|	}
 1524|  18.6k|	memcpy(ts, msgbuf + offset, sizeof(*ts));
 1525|       |
 1526|  18.6k|	ts_length = betoh16(ts->ts_length);
 1527|  18.6k|	if (ts_length < sizeof(*ts)) {
  ------------------
  |  Branch (1527:6): [True: 321, False: 18.3k]
  ------------------
 1528|    321|		log_debug("%s: malformed payload: shorter than minimum header "
 1529|    321|		    "size (%zu < %zu)", __func__, ts_length, sizeof(*ts));
 1530|    321|		return (-1);
 1531|    321|	}
 1532|  18.3k|	if (left < ts_length) {
  ------------------
  |  Branch (1532:6): [True: 895, False: 17.4k]
  ------------------
 1533|    895|		log_debug("%s: malformed payload: too long for payload size "
 1534|    895|		    "(%zu < %zu)", __func__, left, ts_length);
 1535|    895|		return (-1);
 1536|    895|	}
 1537|       |
 1538|  17.4k|	return (0);
 1539|  18.3k|}
ikev2_pld_ts:
 1544|  17.4k|{
 1545|  17.4k|	struct sockaddr_in		 start4, end4;
 1546|  17.4k|	struct sockaddr_in6		 start6, end6;
 1547|  17.4k|	uint8_t				*msgbuf = ibuf_data(msg->msg_data);
 1548|  17.4k|	uint8_t				*ptr;
 1549|       |
 1550|  17.4k|	ptr = msgbuf + offset;
 1551|       |
 1552|  17.4k|	switch (type) {
 1553|  6.42k|	case IKEV2_TS_IPV4_ADDR_RANGE:
  ------------------
  |  |  460|  6.42k|#define IKEV2_TS_IPV4_ADDR_RANGE	7	/* RFC7296 */
  ------------------
  |  Branch (1553:2): [True: 6.42k, False: 10.9k]
  ------------------
 1554|  6.42k|		if (left < 2 * 4) {
  ------------------
  |  Branch (1554:7): [True: 323, False: 6.10k]
  ------------------
 1555|    323|			log_debug("%s: malformed payload: too short "
 1556|    323|			    "for ipv4 addr range (%zu < %u)",
 1557|    323|			    __func__, left, 2 * 4);
 1558|    323|			return (-1);
 1559|    323|		}
 1560|       |
 1561|  6.10k|		bzero(&start4, sizeof(start4));
 1562|  6.10k|		start4.sin_family = AF_INET;
 1563|       |#ifdef HAVE_SOCKADDR_SA_LEN
 1564|       |		start4.sin_len = sizeof(start4);
 1565|       |#endif
 1566|  6.10k|		memcpy(&start4.sin_addr.s_addr, ptr, 4);
 1567|  6.10k|		ptr += 4;
 1568|  6.10k|		left -= 4;
 1569|       |
 1570|  6.10k|		bzero(&end4, sizeof(end4));
 1571|  6.10k|		end4.sin_family = AF_INET;
 1572|       |#ifdef HAVE_SOCKADDR_SA_LEN
 1573|       |		end4.sin_len = sizeof(end4);
 1574|       |#endif
 1575|  6.10k|		memcpy(&end4.sin_addr.s_addr, ptr, 4);
 1576|  6.10k|		left -= 4;
 1577|       |
 1578|  6.10k|		log_debug("%s: start %s end %s", __func__,
 1579|  6.10k|		    print_addr(&start4), print_addr(&end4));
 1580|  6.10k|		break;
 1581|  1.37k|	case IKEV2_TS_IPV6_ADDR_RANGE:
  ------------------
  |  |  461|  1.37k|#define IKEV2_TS_IPV6_ADDR_RANGE	8	/* RFC7296 */
  ------------------
  |  Branch (1581:2): [True: 1.37k, False: 16.0k]
  ------------------
 1582|  1.37k|		if (left < 2 * 16) {
  ------------------
  |  Branch (1582:7): [True: 252, False: 1.12k]
  ------------------
 1583|    252|			log_debug("%s: malformed payload: too short "
 1584|    252|			    "for ipv6 addr range (%zu < %u)",
 1585|    252|			    __func__, left, 2 * 16);
 1586|    252|			return (-1);
 1587|    252|		}
 1588|  1.12k|		bzero(&start6, sizeof(start6));
 1589|  1.12k|		start6.sin6_family = AF_INET6;
 1590|       |#ifdef HAVE_SOCKADDR_SA_LEN
 1591|       |		start6.sin6_len = sizeof(start6);
 1592|       |#endif
 1593|  1.12k|		memcpy(&start6.sin6_addr, ptr, 16);
 1594|  1.12k|		ptr += 16;
 1595|  1.12k|		left -= 16;
 1596|       |
 1597|  1.12k|		bzero(&end6, sizeof(end6));
 1598|  1.12k|		end6.sin6_family = AF_INET6;
 1599|       |#ifdef HAVE_SOCKADDR_SA_LEN
 1600|       |		end6.sin6_len = sizeof(end6);
 1601|       |#endif
 1602|  1.12k|		memcpy(&end6.sin6_addr, ptr, 16);
 1603|  1.12k|		left -= 16;
 1604|       |
 1605|  1.12k|		log_debug("%s: start %s end %s", __func__,
 1606|  1.12k|		    print_addr(&start6), print_addr(&end6));
 1607|  1.12k|		break;
 1608|  9.61k|	default:
  ------------------
  |  Branch (1608:2): [True: 9.61k, False: 7.80k]
  ------------------
 1609|  9.61k|		log_debug("%s: ignoring unknown TS type %u", __func__, type);
 1610|  9.61k|		return (0);
 1611|  17.4k|	}
 1612|       |
 1613|  7.22k|	if (left > 0) {
  ------------------
  |  Branch (1613:6): [True: 1.13k, False: 6.09k]
  ------------------
 1614|  1.13k|		log_debug("%s: malformed payload: left (%zu) > 0",
 1615|  1.13k|		    __func__, left);
 1616|  1.13k|		return (-1);
 1617|  1.13k|	}
 1618|       |
 1619|  6.09k|	return (0);
 1620|  7.22k|}
ikev2_validate_cp:
 1875|  10.1k|{
 1876|  10.1k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
 1877|       |
 1878|  10.1k|	if (left < sizeof(*cp)) {
  ------------------
  |  Branch (1878:6): [True: 3.17k, False: 6.97k]
  ------------------
 1879|  3.17k|		log_debug("%s: malformed payload: too short for header "
 1880|  3.17k|		    "(%zu < %zu)", __func__, left, sizeof(*cp));
 1881|  3.17k|		return (-1);
 1882|  3.17k|	}
 1883|  6.97k|	memcpy(cp, msgbuf + offset, sizeof(*cp));
 1884|       |
 1885|  6.97k|	return (0);
 1886|  10.1k|}
ikev2_pld_cp:
 1891|  10.1k|{
 1892|  10.1k|	struct ikev2_cp		 cp;
 1893|  10.1k|	struct ikev2_cfg	*cfg;
 1894|  10.1k|	struct iked_addr	*addr;
 1895|  10.1k|	struct sockaddr_in	*in4;
 1896|  10.1k|	struct sockaddr_in6	*in6;
 1897|  10.1k|	uint8_t			*msgbuf = ibuf_data(msg->msg_data);
 1898|  10.1k|	uint8_t			*ptr;
 1899|  10.1k|	size_t			 len;
 1900|  10.1k|	int			 cfg_type;
 1901|       |
 1902|  10.1k|	if (ikev2_validate_cp(msg, offset, left, &cp))
  ------------------
  |  Branch (1902:6): [True: 3.17k, False: 6.97k]
  ------------------
 1903|  3.17k|		return (-1);
 1904|       |
 1905|  6.97k|	ptr = msgbuf + offset + sizeof(cp);
 1906|  6.97k|	len = left - sizeof(cp);
 1907|       |
 1908|  6.97k|	log_debug("%s: type %s length %zu",
 1909|  6.97k|	    __func__, print_map(cp.cp_type, ikev2_cp_map), len);
 1910|  6.97k|	print_hex(ptr, 0, len);
 1911|       |
 1912|  14.9k|	while (len > 0) {
  ------------------
  |  Branch (1912:9): [True: 9.49k, False: 5.44k]
  ------------------
 1913|  9.49k|		if (len < sizeof(*cfg)) {
  ------------------
  |  Branch (1913:7): [True: 359, False: 9.13k]
  ------------------
 1914|    359|			log_debug("%s: malformed payload: too short for cfg "
 1915|    359|			    "(%zu < %zu)", __func__, len, sizeof(*cfg));
 1916|    359|			return (-1);
 1917|    359|		}
 1918|  9.13k|		cfg = (struct ikev2_cfg *)ptr;
 1919|       |
 1920|  9.13k|		log_debug("%s: %s 0x%04x length %d", __func__,
 1921|  9.13k|		    print_map(betoh16(cfg->cfg_type), ikev2_cfg_map),
 1922|  9.13k|		    betoh16(cfg->cfg_type),
 1923|  9.13k|		    betoh16(cfg->cfg_length));
 1924|       |
 1925|  9.13k|		ptr += sizeof(*cfg);
 1926|  9.13k|		len -= sizeof(*cfg);
 1927|       |
 1928|  9.13k|		if (len < betoh16(cfg->cfg_length)) {
  ------------------
  |  Branch (1928:7): [True: 1.15k, False: 7.97k]
  ------------------
 1929|  1.15k|			log_debug("%s: malformed payload: too short for "
 1930|  1.15k|			    "cfg_length (%zu < %u)", __func__, len,
 1931|  1.15k|			    betoh16(cfg->cfg_length));
 1932|  1.15k|			return (-1);
 1933|  1.15k|		}
 1934|       |
 1935|  7.97k|		print_hex(ptr, sizeof(*cfg), betoh16(cfg->cfg_length));
 1936|       |
 1937|  7.97k|		cfg_type = betoh16(cfg->cfg_type);
 1938|  7.97k|		switch (cfg_type) {
  ------------------
  |  Branch (1938:11): [True: 3.40k, False: 4.56k]
  ------------------
 1939|    848|		case IKEV2_CFG_INTERNAL_IP4_ADDRESS:
  ------------------
  |  |  528|    848|#define IKEV2_CFG_INTERNAL_IP4_ADDRESS		1	/* RFC7296 */
  ------------------
  |  Branch (1939:3): [True: 848, False: 7.12k]
  ------------------
 1940|  1.50k|		case IKEV2_CFG_INTERNAL_IP4_DNS:
  ------------------
  |  |  530|  1.50k|#define IKEV2_CFG_INTERNAL_IP4_DNS		3	/* RFC7296 */
  ------------------
  |  Branch (1940:3): [True: 660, False: 7.31k]
  ------------------
 1941|  1.50k|			if (!ikev2_msg_frompeer(msg))
  ------------------
  |  Branch (1941:8): [True: 735, False: 773]
  ------------------
 1942|    735|				break;
 1943|    773|			if (betoh16(cfg->cfg_length) == 0)
  ------------------
  |  Branch (1943:8): [True: 309, False: 464]
  ------------------
 1944|    309|				break;
 1945|       |			/* XXX multiple-valued */
 1946|    464|			if (betoh16(cfg->cfg_length) < 4) {
  ------------------
  |  Branch (1946:8): [True: 6, False: 458]
  ------------------
 1947|      6|				log_debug("%s: malformed payload: too short "
 1948|      6|				    "for ipv4 addr (%u < %u)",
 1949|      6|				    __func__, betoh16(cfg->cfg_length), 4);
 1950|      6|				return (-1);
 1951|      6|			}
 1952|    458|			switch(cfg_type) {
 1953|    359|			case IKEV2_CFG_INTERNAL_IP4_ADDRESS:
  ------------------
  |  |  528|    359|#define IKEV2_CFG_INTERNAL_IP4_ADDRESS		1	/* RFC7296 */
  ------------------
  |  Branch (1953:4): [True: 359, False: 99]
  ------------------
 1954|    359|				if (msg->msg_parent->msg_cp_addr != NULL) {
  ------------------
  |  Branch (1954:9): [True: 240, False: 119]
  ------------------
 1955|    240|					log_debug("%s: address already set", __func__);
 1956|    240|					goto skip;
 1957|    240|				}
 1958|    119|				break;
 1959|    119|			case IKEV2_CFG_INTERNAL_IP4_DNS:
  ------------------
  |  |  530|     99|#define IKEV2_CFG_INTERNAL_IP4_DNS		3	/* RFC7296 */
  ------------------
  |  Branch (1959:4): [True: 99, False: 359]
  ------------------
 1960|     99|				if (msg->msg_parent->msg_cp_dns != NULL) {
  ------------------
  |  Branch (1960:9): [True: 51, False: 48]
  ------------------
 1961|     51|					log_debug("%s: dns already set", __func__);
 1962|     51|					goto skip;
 1963|     51|				}
 1964|     48|				break;
 1965|     48|			default:
  ------------------
  |  Branch (1965:4): [True: 0, False: 458]
  ------------------
 1966|      0|				break;
 1967|    458|			}
 1968|    167|			if ((addr = calloc(1, sizeof(*addr))) == NULL) {
  ------------------
  |  Branch (1968:8): [True: 0, False: 167]
  ------------------
 1969|      0|				log_debug("%s: malloc failed", __func__);
 1970|      0|				break;
 1971|      0|			}
 1972|    167|			addr->addr_af = AF_INET;
 1973|    167|			in4 = (struct sockaddr_in *)&addr->addr;
 1974|    167|			in4->sin_family = AF_INET;
 1975|       |#ifdef HAVE_SOCKADDR_SA_LEN
 1976|       |			in4->sin_len = sizeof(*in4);
 1977|       |#endif
 1978|    167|			memcpy(&in4->sin_addr.s_addr, ptr, 4);
 1979|    167|			switch(cfg_type) {
 1980|    119|			case IKEV2_CFG_INTERNAL_IP4_ADDRESS:
  ------------------
  |  |  528|    119|#define IKEV2_CFG_INTERNAL_IP4_ADDRESS		1	/* RFC7296 */
  ------------------
  |  Branch (1980:4): [True: 119, False: 48]
  ------------------
 1981|    119|				msg->msg_parent->msg_cp_addr = addr;
 1982|    119|				log_debug("%s: IP4_ADDRESS %s", __func__,
 1983|    119|				    print_addr(&addr->addr));
 1984|    119|				break;
 1985|     48|			case IKEV2_CFG_INTERNAL_IP4_DNS:
  ------------------
  |  |  530|     48|#define IKEV2_CFG_INTERNAL_IP4_DNS		3	/* RFC7296 */
  ------------------
  |  Branch (1985:4): [True: 48, False: 119]
  ------------------
 1986|     48|				msg->msg_parent->msg_cp_dns = addr;
 1987|     48|				log_debug("%s: IP4_DNS %s", __func__,
 1988|     48|				    print_addr(&addr->addr));
 1989|     48|				break;
 1990|      0|			default:
  ------------------
  |  Branch (1990:4): [True: 0, False: 167]
  ------------------
 1991|      0|				log_debug("%s: cfg %s", __func__,
 1992|      0|				    print_addr(&addr->addr));
 1993|      0|				break;
 1994|    167|			}
 1995|    167|			break;
 1996|  2.25k|		case IKEV2_CFG_INTERNAL_IP6_ADDRESS:
  ------------------
  |  |  535|  2.25k|#define IKEV2_CFG_INTERNAL_IP6_ADDRESS		8	/* RFC7296 */
  ------------------
  |  Branch (1996:3): [True: 2.25k, False: 5.72k]
  ------------------
 1997|  3.06k|		case IKEV2_CFG_INTERNAL_IP6_DNS:
  ------------------
  |  |  536|  3.06k|#define IKEV2_CFG_INTERNAL_IP6_DNS		10	/* RFC7296 */
  ------------------
  |  Branch (1997:3): [True: 810, False: 7.16k]
  ------------------
 1998|  3.06k|			if (!ikev2_msg_frompeer(msg))
  ------------------
  |  Branch (1998:8): [True: 2.86k, False: 199]
  ------------------
 1999|  2.86k|				break;
 2000|    199|			if (betoh16(cfg->cfg_length) == 0)
  ------------------
  |  Branch (2000:8): [True: 67, False: 132]
  ------------------
 2001|     67|				break;
 2002|       |			/* XXX multiple-valued */
 2003|    132|			if (betoh16(cfg->cfg_length) < 16) {
  ------------------
  |  Branch (2003:8): [True: 5, False: 127]
  ------------------
 2004|      5|				log_debug("%s: malformed payload: too short "
 2005|      5|				    "for ipv6 addr w/prefixlen (%u < %u)",
 2006|      5|				    __func__, betoh16(cfg->cfg_length), 16);
 2007|      5|				return (-1);
 2008|      5|			}
 2009|    127|			switch(cfg_type) {
  ------------------
  |  Branch (2009:11): [True: 0, False: 127]
  ------------------
 2010|     87|			case IKEV2_CFG_INTERNAL_IP6_ADDRESS:
  ------------------
  |  |  535|     87|#define IKEV2_CFG_INTERNAL_IP6_ADDRESS		8	/* RFC7296 */
  ------------------
  |  Branch (2010:4): [True: 87, False: 40]
  ------------------
 2011|     87|				if (msg->msg_parent->msg_cp_addr6 != NULL) {
  ------------------
  |  Branch (2011:9): [True: 47, False: 40]
  ------------------
 2012|     47|					log_debug("%s: address6 already set", __func__);
 2013|     47|					goto skip;
 2014|     47|				}
 2015|     40|				break;
 2016|     40|			case IKEV2_CFG_INTERNAL_IP6_DNS:
  ------------------
  |  |  536|     40|#define IKEV2_CFG_INTERNAL_IP6_DNS		10	/* RFC7296 */
  ------------------
  |  Branch (2016:4): [True: 40, False: 87]
  ------------------
 2017|     40|				if (msg->msg_parent->msg_cp_dns != NULL) {
  ------------------
  |  Branch (2017:9): [True: 36, False: 4]
  ------------------
 2018|     36|					log_debug("%s: dns already set", __func__);
 2019|     36|					goto skip;
 2020|     36|				}
 2021|      4|				break;
 2022|    127|			}
 2023|     44|			if ((addr = calloc(1, sizeof(*addr))) == NULL) {
  ------------------
  |  Branch (2023:8): [True: 0, False: 44]
  ------------------
 2024|      0|				log_debug("%s: malloc failed", __func__);
 2025|      0|				break;
 2026|      0|			}
 2027|     44|			addr->addr_af = AF_INET6;
 2028|     44|			in6 = (struct sockaddr_in6 *)&addr->addr;
 2029|     44|			in6->sin6_family = AF_INET6;
 2030|       |#ifdef HAVE_SOCKADDR_SA_LEN
 2031|       |			in6->sin6_len = sizeof(*in6);
 2032|       |#endif
 2033|     44|			memcpy(&in6->sin6_addr, ptr, 16);
 2034|     44|			switch(cfg_type) {
 2035|     40|			case IKEV2_CFG_INTERNAL_IP6_ADDRESS:
  ------------------
  |  |  535|     40|#define IKEV2_CFG_INTERNAL_IP6_ADDRESS		8	/* RFC7296 */
  ------------------
  |  Branch (2035:4): [True: 40, False: 4]
  ------------------
 2036|     40|				msg->msg_parent->msg_cp_addr6 = addr;
 2037|     40|				log_debug("%s: IP6_ADDRESS %s", __func__,
 2038|     40|				    print_addr(&addr->addr));
 2039|     40|				break;
 2040|      4|			case IKEV2_CFG_INTERNAL_IP6_DNS:
  ------------------
  |  |  536|      4|#define IKEV2_CFG_INTERNAL_IP6_DNS		10	/* RFC7296 */
  ------------------
  |  Branch (2040:4): [True: 4, False: 40]
  ------------------
 2041|      4|				msg->msg_parent->msg_cp_dns = addr;
 2042|      4|				log_debug("%s: IP6_DNS %s", __func__,
 2043|      4|				    print_addr(&addr->addr));
 2044|      4|				break;
 2045|      0|			default:
  ------------------
  |  Branch (2045:4): [True: 0, False: 44]
  ------------------
 2046|      0|				log_debug("%s: cfg %s/%d", __func__,
 2047|      0|				    print_addr(&addr->addr), ptr[16]);
 2048|      0|				break;
 2049|     44|			}
 2050|     44|			break;
 2051|  7.97k|		}
 2052|       |
 2053|  7.96k| skip:
 2054|  7.96k|		ptr += betoh16(cfg->cfg_length);
 2055|  7.96k|		len -= betoh16(cfg->cfg_length);
 2056|  7.96k|	}
 2057|       |
 2058|  5.44k|	if (!ikev2_msg_frompeer(msg))
  ------------------
  |  Branch (2058:6): [True: 5.25k, False: 192]
  ------------------
 2059|  5.25k|		return (0);
 2060|       |
 2061|    192|	msg->msg_parent->msg_cp = cp.cp_type;
 2062|       |
 2063|    192|	return (0);
 2064|  5.44k|}
ikev2_validate_eap:
 2069|  18.6k|{
 2070|  18.6k|	uint8_t		*msgbuf = ibuf_data(msg->msg_data);
 2071|       |
 2072|  18.6k|	if (left < sizeof(*hdr)) {
  ------------------
  |  Branch (2072:6): [True: 7.89k, False: 10.7k]
  ------------------
 2073|  7.89k|		log_debug("%s: malformed payload: too short for header "
 2074|  7.89k|		    "(%zu < %zu)", __func__, left, sizeof(*hdr));
 2075|  7.89k|		return (-1);
 2076|  7.89k|	}
 2077|  10.7k|	memcpy(hdr, msgbuf + offset, sizeof(*hdr));
 2078|       |
 2079|  10.7k|	return (0);
 2080|  18.6k|}
ikev2_pld_eap:
 2085|  18.6k|{
 2086|  18.6k|	struct eap_header		 hdr;
 2087|  18.6k|	struct eap_message		*eap = NULL;
 2088|  18.6k|	const struct iked_sa		*sa = msg->msg_sa;
 2089|  18.6k|	size_t				 len;
 2090|       |
 2091|  18.6k|	if (ikev2_validate_eap(msg, offset, left, &hdr))
  ------------------
  |  Branch (2091:6): [True: 7.89k, False: 10.7k]
  ------------------
 2092|  7.89k|		return (-1);
 2093|  10.7k|	len = betoh16(hdr.eap_length);
 2094|       |
 2095|  10.7k|	if (len < sizeof(*eap)) {
  ------------------
  |  Branch (2095:6): [True: 3.62k, False: 7.13k]
  ------------------
 2096|  3.62k|		log_info("%s: %s id %d length %d", SPI_SA(sa, __func__),
  ------------------
  |  | 1105|  3.62k|#define SPI_SA(sa, f)    SPI_SH(&(sa)->sa_hdr, (f))
  |  |  ------------------
  |  |  |  | 1104|  3.62k|#define SPI_SH(sh, f)    ikev2_ikesa_info((sh)->sh_ispi, (f))
  |  |  ------------------
  ------------------
 2097|  3.62k|		    print_map(hdr.eap_code, eap_code_map),
 2098|  3.62k|		    hdr.eap_id, betoh16(hdr.eap_length));
 2099|  7.13k|	} else {
 2100|       |		/* Now try to get the indicated length */
 2101|  7.13k|		if ((eap = ibuf_seek(msg->msg_data, offset, len)) == NULL) {
  ------------------
  |  Branch (2101:7): [True: 3.75k, False: 3.37k]
  ------------------
 2102|  3.75k|			log_debug("%s: invalid EAP length", __func__);
 2103|  3.75k|			return (-1);
 2104|  3.75k|		}
 2105|       |
 2106|  3.37k|		log_info("%s: %s id %d length %d EAP-%s", SPI_SA(sa, __func__),
  ------------------
  |  | 1105|  3.37k|#define SPI_SA(sa, f)    SPI_SH(&(sa)->sa_hdr, (f))
  |  |  ------------------
  |  |  |  | 1104|  3.37k|#define SPI_SH(sh, f)    ikev2_ikesa_info((sh)->sh_ispi, (f))
  |  |  ------------------
  ------------------
 2107|  3.37k|		    print_map(eap->eap_code, eap_code_map),
 2108|  3.37k|		    eap->eap_id, betoh16(eap->eap_length),
 2109|  3.37k|		    print_map(eap->eap_type, eap_type_map));
 2110|       |
 2111|  3.37k|		if (eap_parse(env, sa, msg, eap, msg->msg_response) == -1)
  ------------------
  |  Branch (2111:7): [True: 0, False: 3.37k]
  ------------------
 2112|      0|			return (-1);
 2113|  3.37k|		msg->msg_parent->msg_eap.eam_found = 1;
 2114|  3.37k|	}
 2115|       |
 2116|  7.00k|	return (0);
 2117|  10.7k|}

ibuf_new:
   41|  22.8k|{
   42|  22.8k|	struct ibuf	*buf;
   43|       |
   44|  22.8k|	if ((buf = ibuf_dynamic(len,
  ------------------
  |  Branch (44:6): [True: 0, False: 22.8k]
  ------------------
   45|  22.8k|	    IKED_MSGBUF_MAX)) == NULL)
  ------------------
  |  |   66|  22.8k|#define IKED_MSGBUF_MAX		8192
  ------------------
   46|      0|		return (NULL);
   47|       |
   48|  22.8k|	if (len == 0)
  ------------------
  |  Branch (48:6): [True: 1.59k, False: 21.2k]
  ------------------
   49|  1.59k|		return (buf);
   50|       |
   51|  21.2k|	if (data == NULL) {
  ------------------
  |  Branch (51:6): [True: 0, False: 21.2k]
  ------------------
   52|      0|		if (ibuf_add_zero(buf, len) != 0) {
  ------------------
  |  Branch (52:7): [True: 0, False: 0]
  ------------------
   53|      0|			ibuf_free(buf);
   54|      0|			return (NULL);
   55|      0|		}
   56|  21.2k|	} else {
   57|  21.2k|		if (ibuf_add(buf, data, len) != 0) {
  ------------------
  |  Branch (57:7): [True: 0, False: 21.2k]
  ------------------
   58|      0|			ibuf_free(buf);
   59|      0|			return (NULL);
   60|      0|		}
   61|  21.2k|	}
   62|       |
   63|  21.2k|	return (buf);
   64|  21.2k|}

log_getverbose:
   82|   167k|{
   83|   167k|	return (verbose);
   84|   167k|}
vlog:
   98|  10.7k|{
   99|  10.7k|	char	*nfmt;
  100|  10.7k|	int	 saved_errno = errno;
  101|       |
  102|  10.7k|	if (debug) {
  ------------------
  |  Branch (102:6): [True: 0, False: 10.7k]
  ------------------
  103|       |		/* best effort in out of mem situations */
  104|      0|		if (asprintf(&nfmt, "%s\n", fmt) == -1) {
  ------------------
  |  Branch (104:7): [True: 0, False: 0]
  ------------------
  105|      0|			vfprintf(stderr, fmt, ap);
  106|      0|			fprintf(stderr, "\n");
  107|      0|		} else {
  108|      0|			vfprintf(stderr, nfmt, ap);
  109|      0|			free(nfmt);
  110|      0|		}
  111|      0|		fflush(stderr);
  112|      0|	} else
  113|  10.7k|		vsyslog(pri, fmt, ap);
  114|       |
  115|  10.7k|	errno = saved_errno;
  116|  10.7k|}
log_info:
  158|  10.7k|{
  159|  10.7k|	va_list	 ap;
  160|       |
  161|  10.7k|	va_start(ap, emsg);
  162|  10.7k|	vlog(LOG_INFO, emsg, ap);
  163|  10.7k|	va_end(ap);
  164|  10.7k|}
log_debug:
  168|   607k|{
  169|   607k|	va_list	 ap;
  170|       |
  171|   607k|	if (verbose > 1) {
  ------------------
  |  Branch (171:6): [True: 0, False: 607k]
  ------------------
  172|      0|		va_start(ap, emsg);
  173|      0|		vlog(LOG_DEBUG, emsg, ap);
  174|      0|		va_end(ap);
  175|      0|	}
  176|   607k|}

socket_getport:
   71|  14.6k|{
   72|  14.6k|	switch (sa->sa_family) {
   73|  12.3k|	case AF_INET:
  ------------------
  |  Branch (73:2): [True: 12.3k, False: 2.29k]
  ------------------
   74|  12.3k|		return (ntohs(((struct sockaddr_in *)sa)->sin_port));
   75|  2.29k|	case AF_INET6:
  ------------------
  |  Branch (75:2): [True: 2.29k, False: 12.3k]
  ------------------
   76|  2.29k|		return (ntohs(((struct sockaddr_in6 *)sa)->sin6_port));
   77|      0|	default:
  ------------------
  |  Branch (77:2): [True: 0, False: 14.6k]
  ------------------
   78|      0|		return (0);
   79|  14.6k|	}
   80|       |
   81|       |	/* NOTREACHED */
   82|      0|	return (0);
   83|  14.6k|}
print_spi:
  499|  39.6k|{
  500|  39.6k|	static char		 buf[IKED_CYCLE_BUFFERS][32];
  501|  39.6k|	static int		 i = 0;
  502|  39.6k|	char			*ptr;
  503|       |
  504|  39.6k|	ptr = buf[i];
  505|       |
  506|  39.6k|	switch (size) {
  507|      0|	case 2:
  ------------------
  |  Branch (507:2): [True: 0, False: 39.6k]
  ------------------
  508|      0|		snprintf(ptr, 32, "0x%04x", (uint16_t)spi);
  509|      0|		break;
  510|    415|	case 4:
  ------------------
  |  Branch (510:2): [True: 415, False: 39.2k]
  ------------------
  511|    415|		snprintf(ptr, 32, "0x%08x", (uint32_t)spi);
  512|    415|		break;
  513|  29.6k|	case 8:
  ------------------
  |  Branch (513:2): [True: 29.6k, False: 9.96k]
  ------------------
  514|  29.6k|		snprintf(ptr, 32, "0x%016llx", (long long unsigned)spi);
  515|  29.6k|		break;
  516|  9.54k|	default:
  ------------------
  |  Branch (516:2): [True: 9.54k, False: 30.1k]
  ------------------
  517|  9.54k|		snprintf(ptr, 32, "%llu", (long long unsigned)spi);
  518|  9.54k|		break;
  519|  39.6k|	}
  520|       |
  521|  39.6k|	if (++i >= IKED_CYCLE_BUFFERS)
  ------------------
  |  |   70|  39.6k|#define IKED_CYCLE_BUFFERS	8	/* # of static buffers for mapping */
  ------------------
  |  Branch (521:6): [True: 4.95k, False: 34.6k]
  ------------------
  522|  4.95k|		i = 0;
  523|       |
  524|  39.6k|	return (ptr);
  525|  39.6k|}
print_map:
  529|   753k|{
  530|   753k|	unsigned int		 i;
  531|   753k|	static char		 buf[IKED_CYCLE_BUFFERS][32];
  532|   753k|	static int		 idx = 0;
  533|   753k|	const char		*name = NULL;
  534|       |
  535|   753k|	if (idx >= IKED_CYCLE_BUFFERS)
  ------------------
  |  |   70|   753k|#define IKED_CYCLE_BUFFERS	8	/* # of static buffers for mapping */
  ------------------
  |  Branch (535:6): [True: 94.2k, False: 659k]
  ------------------
  536|  94.2k|		idx = 0;
  537|   753k|	bzero(buf[idx], sizeof(buf[idx]));
  538|       |
  539|  15.7M|	for (i = 0; map[i].cm_name != NULL; i++) {
  ------------------
  |  Branch (539:14): [True: 14.9M, False: 753k]
  ------------------
  540|  14.9M|		if (map[i].cm_type == type)
  ------------------
  |  Branch (540:7): [True: 509k, False: 14.4M]
  ------------------
  541|   509k|			name = map[i].cm_name;
  542|  14.9M|	}
  543|       |
  544|   753k|	if (name == NULL)
  ------------------
  |  Branch (544:6): [True: 244k, False: 509k]
  ------------------
  545|   244k|		snprintf(buf[idx], sizeof(buf[idx]), "<UNKNOWN:%u>", type);
  546|   509k|	else
  547|   509k|		strlcpy(buf[idx], name, sizeof(buf[idx]));
  548|       |
  549|   753k|	return (buf[idx++]);
  550|   753k|}
print_hex:
  561|   167k|{
  562|   167k|	unsigned int	 i;
  563|       |
  564|   167k|	if (log_getverbose() < 3 || !length)
  ------------------
  |  Branch (564:6): [True: 167k, False: 0]
  |  Branch (564:30): [True: 0, False: 0]
  ------------------
  565|   167k|		return;
  566|       |
  567|      0|	for (i = 0; i < length; i++) {
  ------------------
  |  Branch (567:14): [True: 0, False: 0]
  ------------------
  568|      0|		if (i && (i % 4) == 0) {
  ------------------
  |  Branch (568:7): [True: 0, False: 0]
  |  Branch (568:12): [True: 0, False: 0]
  ------------------
  569|      0|			if ((i % 32) == 0)
  ------------------
  |  Branch (569:8): [True: 0, False: 0]
  ------------------
  570|      0|				print_debug("\n");
  571|      0|			else
  572|      0|				print_debug(" ");
  573|      0|		}
  574|      0|		print_debug("%02x", buf[offset + i]);
  575|      0|	}
  576|      0|	print_debug("\n");
  577|      0|}
print_addr:
  737|  14.6k|{
  738|  14.6k|	static char	 sbuf[IKED_CYCLE_BUFFERS][NI_MAXHOST + 7];
  739|  14.6k|	static int	 idx;
  740|  14.6k|	struct sockaddr	*sa = addr;
  741|  14.6k|	char		*buf;
  742|  14.6k|	size_t		 len;
  743|  14.6k|	char		 pbuf[7];
  744|  14.6k|	in_port_t	 port;
  745|       |
  746|  14.6k|	buf = sbuf[idx];
  747|  14.6k|	len = sizeof(sbuf[idx]);
  748|  14.6k|	if (++idx >= IKED_CYCLE_BUFFERS)
  ------------------
  |  |   70|  14.6k|#define IKED_CYCLE_BUFFERS	8	/* # of static buffers for mapping */
  ------------------
  |  Branch (748:6): [True: 1.83k, False: 12.8k]
  ------------------
  749|  1.83k|		idx = 0;
  750|       |
  751|  14.6k|	if (sa->sa_family == AF_UNSPEC) {
  ------------------
  |  Branch (751:6): [True: 0, False: 14.6k]
  ------------------
  752|      0|		strlcpy(buf, "any", len);
  753|      0|		return (buf);
  754|      0|	}
  755|       |
  756|  14.6k|	if (getnameinfo(sa, SA_LEN(sa),
  ------------------
  |  |  113|  14.6k|	((sa->sa_family == AF_INET)  ? sizeof(struct sockaddr_in) :	\
  |  |  ------------------
  |  |  |  Branch (113:3): [True: 12.3k, False: 2.29k]
  |  |  ------------------
  |  |  114|  14.6k|	(sa->sa_family == AF_INET6) ? sizeof(struct sockaddr_in6) :	\
  |  |  ------------------
  |  |  |  Branch (114:2): [True: 2.29k, False: 0]
  |  |  ------------------
  |  |  115|  2.29k|	sizeof(struct sockaddr))
  ------------------
  |  Branch (756:6): [True: 0, False: 14.6k]
  ------------------
  757|  14.6k|	    buf, len, NULL, 0, NI_NUMERICHOST) != 0) {
  758|      0|		strlcpy(buf, "unknown", len);
  759|      0|		return (buf);
  760|      0|	}
  761|       |
  762|  14.6k|	if ((port = socket_getport(sa)) != 0) {
  ------------------
  |  Branch (762:6): [True: 0, False: 14.6k]
  ------------------
  763|      0|		snprintf(pbuf, sizeof(pbuf), ":%d", port);
  764|      0|		(void)strlcat(buf, pbuf, len);
  765|      0|	}
  766|       |
  767|  14.6k|	return (buf);
  768|  14.6k|}

eap_parse:
   61|  3.37k|{
   62|  3.37k|	return (0);
   63|  3.37k|}
ikev2_msg_frompeer:
   68|   215k|{
   69|   215k|	struct iked_sa		*sa = msg->msg_sa;
   70|   215k|	struct ike_header	*hdr;
   71|       |
   72|   215k|	msg = msg->msg_parent;
   73|       |
   74|   215k|	if (sa == NULL ||
  ------------------
  |  Branch (74:6): [True: 0, False: 215k]
  ------------------
   75|   215k|	    (hdr = ibuf_seek(msg->msg_data, 0, sizeof(*hdr))) == NULL)
  ------------------
  |  Branch (75:6): [True: 0, False: 215k]
  ------------------
   76|      0|		return (0);
   77|       |
   78|   215k|	if (!sa->sa_hdr.sh_initiator &&
  ------------------
  |  Branch (78:6): [True: 215k, False: 0]
  ------------------
   79|   215k|	    (hdr->ike_flags & IKEV2_FLAG_INITIATOR))
  ------------------
  |  |   20|   215k|#define IKEV2_FLAG_INITIATOR            0x08    /* Sent by the initiator */
  ------------------
  |  Branch (79:6): [True: 63.9k, False: 151k]
  ------------------
   80|  63.9k|		return (1);
   81|   151k|	else if (sa->sa_hdr.sh_initiator &&
  ------------------
  |  Branch (81:11): [True: 0, False: 151k]
  ------------------
   82|   151k|	    (hdr->ike_flags & IKEV2_FLAG_INITIATOR) == 0)
  ------------------
  |  |   20|      0|#define IKEV2_FLAG_INITIATOR            0x08    /* Sent by the initiator */
  ------------------
  |  Branch (82:6): [True: 0, False: 0]
  ------------------
   83|      0|		return (1);
   84|       |
   85|   151k|	return (0);
   86|   215k|}
ikev2_ikesa_info:
  102|  8.57k|{
  103|  8.57k|	return "";
  104|  8.57k|}
sa_stateok:
  121|    149|{
  122|    149|	return (0);
  123|    149|}
ikev2_nat_detection:
  165|  25.9k|{
  166|  25.9k|	bzero(ptr, len);
  167|  25.9k|	return (0);
  168|  25.9k|}
ikev2_print_id:
  180|  5.99k|{
  181|  5.99k|	return (0);
  182|  5.99k|}
config_add_proposal:
  193|     69|{
  194|     69|	return (NULL);
  195|     69|}
ikev2_send_informational:
  210|    746|{
  211|    746|	return (0);
  212|    746|}
ikev2_msg_cleanup:
  252|  14.7k|{
  253|  14.7k|	struct iked_certreq *cr;
  254|  14.7k|	struct iked_proposal *prop, *proptmp;
  255|  14.7k|	int			 i;
  256|       |
  257|  14.7k|	if (msg == msg->msg_parent) {
  ------------------
  |  Branch (257:6): [True: 14.7k, False: 0]
  ------------------
  258|  14.7k|		ibuf_free(msg->msg_nonce);
  259|  14.7k|		ibuf_free(msg->msg_ke);
  260|  14.7k|		ibuf_free(msg->msg_auth.id_buf);
  261|  14.7k|		ibuf_free(msg->msg_peerid.id_buf);
  262|  14.7k|		ibuf_free(msg->msg_localid.id_buf);
  263|  14.7k|		ibuf_free(msg->msg_cert.id_buf);
  264|  58.9k|		for (i = 0; i < IKED_SCERT_MAX; i++)
  ------------------
  |  |  477|  58.9k|#define IKED_SCERT_MAX	3 /* max # of supplemental cert payloads */
  ------------------
  |  Branch (264:15): [True: 44.2k, False: 14.7k]
  ------------------
  265|  44.2k|			ibuf_free(msg->msg_scert[i].id_buf);
  266|  14.7k|		ibuf_free(msg->msg_cookie);
  267|  14.7k|		ibuf_free(msg->msg_cookie2);
  268|  14.7k|		ibuf_free(msg->msg_del_buf);
  269|  14.7k|		free(msg->msg_eap.eam_user);
  270|  14.7k|		free(msg->msg_cp_addr);
  271|  14.7k|		free(msg->msg_cp_addr6);
  272|  14.7k|		free(msg->msg_cp_dns);
  273|       |
  274|  14.7k|		TAILQ_FOREACH_SAFE(prop, &msg->msg_proposals, prop_entry,
  ------------------
  |  |  445|  14.7k|	for ((var) = TAILQ_FIRST(head);					\
  |  |  ------------------
  |  |  |  |  428|  14.7k|#define	TAILQ_FIRST(head)		((head)->tqh_first)
  |  |  ------------------
  |  |  446|  14.7k|	    (var) != TAILQ_END(head) &&					\
  |  |  ------------------
  |  |  |  |  429|  29.4k|#define	TAILQ_END(head)			NULL
  |  |  ------------------
  |  |  |  Branch (446:6): [True: 0, False: 14.7k]
  |  |  ------------------
  |  |  447|  14.7k|	    ((tvar) = TAILQ_NEXT(var, field), 1);			\
  |  |  ------------------
  |  |  |  |  430|      0|#define	TAILQ_NEXT(elm, field)		((elm)->field.tqe_next)
  |  |  ------------------
  |  |  |  Branch (447:6): [True: 0, False: 0]
  |  |  ------------------
  |  |  448|  14.7k|	    (var) = (tvar))
  ------------------
  275|  14.7k|		    proptmp) {
  276|      0|			TAILQ_REMOVE(&msg->msg_proposals, prop, prop_entry);
  ------------------
  |  |  504|      0|#define TAILQ_REMOVE(head, elm, field) do {				\
  |  |  505|      0|	if (((elm)->field.tqe_next) != NULL)				\
  |  |  ------------------
  |  |  |  Branch (505:6): [True: 0, False: 0]
  |  |  ------------------
  |  |  506|      0|		(elm)->field.tqe_next->field.tqe_prev =			\
  |  |  507|      0|		    (elm)->field.tqe_prev;				\
  |  |  508|      0|	else								\
  |  |  509|      0|		(head)->tqh_last = (elm)->field.tqe_prev;		\
  |  |  510|      0|	*(elm)->field.tqe_prev = (elm)->field.tqe_next;			\
  |  |  511|      0|	_Q_INVALIDATE((elm)->field.tqe_prev);				\
  |  |  512|      0|	_Q_INVALIDATE((elm)->field.tqe_next);				\
  |  |  513|      0|} while (0)
  |  |  ------------------
  |  |  |  Branch (513:10): [Folded - Ignored]
  |  |  ------------------
  ------------------
  277|      0|			if (prop->prop_nxforms)
  ------------------
  |  Branch (277:8): [True: 0, False: 0]
  ------------------
  278|      0|				free(prop->prop_xforms);
  279|      0|			free(prop);
  280|      0|		}
  281|       |
  282|  14.7k|		msg->msg_nonce = NULL;
  283|  14.7k|		msg->msg_ke = NULL;
  284|  14.7k|		msg->msg_auth.id_buf = NULL;
  285|  14.7k|		msg->msg_peerid.id_buf = NULL;
  286|  14.7k|		msg->msg_localid.id_buf = NULL;
  287|  14.7k|		msg->msg_cert.id_buf = NULL;
  288|  58.9k|		for (i = 0; i < IKED_SCERT_MAX; i++)
  ------------------
  |  |  477|  58.9k|#define IKED_SCERT_MAX	3 /* max # of supplemental cert payloads */
  ------------------
  |  Branch (288:15): [True: 44.2k, False: 14.7k]
  ------------------
  289|  44.2k|			msg->msg_scert[i].id_buf = NULL;
  290|  14.7k|		msg->msg_cookie = NULL;
  291|  14.7k|		msg->msg_cookie2 = NULL;
  292|  14.7k|		msg->msg_del_buf = NULL;
  293|  14.7k|		msg->msg_eap.eam_user = NULL;
  294|  14.7k|		msg->msg_cp_addr = NULL;
  295|  14.7k|		msg->msg_cp_addr6 = NULL;
  296|  14.7k|		msg->msg_cp_dns = NULL;
  297|       |
  298|  15.7k|		while ((cr = SIMPLEQ_FIRST(&msg->msg_certreqs))) {
  ------------------
  |  |  267|  15.7k|#define	SIMPLEQ_FIRST(head)	    ((head)->sqh_first)
  ------------------
  |  Branch (298:10): [True: 1.04k, False: 14.7k]
  ------------------
  299|  1.04k|			ibuf_free(cr->cr_data);
  300|  1.04k|			SIMPLEQ_REMOVE_HEAD(&msg->msg_certreqs, cr_entry);
  ------------------
  |  |  308|  1.04k|#define SIMPLEQ_REMOVE_HEAD(head, field) do {			\
  |  |  309|  1.04k|	if (((head)->sqh_first = (head)->sqh_first->field.sqe_next) == NULL) \
  |  |  ------------------
  |  |  |  Branch (309:6): [True: 109, False: 937]
  |  |  ------------------
  |  |  310|  1.04k|		(head)->sqh_last = &(head)->sqh_first;			\
  |  |  311|  1.04k|} while (0)
  |  |  ------------------
  |  |  |  Branch (311:10): [Folded - Ignored]
  |  |  ------------------
  ------------------
  301|  1.04k|			free(cr);
  302|  1.04k|		}
  303|  14.7k|	}
  304|       |
  305|  14.7k|	if (msg->msg_data != NULL) {
  ------------------
  |  Branch (305:6): [True: 14.7k, False: 0]
  ------------------
  306|  14.7k|		ibuf_free(msg->msg_data);
  307|  14.7k|		msg->msg_data = NULL;
  308|  14.7k|	}
  309|  14.7k|}

LLVMFuzzerTestOneInput:
  107|  14.7k|{
  108|  14.7k|	struct ibuf		*fuzzed;
  109|  14.7k|	struct ike_header	 hdr;
  110|  14.7k|	struct iked_message	 msg;
  111|       |
  112|  14.7k|	bzero(&hdr, sizeof(hdr));
  113|  14.7k|	bzero(&msg, sizeof(msg));
  114|       |
  115|  14.7k|	fuzzed = ibuf_new(data, size);
  116|  14.7k|	if (fuzzed == NULL){
  ------------------
  |  Branch (116:6): [True: 0, False: 14.7k]
  ------------------
  117|      0|		fprintf(stderr, "%s\n", "ERROR: fuzzed == NULL! "
  118|      0|		    "(hint: fuzz-input too long?)");
  119|      0|		return -1;
  120|      0|	}	
  121|       |	
  122|       |	/* size too small? */
  123|  14.7k|	if (size < sizeof(cookies) + sizeof(genhdr)){
  ------------------
  |  Branch (123:6): [True: 1, False: 14.7k]
  ------------------
  124|      1|		ibuf_free(fuzzed);
  125|      1|		return 0;
  126|      1|	}	       
  127|       |
  128|  14.7k|	prepare_header(&hdr, fuzzed);
  129|  14.7k|	prepare_message(&msg, fuzzed);
  130|       |
  131|  14.7k|	ikev2_pld_parse(NULL, &hdr, &msg, 0);
  132|       |
  133|  14.7k|	ikev2_msg_cleanup(NULL, &msg);
  134|       |
  135|  14.7k|	return 0;
  136|  14.7k|}
test_parser_fuzz.c:prepare_header:
   75|  14.7k|{
   76|  14.7k|	bzero(hdr, sizeof(*hdr));
   77|  14.7k|	bcopy(get_icookie(ibuf_data(data)), &hdr->ike_ispi,
   78|  14.7k|	    sizeof(hdr->ike_ispi));
   79|  14.7k|	bcopy(get_rcookie(ibuf_data(data)), &hdr->ike_rspi,
   80|  14.7k|	    sizeof(hdr->ike_rspi));
   81|  14.7k|	hdr->ike_nextpayload = get_nextpayload(ibuf_data(data));
   82|  14.7k|	hdr->ike_version = get_version(ibuf_data(data));
   83|  14.7k|	hdr->ike_exchange = get_exchange(ibuf_data(data));
   84|  14.7k|	hdr->ike_length = get_length(ibuf_data(data));
   85|  14.7k|}
test_parser_fuzz.c:get_icookie:
   39|  14.7k|{
   40|  14.7k|	return &data[OFFSET_ICOOKIE];
  ------------------
  |  |   30|  14.7k|#define OFFSET_ICOOKIE		0
  ------------------
   41|  14.7k|}
test_parser_fuzz.c:get_rcookie:
   45|  14.7k|{
   46|  14.7k|	return &data[OFFSET_RCOOKIE];
  ------------------
  |  |   31|  14.7k|#define OFFSET_RCOOKIE		8
  ------------------
   47|  14.7k|}
test_parser_fuzz.c:get_nextpayload:
   51|  14.7k|{
   52|  14.7k|	return data[OFFSET_NEXTPAYLOAD];
  ------------------
  |  |   32|  14.7k|#define OFFSET_NEXTPAYLOAD	(0 + sizeof(cookies))
  ------------------
   53|  14.7k|}
test_parser_fuzz.c:get_version:
   57|  14.7k|{
   58|  14.7k|	return data[OFFSET_VERSION];
  ------------------
  |  |   33|  14.7k|#define OFFSET_VERSION		(1 + sizeof(cookies))
  ------------------
   59|  14.7k|}
test_parser_fuzz.c:get_exchange:
   63|  14.7k|{
   64|  14.7k|	return data[OFFSET_EXCHANGE];
  ------------------
  |  |   34|  14.7k|#define OFFSET_EXCHANGE		(2 + sizeof(cookies))
  ------------------
   65|  14.7k|}
test_parser_fuzz.c:get_length:
   69|  14.7k|{
   70|  14.7k|	return *(u_int32_t *)&data[OFFSET_LENGTH];
  ------------------
  |  |   35|  14.7k|#define OFFSET_LENGTH		(8 + sizeof(cookies))
  ------------------
   71|  14.7k|}
test_parser_fuzz.c:prepare_message:
   89|  14.7k|{
   90|  14.7k|	static struct iked_sa	sa;
   91|       |
   92|  14.7k|	bzero(&sa, sizeof(sa));
   93|  14.7k|	bzero(msg, sizeof(*msg));
   94|       |
   95|  14.7k|	msg->msg_sa = &sa;
   96|  14.7k|	msg->msg_data = data;
   97|  14.7k|	msg->msg_e = 1;
   98|  14.7k|	msg->msg_parent = msg;
   99|       |
  100|  14.7k|	TAILQ_INIT(&msg->msg_proposals);
  ------------------
  |  |  465|  14.7k|#define	TAILQ_INIT(head) do {						\
  |  |  466|  14.7k|	(head)->tqh_first = NULL;					\
  |  |  467|  14.7k|	(head)->tqh_last = &(head)->tqh_first;				\
  |  |  468|  14.7k|} while (0)
  |  |  ------------------
  |  |  |  Branch (468:10): [Folded - Ignored]
  |  |  ------------------
  ------------------
  101|  14.7k|	SIMPLEQ_INIT(&msg->msg_certreqs);
  ------------------
  |  |  285|  14.7k|#define	SIMPLEQ_INIT(head) do {						\
  |  |  286|  14.7k|	(head)->sqh_first = NULL;					\
  |  |  287|  14.7k|	(head)->sqh_last = &(head)->sqh_first;				\
  |  |  288|  14.7k|} while (0)
  |  |  ------------------
  |  |  |  Branch (288:10): [Folded - Ignored]
  |  |  ------------------
  ------------------
  102|  14.7k|}

